---
title: 02-80x86æ±‡ç¼–è¯­è¨€ä¸Cè¯­è¨€--æ§åˆ¶æµ
date: 2021-04-14 10:49:50
permalink: /pages/1bdb27/
categories: 
  - ç¼–ç¨‹è¯­è¨€
  - æ±‡ç¼–è¯­è¨€
  - 01-æ¸…åå…¬å¼€è¯¾
  - 3-Cä¸æ±‡ç¼–è¯­è¨€
tags: 
  - null
author: 
  name: æœ¨å­è¯†æ—¶åŠ¡
  link: https://github.com/sbwcwso
editLink: true
---
# 80x86 æ±‡ç¼–ä¸ C è¯­è¨€ -- æ§åˆ¶æµ

* [ğŸ”— è¯¾ä»¶](./assets/80x86æ±‡ç¼–ä¸Cè¯­è¨€2.pdf)

---

## æ±‡ç¼–ç¨‹åºå‘˜çœ¼ä¸­çš„ç³»ç»Ÿç»“æ„(éƒ¨åˆ†)

<!--sec data-title="ç¤ºæ„å›¾" data-id="section20210414105330" data-show=true data-collapse=true ces-->
![20210414105348-2021-04-14-10-53-48](https://cdn.jsdelivr.net/gh/Lijunjie9502/PicBed@master/20210414105348-2021-04-14-10-53-48.png)

* åæ˜ äº†å½“å‰æ‰§è¡Œç¨‹åºçš„ä¿¡æ¯
  * æ•°æ®
  * æŒ‡ä»¤åœ°å€
  * è¿è¡Œæ ˆåœ°å€
  * æ¡ä»¶ç 
<!--endsec-->

## æ¡ä»¶ç 

* æ¡ä»¶ç ç”±**ç®—æœ¯æŒ‡ä»¤éšå«è®¾ç½®**
  * å¦‚ï¼š`addl Src,Dest`ï¼Œ `addq Src,Dest`
  * ç±»ä¼¼çš„Cè¯­è¨€è¡¨è¾¾å¼: `t=a+b` (`a=Src, b = Dest`)

* å››ä¸ªæ¡ä»¶ç 
  * CFè¿›ä½æ ‡å¿— (Carry)
    * å¯ç”¨äºæ£€æµ‹æ— ç¬¦å·æ•´æ•°è¿ç®—çš„æº¢å‡º
  * SF ç¬¦å·ä½ (Sign)
    * å¦‚æœ `t < 0`ï¼Œ é‚£ä¹ˆ `SF=1`; å¦åˆ™ `SF=0`
  * ZF Zero Flag
    * å¦‚æœ `t == 0`ï¼Œé‚£ä¹ˆ `ZF=1`; å¦åˆ™ `ZF=0`
  * OF æº¢å‡ºæ ‡å¿— (Overflow)
    * å¦‚æœè¡¥ç è¿ç®—æº¢å‡ºï¼Œé‚£ä¹ˆ `OF=1` (å³å¸¦ç¬¦å·æ•´æ•°è¿ç®— )
    * è¡¥ç æº¢å‡ºçš„åˆ¤æ–­æ¡ä»¶
    * `(a>0 && b>0 && t<0) || (a<0 && b<0 && t>=0)`

## æ¯”è¾ƒæŒ‡ä»¤

`cmp1 Src2 Src1`  &nbsp;&nbsp;&nbsp;&nbsp;  `cmpq Src2, Src1`

* `cmpl b,a` ç±»ä¼¼äºè®¡ç®— `a-b` (ä½†æ˜¯ä¸æ”¹å˜ç›®çš„æ“ä½œæ•°)
* å¦‚æœå‘æœ€é«˜ä½æœ‰å€Ÿä½ï¼Œé‚£ä¹ˆ `CF=1`; å¦åˆ™ `CF=0`
  * å¯ç”¨äºæ— ç¬¦å·æ•°çš„æ¯”è¾ƒ
* å¦‚æœ `a == b`ï¼Œé‚£ä¹ˆ `ZF=1`; å¦åˆ™ `ZF=0`
* å¦‚æœ `(a - b) < 0`(æŒ‡ç»“æœçš„æœ€é«˜ä½ä¸º `1`)ï¼Œé‚£ä¹ˆ `SF=1`; å¦åˆ™ `SF=0`
  * å³è¿ç®—åè‹¥ç»“æœæœ€é«˜ä½ä¸º `1`ï¼Œé‚£ä¹ˆ `SF=1`; å¦åˆ™ä¸º `0`
* å¦‚æœè¡¥ç è¿ç®—æº¢å‡ºï¼Œé‚£ä¹ˆ `OF=1`
  * `(a>0 && b<0 && (a-b)<0) || (a<0 && b>0 && (a-b)>0)`

## æµ‹è¯• (Test) æŒ‡ä»¤

`testl Src2 Src1`  &nbsp;&nbsp;&nbsp;&nbsp;  `testq Src2, Src1`

* è®¡ç®— `Src1 & Src2` å¹¶è®¾ç½®ç›¸åº”çš„æ¡ä»¶ç ï¼Œä½†æ˜¯ä¸æ”¹å˜ç›®çš„æ“ä½œæ•°
  * å¦‚æœ `a&b == 0`ï¼Œé‚£ä¹ˆ `ZF=1`; å¦åˆ™ä¸º `0`
  * å¦‚æœ `a&b < 0` ï¼Œé‚£ä¹ˆ `SF=1`; å¦åˆ™ä¸º `0`
  * å³è¿ç®—åç»“æœæœ€é«˜ä½ä¸º `1`ï¼Œé‚£ä¹ˆ`SF=1`; å¦åˆ™ä¸º`0`
* `test` æŒ‡ä»¤ä¼šå°† `CF`, `OF` æ ‡å¿—ä½æ¸…é›¶

## è¯»å–æ¡ä»¶ç 

<!--sec data-title="SetX æŒ‡ä»¤çš„å…·ä½“å†…å®¹" data-id="section20210414121321" data-show=true data-collapse=true ces-->

| SetX    | Condition        | Description              |
|:-------:|:----------------:|:------------------------:|
| `sete`  | `ZF`             | Equal / Zero             |
| `setne` | `~ZF`            | Not Equal / Not Zero     |
| `sets`  | `SF`             | Negative                 |
| `setns` | `~SF`            | Nonnegative              |
| `setg`  | `~(SF^OF) & ~ZF` | Greater(Signed)          |
| `setge` | `~(SF^OF)`      | Greater or Equal(Signed) |
| `setl`  | `(SF^OF)`       | Less (Signed)            |
| `setle` | `(SF^OF) $|$ZF`    | Less or Equal(Signed)    |
| `seta`  | `~CF&~ZF`        | Above (unsigned)         |
| `setb`  | `CF`             | Below (unsigned)         |

<!--endsec-->


* SetX æŒ‡ä»¤çš„æ“ä½œ
  * è¯»å–å½“å‰çš„æ¡ä»¶ç ï¼ˆæˆ–è€…æŸäº›æ¡ä»¶ç çš„ç»„åˆ)ï¼Œå¹¶å­˜å…¥ç›®çš„**å­—èŠ‚**å¯„å­˜å™¨
    * ä½™ä¸‹çš„ä¸‰ä¸ªå­—èŠ‚ä¸ä¼šä¿®æ”¹
      * ![20210414121449-2021-04-14-12-14-49](https://cdn.jsdelivr.net/gh/Lijunjie9502/PicBed@master/20210414121449-2021-04-14-12-14-49.png)
    * é€šå¸¸ä¼šä½¿ç”¨ `movzbl` æŒ‡ä»¤å¯¹ç›®çš„å¯„å­˜å™¨è¿›è¡Œ `0` æ‰©å±•

  <!--sec data-title="ç¤ºä¾‹" data-id="section20210414122514" data-show=true data-collapse=true ces-->
  * C ä»£ç 

    ```c
    int gt(int x, int y)
    {
      return x > y;
    }
    
    ```

  * æ±‡ç¼–ç 

    ```nasm
    movl  12(%ebp), %eax  # eax = y
    cmpl  %eax, 8(%ebp)   # Compare x, y
    setg  %al             # al = x > y
    movzbl  %al, %eax     # Zero rest of %eax, ç¨‹åºä¼šè¿”åŠ  %eax ä¸­çš„å€¼
    ```
  <!--endsec-->

#### x86-64 ä¸‹çš„è¯»å–æ¡ä»¶ç 

* SetX æŒ‡ä»¤çš„æ“ä½œ
  * è¯»å–å½“å‰çš„æ¡ä»¶ç ï¼ˆæˆ–è€…æŸäº›æ¡ä»¶ç çš„ç»„åˆ)ï¼Œå¹¶å­˜å…¥ç›®çš„**å­—èŠ‚**å¯„å­˜å™¨
  * å¯„å­˜å™¨ä¸­çš„ä½™ä¸‹ 7 ä¸ªå­—èŠ‚ä¸ä¼šè¢«æ›´æ”¹

<!--sec data-title="ç¤ºä¾‹" data-id="section20210414123234" data-show=true data-collapse=true ces-->

* C ä»£ç 

  ```c
  long lgt(long x, long y)
  {
    return x > y;
  }
  ```

* æ±‡ç¼–ç 

  ```nasm
  xorl  %eax, %eax  # eax=0
  cmpq  %rsi, %rdi  # Compare x:y
  setg  %al         # al = x > y
  ```

  * å¯ä»¥çœ‹å‡ºæ±‡ç¼–ç ä¸­åªå¯¹ `%eax` è¿›è¡Œäº†å¤„ç†ï¼Œ å³ `%rax` çš„é«˜ 32 ä½
    * ![20210414124855-2021-04-14-12-48-55](https://cdn.jsdelivr.net/gh/Lijunjie9502/PicBed@master/20210414124855-2021-04-14-12-48-55.png)
    * è¿™æ˜¯å› ä¸ºæŠ€æœ¯æ‰‹å†Œä¸­è§„å®šå¦‚æœ 32 ä½çš„è¿ç®—äº§ç”Ÿäº†32ä½çš„ç»“æœï¼Œåˆ™è‡ªåŠ¨çš„åœ¨ç›®æ ‡é€šç”¨å¯„å­˜å™¨çš„é«˜ 32 ä½è¿›è¡Œé›¶æ‰©å±•
      <!-- TODO:æ•°æ®é¡¹ä¾èµ–çš„å…·ä½“å«ä¹‰ï¼Œä¸ºä½•è¿™æ ·åšå¯åˆæ¶ˆé™¤æ•°æ®é¡¹ä¾èµ–-->
      * éƒ¨åˆ†åŸå› æ¥è‡ªäºå¾®ä½“ç³»ç»“æ„å†…éƒ¨å®ç°çš„æ•ˆç‡æ–¹é¢çš„è€ƒè™‘ï¼Œç›®çš„æ˜¯ä¸ºäº†æ¶ˆé™¤â€œéƒ¨åˆ†æ•°æ®ä¾èµ–â€
<!--endsec-->

## è·³è½¬æŒ‡ä»¤

<!--sec data-title="æŒ‡ä»¤çš„å…·ä½“å†…å®¹" data-id="section20210414162309" data-show=true data-collapse=true ces-->

| jX    | Condition        | Description              |
|:-------:|:----------------:|:------------------------:|
| `je`  | `ZF`             | Equal / Zero             |
| `jne` | `~ZF`            | Not Equal / Not Zero     |
| `js`  | `SF`             | Negative                 |
| `jns` | `~SF`            | Nonnegative              |
| `jg`  | `~(SF^OF) & ~ZF` | Greater(Signed)          |
| `jge` | `~(SF^OF)`      | Greater or Equal(Signed) |
| `jl`  | `(SF^OF)`       | Less (Signed)            |
| `jle` | `(SF^OF) $|$ZF`    | Less or Equal(Signed)    |
| `ja`  | `~CF&~ZF`        | Above (unsigned)         |
| `jb`  | `CF`             | Below (unsigned)         |

<!--endsec-->

* `jx`
  * ä¾èµ–å½“å‰çš„æ¡ä»¶ç é€‰æ‹©ä¸‹ä¸€æ¡æ‰§è¡Œè¯­å¥ï¼ˆæ˜¯å¦é¡ºåºæ‰§è¡Œï¼‰

<!--sec data-title="è·³è½¬æŒ‡ä»¤çš„å®ä¾‹" data-id="section20210414162657" data-show=true data-collapse=true ces-->
* C ä»£ç ä¸æ±‡ç¼–ä»£ç 
  * ![20210414162731-2021-04-14-16-27-31](https://cdn.jsdelivr.net/gh/Lijunjie9502/PicBed@master/20210414162731-2021-04-14-16-27-31.png)
  * gcc-4.8 ä¸‹æ²¡æœ‰æ‘¸ç´¢å‡ºå¦‚ä½•ç¼–è¯‘å‡ºè¿™ç§æ±‡ç¼–ä»£ç ï¼Œåªæœ‰åŠ ä¸Š `-march=i386` æ‰å¯ä»¥å¾—åˆ°ç±»ä¼¼çš„ç»“æœï¼Œä¸ç„¶å‡ºæ¥çš„æ˜¯æ¡ä»¶ä¼ é€æŒ‡ä»¤ `cmovC`
* æ±‡ç¼–ä»£ç ä¸ C ä»£ç åŸå§‹çš„ "goto" æ¨¡å¼ç±»ä¼¼
  * ![20210414162748-2021-04-14-16-27-48](https://cdn.jsdelivr.net/gh/Lijunjie9502/PicBed@master/20210414162748-2021-04-14-16-27-48.png)
* ä¹Ÿä¸ C è¯­è¨€çš„æ¡ä»¶è¡¨è¾¾å¼ç±»ä¼¼
  * ![20210414163307-2021-04-14-16-33-08](https://cdn.jsdelivr.net/gh/Lijunjie9502/PicBed@master/20210414163307-2021-04-14-16-33-08.png)
<!--endsec-->

## æ¡ä»¶ä¼ é€æŒ‡ä»¤

* `cmovC src, dest`
  * å¦‚æœæ¡ä»¶ C æˆç«‹ï¼Œå°†æ•°æ®ä» `src` ä¼ é€è‡³ `dest`
  * ä»æ‰§è¡Œçš„è§’åº¦çœ‹ï¼Œæ¯”ä¸€èˆ¬çš„æ¡ä»¶è·³è½¬æŒ‡ä»¤çš„æ•ˆç‡é«˜
    * å› ä¸ºå…¶æ§åˆ¶æµå¯é¢„æµ‹ï¼Œä¸ä¼šå‡ºç°è·³è½¬æ‰§è¡Œçš„æƒ…å†µ

<!--sec data-title="æ¡ä»¶ä¼ é€æŒ‡ä»¤å®ä¾‹" data-id="section20210414164704" data-show=true data-collapse=true ces-->

* x86-64 ä¸‹å¯¹äº `absdiff` æ¥è¯´ï¼Œä¼šç”¨æ¡ä»¶ä¼ é€æŒ‡ä»¤æ¥æ›¿æ¢æ¡ä»¶è·³è½¬æŒ‡ä»¤
  ![20210414165210-2021-04-14-16-52-10](https://cdn.jsdelivr.net/gh/Lijunjie9502/PicBed@master/20210414165210-2021-04-14-16-52-10.png)
* åœ¨ `-m32` ç¼–è¯‘é€‰é¡¹ä¸‹ï¼Œå¦‚æœåŠ ä¸Š `-march=i686` é€‰é¡¹ï¼Œä¹Ÿå¯ç¼–è¯‘å‡ºé‡‡ç”¨æ¡ä»¶ä¼ é€æŒ‡ä»¤çš„æ±‡ç¼–ä»£ç 
  * ![20210414165434-2021-04-14-16-54-34](https://cdn.jsdelivr.net/gh/Lijunjie9502/PicBed@master/20210414165434-2021-04-14-16-54-34.png)

<!--endsec-->
