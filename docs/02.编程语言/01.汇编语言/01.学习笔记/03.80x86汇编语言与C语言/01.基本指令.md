---
title: åŸºæœ¬æŒ‡ä»¤
date: 2021-04-12 06:49:07
permalink: /pages/135dcb/
categories: 
  - æ±‡ç¼–è¯­è¨€
tags: 
  - null
author: 
  name: æœ¨å­è¯†æ—¶åŠ¡
  link: https://github.com/sbwcwso
editLink: true
---

# 80X86 æ±‡ç¼–ä¸ C è¯­è¨€ -- åŸºæœ¬æŒ‡ä»¤

## æ±‡ç¼–ç¨‹åºå‘˜çœ¼ä¸­çš„å¤„ç†å™¨ç³»ç»Ÿç»“æ„

<!--sec data-title="CPU å’Œå†…å­˜ç©ºé—´ç»“æ„ç¤ºæ„å›¾" data-id="section20210412071236" data-show=true ces-->
![20210412071251-2021-04-12-07-12-51](https://cdn.jsdelivr.net/gh/Lijunjie9502/PicBed@master/20210412071251-2021-04-12-07-12-51.png)
<!--endsec-->

* æŒ‡ä»¤å¯„å­˜å™¨(PC Program Counter)
  * æŒ‡å‘ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€
  * EIP(X86-32) æˆ– RIP(x86-64)
* å¯„å­˜å™¨å †
* æ¡ä»¶ç 
  * ç”¨äºå‚¨å­˜æœ€è¿‘æ‰§è¡ŒæŒ‡ä»¤çš„ç»“æœçŠ¶æ€ä¿¡æ¯
  * ç”¨äºæ¡ä»¶è·³è½¬æŒ‡ä»¤çš„åˆ¤æ–­
* å†…å­˜ç©ºé—´
  * ä»¥å­—èŠ‚ç¼–ç çš„è¿ç»­å­˜å‚¨ç©ºé—´
  * å­˜æ”¾ç¨‹åºä»£ç ã€æ•°æ®ã€è¿è¡Œæ ˆä»¥åŠæ“ä½œç³»ç»Ÿæ•°æ®

## ä» C ç”Ÿæˆæ±‡ç¼–ä»£ç 

<!--sec data-title="C ä»£ç " data-id="section20210412091202" data-show=true ces-->

```c
int sum(int x, int y)
{
  int t = x + y;
  return t;
}
```
<!--endsec-->

<!--sec data-title="å‘½ä»¤è¡Œç¼–è¯‘" data-id="section20210412091229" data-show=true ces-->
* `gcc -O2 -S sum.c -m32 -fno-omit-frame-pointer -fno-asynchronous-unwind-tables`
  * `-O2` æ˜¯ä¼˜åŒ–çš„çº§åˆ«
  * `-m32` æ˜¯é€‰æ‹© 32 ä½çš„ CPU
  * `-S` ç”Ÿæˆæ±‡ç¼–ä»£ç 
  * `-fno-asynchronous-unwind-tables` ç¦æ­¢è¾“å‡ºä¸€äº›ä¿¡æ¯
    * [ğŸ”— å‚è€ƒ](https://cloud.tencent.com/developer/ask/102663/answer/182019)
<!--endsec-->

<!--sec data-title="å¯¹åº”çš„ X86-32æ±‡ç¼–(AT&T æ±‡ç¼–æ ¼å¼)" data-id="section20210412091306" data-show=true ces-->
```nasm
sum:
  pushl %ebp
  movl  %esp, %ebp
  movl  12(%ebp), %eax
  addl  8(%ebp), %eax
  movl  %ebp, %esp
  popl  %ebp
  ret
```

* å…¶ä¸­ç¬¬6ï¼Œ7è¡ŒæŒ‡ä»¤å¯èƒ½æ˜¯ä¸€æ¡ç­‰ä»·çš„ `leave` æŒ‡ä»¤æˆ–è€…æ˜¯ `pop %ebp` æŒ‡ä»¤
<!--endsec-->

## æ±‡ç¼–è¯­è¨€æ•°æ®æ ¼å¼

* åœ¨ X86-32 ä¸­ï¼Œä½¿ç”¨ â€œå­—(word)â€ æ¥è¡¨ç¤º 16 ä½æ•´æ•°ç±»å‹ï¼Œâ€œåŒå­—â€è¡¨ç¤º 32 ä½
* æ±‡ç¼–è¯­è¨€ä¸­æ²¡æœ‰æ•°æ®ç±»å‹ï¼Œä¸€èˆ¬é‡‡ç”¨æ±‡ç¼–æŒ‡ä»¤åç¼€è¿›è¡ŒåŒºåˆ†

<!--sec data-title="X86-32ä¸­çš„å„ç§æ•°æ®æ ¼å¼" data-id="section20210412090955" data-show=true ces-->
| C å£°æ˜            | Intel æ•°æ®ç±»å‹ | æ±‡ç¼–ä»£ç åç¼€ | å¤§å°(å­—èŠ‚) |
|-----------------|------------|--------|--------|
| `char`          | å­—èŠ‚         | b      | 1      |
| `short`         | å­—          | w      | 2      |
| `int`           | åŒå­—         | l      | 4      |
| `long int`      | åŒå­—         | l      | 4      |
| `long long int` | --         | --     | 4      |
| `char *`        | åŒå­—         | l      | 4      |
| `float`         | å•ç²¾åº¦        | s      | 4      |
| `double`        | åŒç²¾åº¦        | l      | 8      |
| `long double`   | æ‰©å±•ç²¾åº¦       | t      | 10/12  |
<!--endsec-->

## ç¬¬ä¸€æ¡æ±‡ç¼–æŒ‡ä»¤å®ä¾‹

<!--sec data-title="Cä»£ç " data-id="section20210412091417" data-show=true ces-->
* ä¸¤ä¸ªæ•´æ•°(32ä½)ç›¸åŠ 
  
  ```c
  int t = x + y
  ```
<!--endsec-->

<!--sec data-title="æ±‡ç¼–ä»£ç " data-id="section20210412091545" data-show=true ces-->
* ä¸¤ä¸ª32ä½æ•´æ•°ç›¸åŠ 

  ```nasm
  addl %edx, %eax
  ```

  * `l` åç¼€è¡¨ç¤ºæ˜¯åŒå­—è¿ç®—
  * æ— ç¬¦å·/å¸¦ç¬¦å·æ•´æ•°åŠ æ³•è¿ç®—çš„æŒ‡ä»¤æ˜¯ä¸€æ ·çš„
  * ä¸ C è¯­è¨€çš„æ“ä½œæ•°å¯¹åº”  
    `x: Register eax`  
    `y: Register edx`  
    `t: Register eax`  
      `>> æœ€ç»ˆç»“æœå­˜äº eax`
<!--endsec-->

<!--sec data-title="æœºå™¨ç " data-id="section20210412092143" data-show=true ces-->

```nasm
a:  01  d0    add %edx, %eax
```

* 2 å­—èŠ‚æŒ‡ä»¤

<!--endsec-->

## æ•°æ®ä¼ é€æŒ‡ä»¤(MOV)

<!--sec data-title="æ•°æ®ä¼ é€’(AT&T è¯­æ³•)" data-id="section20210412092749" data-show=true ces-->
* `movl Source, Dest`
  * å°†ä¸€ä¸ªâ€œåŒå­—â€ä» `Source` ç§»åŠ¨åˆ° `Dest`
  * å¸¸è§æŒ‡ä»¤
<!--endsec-->

<!--sec data-title="å…è®¸çš„æ“ä½œæ•°ç±»å‹" data-id="section20210412092955" data-show=true ces-->
* ç«‹å³æ•°ï¼ˆImmï¼‰ï¼šå¸¸æ•´æ•°
  * å¦‚ï¼š `$0x400`, `$-533`
  * å¯åˆè¢«1ï¼Œ2æˆ–4ä¸ªå­—èŠ‚è¡¨ç¤º
* å¯„å­˜å™¨
  * 8 ä¸ªé€šç”¨å¯„å­˜å™¨  
    ![20210412093155-2021-04-12-09-31-55](https://cdn.jsdelivr.net/gh/Lijunjie9502/PicBed@master/20210412093155-2021-04-12-09-31-55.png)
* å­˜å‚¨å™¨ï¼šå››ä¸ªè¿ç»­å­—èŠ‚
  * æ”¯æŒå¤šç§è®¿å­˜å¯»å€æ¨¡å¼
<!--endsec-->

<!--sec data-title="æ•°æ®ä¼ è¾“æŒ‡ä»¤æ”¯æŒçš„ä¸åŒæ“ä½œæ•°ç±»å‹ç»„åˆ" data-id="section20210412093310" data-show=true ces-->
![20210412093411-2021-04-12-09-34-11](https://cdn.jsdelivr.net/gh/Lijunjie9502/PicBed@master/20210412093411-2021-04-12-09-34-11.png)  

* **ä¸èƒ½ä¸¤ä¸ªæ“ä½œæ•°éƒ½ä¸ºå†…å­˜åœ°å€ï¼**
* é€šç”¨å¯„å­˜å™¨åŠ æ‹¬å·æ˜¯é€šç”¨çš„å¯»å€å½¢å¼ï¼Œå‚ç…§ [ğŸ”— é€šç”¨å¯»å€å½¢å¼](#é€šç”¨å¯»å€å½¢å¼)
<!--endsec-->

### ç¬¦å·æ‰©å±•ä¸é›¶æ‰©å±•

<!--sec data-title="å½“ Source å ç”¨å­—èŠ‚å°äº Dest å ç”¨å­—èŠ‚æ—¶ï¼Œéœ€è¦å¯¹ Source ä¸­çš„æ•°æ®è¿›è¡Œæ‰©å±•" data-id="section20210412112211" data-show=true ces-->
![20210412112408-2021-04-12-11-24-08](https://cdn.jsdelivr.net/gh/Lijunjie9502/PicBed@master/20210412112408-2021-04-12-11-24-08.png)
<!--endsec-->

## å¯»å€æ¨¡å¼

### ç®€å•çš„å¯»å€æ¨¡å¼

* é—´æ¥å¯»å€
  * å¯„å­˜å™¨ `R` ä¸­æŒ‡å®šå†…å­˜åœ°å€ï¼Œ åˆ™ `(R)` ç›¸å½“äºæ˜¯ `Mem[Reg[R]]`
  * æŒ‡ä»¤ï¼š `movl (%ecx), %eax`
* åŸºå€+åç§»é‡å¯»å€
  * å¯„å­˜å™¨ `R` ä¸­æŒ‡å®šå†…å­˜èµ·å§‹åœ°å€ï¼Œå¸¸æ•° `D` ç»™å‡ºåç§»é‡
    * `D(R)` ç­‰ä»·äº `Mem[Reg[R]+D]`
  * æŒ‡ä»¤ï¼š `movl 8(%ebp), %edx`

<!--sec data-title="ç®€å•å¯»å€æ¨¡å¼ä½¿ç”¨å®ä¾‹" data-id="section20210412105214" data-show=true data-collapse=true ces-->
* C ä»£ç ä¸æ±‡ç¼–ç   
  ![20210412105345-2021-04-12-10-53-45](https://cdn.jsdelivr.net/gh/Lijunjie9502/PicBed@master/20210412105345-2021-04-12-10-53-45.png)
  * å…¶ä¸­ SetUp ä¸ Finish ä¸æ ˆå¸§çš„æ“ä½œç›¸å…³ï¼Œä¼šåœ¨åç»­å†…å®¹ä¸­ä»‹ç»ã€‚Body éƒ¨åˆ†æ˜¯å‡½æ•°çš„ä¸»ä½“
  * å¯„å­˜å™¨ä¸ C ä¸­å˜é‡çš„å¯¹åº”  
    ![20210412105544-2021-04-12-10-55-44](https://cdn.jsdelivr.net/gh/Lijunjie9502/PicBed@master/20210412105544-2021-04-12-10-55-44.png)
  * åˆå§‹æ—¶æ ˆå¸§çš„æƒ…å†µ  
    ![20210412105623-2021-04-12-10-56-23](https://cdn.jsdelivr.net/gh/Lijunjie9502/PicBed@master/20210412105623-2021-04-12-10-56-23.png)
    * `%ebp` æŒ‡å‘çš„æ˜¯æ ˆå¸§çš„åŸºå€
      * å…¶å¾€ä¸Šå¯ä»¥è®¿é—®çˆ¶å‡½æ•°ä¼ é€’çš„å‚æ•°
      * å¾€ä¸‹å¯ä»¥è®¿é—®å‡½æ•°å†…éƒ¨çš„å±€éƒ¨å˜é‡
* æ±‡ç¼–ä»£ç çš„æ‰§è¡Œè¿‡ç¨‹  
  ![movæŒ‡ä»¤-2021-04-12-10-58-49](https://cdn.jsdelivr.net/gh/Lijunjie9502/PicBed@master/movæŒ‡ä»¤-2021-04-12-10-58-49.gif)
<!--endsec-->

### é€šç”¨å¯»å€å½¢å¼

* `D(Rb, Ri, S)` â¡ï¸ `Mem[Reg[Rb] + S * Reg[Ri] + D]`
  * `D`: å¸¸é‡(åœ°å€åç§»é‡)
  * `Rb`: åŸºå€å¯„å­˜å™¨
    * 8 ä¸ªé€šç”¨å¯„å­˜å™¨ä¹‹ä¸€
  * `Ri`: ç´¢å¼•å¯„å­˜å™¨
    * `%esp` ä¸èƒ½ä½œä¸ºç´¢å¼•å¯„å­˜å™¨
    * ä¸€èˆ¬ `%ebp` ä¹Ÿä¸ç”¨ä½œæ­¤ç”¨é€”
  * `S`: æ¯”ä¾‹å› äº† 1ï¼Œ2ï¼Œ 4ï¼Œ or 8

<!--sec data-title="é€šç”¨å¯»å€æ¨¡å¼å®ä¾‹" data-id="section20210412111142" data-show=true ces-->
* è®¾å¯„å­˜å™¨ `%edx` çš„å€¼ä¸º `0xf200`ï¼Œå¯„å­˜å™¨ `%ecx` çš„å€¼ä¸º `0x100`

| åœ°å€è¡¨è¾¾å¼           | åœ°å€è®¡ç®—               | è®¿å­˜åœ°å€    |
|:---------------:|:------------------:|:-------:|
| 0x8             | 0x8                | 0x8     |
| 0x8(%edx)       | 0xf200 + 0x8       | 0xf208  |
| (%dex, %exc)    | 0xf200 + 0x100     | 0xf300  |
| (%dex, %ecx, 4) | 0xf200 + 4 * 0x100 | 0xf600  |
| 0x80(, %edx, 2) | 2 * 0xf200 + 0x80  | 0x1e480 |

* å¦‚æœæ˜¯ `$0x8`ï¼Œ åˆ™è¡¨ç¤ºç«‹å³æ•°ï¼›å¦åˆ™å°±æ˜¯å†…å­˜åœ°å€

<!--endsec-->

## åœ°å€è®¡ç®—æŒ‡ä»¤

* `leal Src, Dest`
  * `Src` ä¸ºåœ°å€è®¡ç®—è¡¨è¾¾å¼
  * è®¡ç®—å‡ºæ¥çš„åœ°å€èµ‹ç»™ `Dest`
  * `mov` æŒ‡ä»¤ä¼šè®¿å­˜ï¼Œ`leal` ä¸ä¼š

<!--sec data-title="åœ°å€è®¡ç®—æŒ‡ä»¤ä½¿ç”¨ç¤ºä¾‹" data-id="section20210412113014" data-show=true ces-->
* åœ°å€è®¡ç®—(æ— éœ€è®¿å­˜)
  * æ¯”å¦‚è®¡ç®—å…ƒç´ çš„åœ°å€ï¼Œ `p = &x[i];`
* è¿›è¡Œ `x + k * y, k=1,2,4, or 8` è¿™ä¸€ç±»å‹çš„æ•´æ•°è®¡ç®—
  * å…¶å½¢å¼ä¸å¯»å€è®¡ç®—ç›¸åŒï¼Œå‚ç…§ [ğŸ”— é€šç”¨å¯»å€å½¢å¼](#é€šç”¨å¯»å€å½¢å¼)
  * å€ŸåŠ© `leal` æŒ‡ä»¤ä¼šæ¯”åŠ å‡ä¹˜é™¤æŒ‡ä»¤å¿«
<!--endsec-->

## æ•´æ•°è®¡ç®—æŒ‡ä»¤

<!--sec data-title="åŒæ“ä½œæ•°æŒ‡ä»¤" data-id="section20210412114607" data-show=true ces-->

| æŒ‡ä»¤æ ¼å¼              | è®¡ç®—                |
|:-----------------|:-----------------:|
| `addl   Src, Dest` | `Dest = Dest + Src` |
| `subl   Src, Dest` | `Dest = Dest - Src` |
| `imull  Src, Dest` | `Dest = Dest * Src` |
| `sall   Src, Dest` | `Dest = Dest << Src`  ä¸ `shll` ç­‰ä»·|
| `sarl   Src, Dest` | `Dest = Dest >> Src`  ç®—æœ¯å³ç§»|
| `shrl   Src, Dest` | `Dest = Dest >> Src`  é€»è¾‘å³ç§»|
| `xorl  Src, Dest` | `Dest = Dest ^ Src` |
| `andl  Src, Dest` | `Dest = Dest & Src` |
| `orl  Src, Dest` | `Dest = Dest | Src` |

<!--endsec-->

<!--sec data-title="å•æ“ä½œæ•°æŒ‡ä»¤" data-id="section20210412114641" data-show=true ces-->

| æŒ‡ä»¤æ ¼å¼              | è®¡ç®—                |
|:-----------------|:-----------------:|
| `incl Dest` | `Dest = Dest + 1` |
| `decl Dest` | `Dest = Dest - 1` |
| `negl Dest` | `Dest = - Dest` |
| `notl Dest` | `Dest = ~ Dest` |

<!--endsec-->

<!--sec data-title="å®ä¾‹1: å°† leal æŒ‡ä»¤ç”¨äºè®¡ç®—" data-id="section20210412120937" data-show=true data-collapse=true ces-->

* C ä»£ç 

  ```c
  int arith(int x, int y, int z)
  {
    int t1 = x + y;
    int t2 = z + t1;
    int t3 = x  + 4;
    int t4 = y * 48;
    int t5 = t3 + t4;
    int rval = t2 * t5;
    return rval;
  }
  ```

* æ±‡ç¼–ç 

  ```nasm
  arith:
    pushl %ebp
    movl  %esp, %ebp

    movl  8(%ebp), %ecx
    movl  12(%ebp), %edx
    leal  (%ecx,%edx), %eax
    leal  (%edx,%edx,2), %edx
    addl  16(%ebp), %eax
    sall  $4, %edx
    leal  4(%ecx,%edx), %edx
    imull %edx, %eax

    popl %ebp
    ret

  ```

* æ±‡ç¼–ç ä¸ C ä»£ç çš„å¯¹åº”  
  ![20210412121300-2021-04-12-12-13-00](https://cdn.jsdelivr.net/gh/Lijunjie9502/PicBed@master/20210412121300-2021-04-12-12-13-00.png)

<!--endsec-->

<!--sec data-title="å®ä¾‹2: æ•´æ•°è®¡ç®—æŒ‡ä»¤" data-id="section20210412121319" data-show=true data-collapse=true ces-->
* C ä»£ç 

  ```c
  int logical(int x, int y)
  {
    int t1 = x^y;
    int t2 = t1 >> 17;
    int mask = (1<<13) - 7;
    int rval = t2 & mask;
    return rval;
  }
  ```

* æ±‡ç¼–ä»£ç 

  ```nasm
  logical:
    pushl %ebp
    movl  %esp, %ebp
    movl  12(%ebp), %eax
    xorl  8(%ebp), %eax
    popl  %ebp
    sarl  $17, %eax
    andl  $8185, %eax
    ret
  ```

* æ±‡ç¼–ä»£ç ä¸ C è¯­è¨€çš„å¯¹åº”  
  ![20210412121911-2021-04-12-12-19-11](https://cdn.jsdelivr.net/gh/Lijunjie9502/PicBed@master/20210412121911-2021-04-12-12-19-11.png)
<!--endsec-->

## X86-32 ä¸ X86-64 æ¯”è¾ƒ

### X86-32 ä¸ X86-64 çš„æ•°æ®ç±»å‹å®½åº¦

<!--sec data-title="Size of C objects(in Bytes)" data-id="section20210412122225" data-show=true ces-->
![20210412122258-2021-04-12-12-22-58](https://cdn.jsdelivr.net/gh/Lijunjie9502/PicBed@master/20210412122258-2021-04-12-12-22-58.png)
<!--endsec-->

### x86-64 çš„é€šç”¨å¯„å­˜å™¨

* å…¶æ‰©å±•äº†ç°æœ‰çš„å¯„å­˜å™¨ï¼Œå¹¶å¢åŠ äº† 8 ä¸ªæ–°çš„å¯„å­˜å™¨
* `%ebp, %rbp` ä¸å†æ˜¯ä¸“ç”¨å¯„å­˜å™¨

<!--sec data-title="x86-64çš„é€šç”¨å¯„å­˜å™¨ç¤ºæ„å›¾" data-id="section20210412122411" data-show=true ces-->
![20210412122440-2021-04-12-12-24-40](https://cdn.jsdelivr.net/gh/Lijunjie9502/PicBed@master/20210412122440-2021-04-12-12-24-40.png)
<!--endsec-->

### ä¸¤è€…æ±‡ç¼–ä»£ç çš„ä¸åŒä¹‹å¤„

<!--sec data-title="x86-32 ä¸‹çš„ swap" data-id="section20210412123051" data-show=true data-collapse=true ces-->
  ![20210412105345-2021-04-12-10-53-45](https://cdn.jsdelivr.net/gh/Lijunjie9502/PicBed@master/20210412105345-2021-04-12-10-53-45.png)
<!--endsec-->

<!--sec data-title="x86-64ä¸‹çš„ swap" data-id="section20210412123307" data-show=true data-collapse=true ces-->
![20210412123332-2021-04-12-12-33-32](https://cdn.jsdelivr.net/gh/Lijunjie9502/PicBed@master/20210412123332-2021-04-12-12-33-32.png)

* x86-64 ä¸ x86-32 çš„ä¸åŒç‚¹
  * å‚æ•°é€šè¿‡å¯„å­˜å™¨æ¥ä¼ é€’
    * å½“å‚æ•°å°‘äº 7 ä¸ªæ—¶ï¼Œå‚æ•°ä»å·¦åˆ°å³æ”¾å…¥å¯„å­˜å™¨ï¼š`rdi, rsi, rdx, rcx, r8, r9`
    * å½“å‚ä¸º 7 ä¸ªä»¥ä¸Šæ—¶ï¼Œå‰ 6 ä¸ªä¼ é€’æ–¹å¼ä¸å˜ï¼Œä½†åé¢çš„ä¾æ¬¡ä»â€œå³å‘å·¦â€æ”¾å…¥æ ˆä¸­
  * ç›¸å½“äºæ˜¯æ— æ ˆæ“ä½œ

* è¢«æ“ä½œçš„æ•°æ®ä»æ˜¯ 32 ä½
  * æ‰€ä»¥ä½¿ç”¨çš„å¯„å­˜å™¨ä»æ˜¯ `%eax, %edx` ä»¥åŠ `movl` æŒ‡ä»¤
<!--endsec-->

<!--sec data-title="x86-64ä¸‹ long int çš„ swap è¿‡ç¨‹" data-id="section20210412124158" data-show=true data-collapse=true ces-->
![20210412124259-2021-04-12-12-43-00](https://cdn.jsdelivr.net/gh/Lijunjie9502/PicBed@master/20210412124259-2021-04-12-12-43-00.png)  

* è¢«æ“ä½œçš„æ•°æ®æ˜¯ 64 ä½
  * æ‰€åˆä½¿ç”¨å¯„å­˜å™¨ `%rax`, `%rdx`
  * åˆåŠ `movq` æŒ‡ä»¤
    * `q` è¡¨ç¤º â€œ4å­—â€
<!--endsec-->
