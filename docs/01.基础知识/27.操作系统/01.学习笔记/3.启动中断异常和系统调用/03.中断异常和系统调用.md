---
title: ä¸­æ–­å¼‚å¸¸å’Œç³»ç»Ÿè°ƒç”¨
date: 2021-07-16 12:36:23
permalink: /pages/578583/
categories: 
  - å­¦ä¹ ç¬”è®°
  - æ“ä½œç³»ç»Ÿ
  - å¯åŠ¨ä¸­æ–­å¼‚å¸¸å’Œç³»ç»Ÿè°ƒç”¨
tags: 
  - null
author: 
  name: æœ¨å­è¯†æ—¶åŠ¡
  link: https://github.com/sbwcwso
editLink: true
---
# ä¸­æ–­ã€å¼‚å¸¸å’Œç³»ç»Ÿè°ƒç”¨

* [ğŸ”— è¯¾ä»¶](assets/lec3-å¯åŠ¨ä¸­æ–­å¼‚å¸¸ç³»ç»Ÿè°ƒç”¨_125003200.pdf)

---

<!--sec data-title="å†…æ ¸è¿›å…¥ä¸é€€å‡ºçš„ç¤ºæ„å›¾" data-id="section20210410163407" data-show=true ces-->
![20210410163435-2021-04-10-16-34-35](https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20210410163435-2021-04-10-16-34-35.png)
<!--endsec-->

* ç³»ç»Ÿè°ƒç”¨ï¼ˆsystem callï¼‰
  * åº”ç”¨ç¨‹åºä¸»åŠ¨å‘æ“ä½œç³»ç»Ÿå‘å‡ºçš„æœåŠ¡è¯·æ±‚
* å¼‚å¸¸(exception)
  * éæ³•æŒ‡ä»¤æˆ–è€…å…¶ä»–åŸå› å¯¼è‡´å½“å‰æŒ‡ä»¤æ‰§è¡Œå¤±è´¥  
    (å¦‚ï¼šå†…å­˜å‡ºé”™)åçš„å¤„ç†è¯·æ±‚
* ä¸­æ–­(hardware interrupt)
  * æ¥è‡ªç¡¬ä»¶è®¾å¤‡çš„å¤„ç†è¯·æ±‚

## ä¸­æ–­ã€å¼‚å¸¸å’Œç³»ç»Ÿçš„è°ƒç”¨æ¯”è¾ƒ

* æºå¤´
  * ä¸­æ–­ï¼šå¤–è®¾
  * å¼‚å¸¸ï¼šåº”ç”¨ç¨‹åºæ„æƒ³ä¸åˆ°çš„è¡Œä¸º
  * ç³»ç»Ÿè°ƒç”¨ï¼šåº”ç”¨ç¨‹åºè¯·æ±‚æ“ä½œæä¾›æœåŠ¡
* å“åº”æ–¹å¼
  * ä¸­æ–­ï¼šå¼‚æ­¥
  * å¼‚å¸¸ï¼šåŒæ­¥
  * ç³»ç»Ÿè°ƒç”¨ï¼šå¼‚æ­¥æˆ–åŒæ­¥
* å¤„ç†æœºåˆ¶
  * ä¸­æ–­ï¼šæŒç»­ï¼Œå¯¹ç”¨æˆ·åº”ç”¨ç¨‹åºæ˜¯é€æ˜çš„
  * å¼‚å¸¸ï¼šæ€æ­»æˆ–è€…é‡æ–°æ‰§è¡Œæ„æƒ³ä¸åˆ°çš„åº”ç”¨ç¨‹åºæŒ‡ä»¤
  * ç³»ç»Ÿè°ƒç”¨ï¼šç­‰å¾…å’ŒæŒç»­

## ä¸­æ–­

### ä¸­æ–­å¤„ç†æœºåˆ¶

å…ˆç¡¬ä»¶å¤„ç†å†è½¯ä»¶å¤„ç†

* ç¡¬ä»¶å¤„ç†
  * åœ¨CPUåˆå§‹åŒ–æ—¶è®¾ç½®ä¸­æ–­ä½¿èƒ½æ ‡å¿—
    * ä¾æ®å†…éƒ¨æˆ–å¤–éƒ¨äº‹ä»¶è®¾ç½®ä¸­æ–­æ ‡å¿—
    * ä¾æ®ä¸­æ–­å‘é‡è°ƒç”¨ç›¸åº”ä¸­æ–­æœåŠ¡ä¾‹ç¨‹
* è½¯ä»¶å¤„ç†
  * ç°åœºä¿å­˜ï¼ˆç¼–è¯‘å™¨ï¼‰
    * ä¿å­˜ä¸­æ–­å‰çš„çŠ¶æ€
  * ä¸­æ–­æœåŠ¡å¤„ç†ï¼ˆæœåŠ¡ä¾‹ç¨‹ï¼‰
  * æ¸…é™¤ä¸­æ–­æ ‡è®°ï¼ˆæœåŠ¡ä¾‹ç¨‹ï¼‰
  * ç°åœºæ¢å¤ï¼ˆç¼–è¯‘å™¨ï¼‰
    * æ¢å¤åˆ°ä¸­æ–­å‰çš„çŠ¶æ€

### ä¸­æ–­åµŒå¥—

* ç¡¬ä»¶ä¸­æ–­æœåŠ¡ä¾‹ç¨‹å¯è¢«æ‰“æ–­
  * ä¸åŒç¡¬ä»¶ä¸­æ–­æºå¯èƒ½ç¡¬ä»¶ä¸­æ–­å¤„ç†æ—¶å‡ºç°
  * ç¡¬ä»¶ä¸­æ–­æœåŠ¡ä¾‹ç¨‹ä¸­éœ€è¦ä¸´æ—¶ç¦æ­¢ä¸­æ–­è¯·æ±‚
  * ä¸­æ–­è¯·æ±‚ä¼šä¿æŒåˆ°CPUåšå‡ºå“åº”
* å¼‚å¸¸æœåŠ¡ä¾‹ç¨‹å¯è¢«æ‰“æ–­
  * å¼‚å¸¸æœåŠ¡ä¾‹ç¨‹æ‰§è¡Œæ—¶å¯èƒ½å‡ºç°ç¡¬ä»¶ä¸­æ–­
* å¼‚å¸¸æœåŠ¡ä¾‹ç¨‹å¯åµŒå¥—
  <!-- TODO:ç¼ºé¡µåœ¨æ­¤å¤„çš„å«ä¹‰-->
  * å¼‚å¸¸æœåŠ¡ä¾‹ç¨‹å¯èƒ½å‡ºç°ç¼ºé¡µ

## ç³»ç»Ÿè°ƒç”¨

<!--sec data-title="æ ‡å‡† C åº“çš„ä¾‹å­" data-id="section20210410165750" data-show=true ces-->
* åº”ç”¨ç¨‹åºè°ƒç”¨`printf()` æ—¶ï¼Œä¼šè§¦å‘ç³»ç»Ÿè°ƒç”¨`write()`

![20210410165852-2021-04-10-16-58-52](https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20210410165852-2021-04-10-16-58-52.png)
<!--endsec-->

* æ“ä½œç³»ç»ŸæœåŠ¡çš„ç¼–ç¨‹æ¥å£
* é€šå¸¸ç”±é«˜çº§è¯­è¨€ç¼–å†™ï¼ˆCæˆ–è€…C++ï¼‰
* ç¨‹åºè®¿é—®é€šå¸¸æ˜¯é€šè¿‡é«˜å±‚æ¬¡çš„APIæ¥å£è€Œä¸æ˜¯ç›´æ¥è¿›è¡Œç³»ç»Ÿè°ƒç”¨
* ä¸‰ç§æœ€å¸¸ç”¨çš„åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ï¼ˆAPIï¼‰
  * Win32 API ç”¨äº Windows
  * POSIX API ç”¨äº POSIX-based systems (åŒ…æ‹¬UNIXï¼ŒLINUXï¼ŒMac OS Xçš„æ‰€æœ‰ç‰ˆæœ¬)
  * Java API ç”¨äºJAVAè™šæ‹Ÿæœº(JVM)

### ç³»ç»Ÿè°ƒç”¨çš„å®ç°

* æ¯ä¸ªç³»ç»Ÿè°ƒç”¨å¯¹åº”ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å·
  * ç³»ç»Ÿè°ƒç”¨æ¥å£æ ¹æ®ç³»ç»Ÿè°ƒç”¨å·æ¥ç»´æŠ¤ç³»ç»Ÿè°ƒç”¨è¡¨çš„ç´¢å¼•
* ç³»ç»Ÿè°ƒç”¨æ¥å£è°ƒç”¨å†…æ ¸æ€ä¸­çš„ç³»ç»Ÿè°ƒç”¨åŠŸèƒ½å®ç°ï¼Œå¹¶è¿”å›ç³»ç»Ÿè°ƒç”¨çš„çŠ¶æ€å’Œç»“æœ
* ç”¨æˆ·ä¸éœ€è¦çŸ¥é“ç³»ç»Ÿè°ƒç”¨çš„å®ç°
  * éœ€è¦è®¾ç½®è°ƒç”¨å‚æ•°å’Œè·å–è¿”å›ç»“æœ
  * æ“ä½œç³»ç»Ÿæ¥å£çš„ç»†èŠ‚å¤§éƒ¨åˆ†éƒ½éšè—åœ¨åº”ç”¨ç¼–ç¨‹æ¥å£å
    * **é€šè¿‡è¿è¡Œç¨‹åºæ”¯æŒçš„åº“æ¥ç®¡ç†**

### å‡½æ•°è°ƒç”¨å’Œç³»ç»Ÿè°ƒç”¨çš„ä¸åŒå¤„

* INTå’ŒIRETæŒ‡ä»¤ç”¨äºç³»ç»Ÿè°ƒç”¨
  * ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œä¼šè¿›è¡Œ**å †æ ˆåˆ‡æ¢å’Œç‰¹æƒçº§çš„è½¬æ¢**
* å‡½æ•°è°ƒç”¨
  * `CALL`å’Œ`RET`ç”¨äºå¸¸è§„è°ƒç”¨
  * **å¸¸è§„è°ƒç”¨æ—¶æ²¡æœ‰å †æ ˆåˆ‡æ¢**

### ä¸­æ–­å¼‚å¸¸å’Œç³»ç»Ÿè°ƒç”¨çš„å¼€é”€

* è¶…è¿‡å‡½æ•°è°ƒç”¨
* å¼€é”€ï¼š
  * å¼•å¯¼æœºåˆ¶
  * å»ºç«‹å†…æ ¸å †æ ˆ
  * éªŒè¯å‚æ•°
  * å†…æ ¸æ€æ˜ å°„åˆ°ç”¨æˆ·æ€çš„åœ°å€ç©ºé—´
    * æ›´æ–°é¡µé¢æ˜ å°„æƒé™
* å†…æ ¸æ€ç‹¬ç«‹åœ°å€ç©ºé—´
  <!-- TODO:TLBçš„å…·ä½“å«ä¹‰-->
  * TLB

### ç³»ç»Ÿè°ƒç”¨ç¤ºä¾‹

* ä¸ºäº†ä¸ç¤ºä¾‹åŒ¹é…ï¼Œå¯ä»¥æŸ¥çœ‹ lab8_answer
  * å¯ä» [ğŸ”— æ­¤å¤„](https://github.com/sbwcwso/sbwcwso.github.io/tree/main/md-file/0-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/1-%E6%B8%85%E5%8D%8E%E5%85%AC%E5%BC%80%E8%AF%BE/3-%E5%90%AF%E5%8A%A8%E4%B8%AD%E6%96%AD%E5%BC%82%E5%B8%B8%E5%92%8C%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/assets/lab8_result) ä¸‹è½½ la8_answer

#### æ–‡ä»¶å¤åˆ¶è¿‡ç¨‹ä¸­çš„ç³»ç»Ÿè°ƒç”¨åºåˆ—
  <!--sec data-title="æ•´ä½“æµç¨‹ç¤ºæ„å›¾" data-id="section20210410174943" data-show=true ces-->
  ![20210410175011-2021-04-10-17-50-11](https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20210410175011-2021-04-10-17-50-11.png)
  <!--endsec-->

  <!--sec data-title="ç³»ç»Ÿè°ƒç”¨å‡½æ•°å¯¹åº”çš„ç¼–å·" data-id="section20210410175026" data-show=true ces-->
  
  ```c
  // System call numbers
  #define SYS_fork 1
  #define SYS_exit 2
  #define SYS_wait 3
  #define SYS_pipe 4
  #define SYS_write 5  // ä¸æ–‡ä»¶å¤åˆ¶ç›¸å…³
  #define SYS_read 6  //  ä¸æ–‡ä»¶å¤åˆ¶ç›¸å…³
  #define SYS_close 7 //  ä¸æ–‡ä»¶å¤åˆ¶ç›¸å…³
  #define SYS_kill 8
  #define SYS_exec 9
  #define SYS_open 10  //  ä¸æ–‡ä»¶å¤åˆ¶ç›¸å…³
  #define SYS_mknod 11
  #define SYS_unlink 12
  #define SYS_fstat 13
  #define SYS_link 14
  #define SYS_mkdir 15
  #define SYS_chdir 16
  #define SYS_dup 17
  #define SYS_getpid 18
  #define SYS_sbrk 19
  #define SYS_sleep 20
  #define SYS_procmem 21
  ```

  <!--endsec-->

#### ucore ä¸­ç›¸å…³åº”ç”¨å‡½æ•°

* åœ¨ucoreä¸­åº“å‡½æ•°`read()`çš„åŠŸèƒ½æ˜¯è¯»æ–‡ä»¶
  * user/libs/file.h: `int read(int fd, void * buf, int length)`

* åº“å‡½æ•° `read()` çš„å‚æ•°å’Œè¿”å›å€¼
  * `int fd`: æ–‡ä»¶å¥æŸ„
  * `void * buf`: æ•°æ®ç¼“å†²åŒºæŒ‡é’ˆ
  * `int length`: æ•°æ®ç¼“å†²åŒºé•¿åº¦
  * `int return_value`: è¿”å›è¯»å‡ºæ•°æ®é•¿åº¦
* åº“å‡½æ•°`read()`ä½¿ç”¨ç¤ºä¾‹
  * in sfs_filetest1.c: `ret = read(fd, data, len)`

#### ç”±åº”ç”¨æ€è½¬åˆ°å†…æ ¸æ€è°ƒç”¨

<!--sec data-title="ç³»ç»Ÿè°ƒç”¨æ¥å£ç¤ºä¾‹" data-id="section20210411061518" data-show=true ces-->

```c
sfs_filetest1.c: ret = read(fd,data,len);
â€¦â€¦
// æ­¤æ®µä»£ç ä¸»è¦ç”¨äºå‹æ ˆ
8029a1:   8b 45 10        mov 0x10(%ebp),%eax
8029a4:   89 44 24 08     mov %eax,0x8(%esp)
8029a8:   8b 45 0c        mov 0xc(%ebp),%eax
8029ab:   89 44 24 04     mov %eax,0x4(%esp)
8029af:   8b 45 08        mov 0x8(%ebp),%eax
8029b2:   89 04 24        mov %eax,(%esp)
8029b5:   e8 33 d8 ff ff  call 8001ed <read>
syscall(int num, ...) {
// ç›¸å½“äºè°ƒç”¨ kern/trap/trapentry.S ä¸­çš„ alltraps
...
  asm volatile (
    "int %1;"
    : "=a" (ret)
    : "i" (T_SYSCALL),
    "a" (num),
    "d" (a[0]),
    "c" (a[1]),https://github.com/sbwcwso/sbwcwso.github.io/tree/main/md-file/0-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/1-%E6%B8%85%E5%8D%8E%E5%85%AC%E5%BC%80%E8%AF%BE/3-%E5%90%AF%E5%8A%A8%E4%B8%AD%E6%96%AD%E5%BC%82%E5%B8%B8%E5%92%8C%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/assets/lab8_result
    "b" (a[2]),
    "D" (a[3]),
    "S" (a[4])
    : "cc", "memory");
  return ret;
```
<!--endsec-->

#### ucoreç³»ç»Ÿå†…æ ¸æ€ç”¨è½¯ä¸­æ–­å®ç°ç³»ç»Ÿè°ƒç”¨çš„è¿‡ç¨‹

* kern/trap/trapentry.S: `alltraps()`
  * è½¯ä¸­æ–­
* kern/trap/trap.c: `trap(), trap_dispatch()`
  * `tf->trapno == T_SYSCALL`
  * `T_SYSCALL` ä¸ºç³»ç»Ÿè°ƒç”¨å¯¹åº”çš„ä¸­æ–­å‘é‡
  * é€šè¿‡æŸ¥è¯¢ä¸­æ–­å‘é‡è¡¨ï¼Œåˆ¤æ–­æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œç„¶åè¿›å…¥ç³»ç»Ÿè°ƒç”¨è¡¨è¿›è¡ŒæŸ¥è¯¢
* kern/syscall/syscall.c: `syscall()`
  * `tf->tf_regs.reg_eax == SYS_read`
  * ç”±ç³»ç»Ÿè°ƒç”¨è¡¨ç¡®å®šéœ€è¦è°ƒç”¨çš„ç³»ç»Ÿå‡½æ•°æ˜¯ `SYS_read`ï¼Œç„¶åå¼€å§‹æ‰§è¡Œç›¸åº”çš„å‡½æ•°
* kern/syscall/syscall.c: `sys_read()`
  * ä» `tf->sp` è·å– `fd, buf, length`
  * ä»å †æ ˆ sp ä¸­è·å–å‚æ•°
  * è°ƒç”¨ç›¸å…³å‡½æ•°å®ç°æ–‡ä»¶è¯»å–
* kern/fs/sysfile.c: `sysfile_read()`
  * è¯»å–æ–‡ä»¶ï¼Œå¹¶è¿”å›ä¸Šçº§è°ƒç”¨å‡½æ•°ï¼Œç›´è‡³ `alltraps()`
* kern/trap/trapentry.S: `trapret()`
  * `trapret()`: å°†è¯»åˆ°çš„å†…å®¹è¿”å›åˆ°ç”¨æˆ·æ€
    <!-- TODO:ireturn å…·ä½“æ˜¯ä»€ä¹ˆ-->
    * å…·ä½“é€šè¿‡ `ireturn` æ¥å®ç°

<!--sec data-title="Understandä½¿ç”¨è®¾ç½®" data-id="section20210411090305" data-show=true ces-->
* Understand çš„ç‰ˆæœ¬æ˜¯ 5.1

* åˆ›å»ºé¡¹ç›®æ³¨æ„æ¡†é€‰è¿›ä¸€æ­¥é…ç½®
  ![20210411090741-2021-04-11-09-07-41](https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20210411090741-2021-04-11-09-07-41.png)
* å°† C/C++ çš„åˆ†ææ¨¡å¼è®¾ä¸º `Fuzzy`
  ![20210411090842-2021-04-11-09-08-42](https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20210411090842-2021-04-11-09-08-42.png)
* File Types ä¸­ç¡®ä¿ .S å¯¹åº”çš„æ˜¯ Assemblyï¼Œå¦‚æœæ²¡æœ‰ç›¸åº”çš„é¡¹ï¼Œéœ€è¦æ–°å»ºæ–‡ä»¶
  ![20210411090946-2021-04-11-09-09-46](https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20210411090946-2021-04-11-09-09-46.png)
* å°† Assembly è®¾ç½®ä¸º IBM
  ![20210411173524-2021-04-11-17-35-24](https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20210411173524-2021-04-11-17-35-24.png)

<!--endsec-->
