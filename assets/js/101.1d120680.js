(window.webpackJsonp=window.webpackJsonp||[]).push([[101],{710:function(t,s,a){"use strict";a.r(s);var n=a(12),e=function(t){t.options.__data__block__={markmap_382ee1e6:"- [第 7 章 链接](#第-7-章-链接)\n  - [7.1 编译器驱动程序](#71-编译器驱动程序)\n  - [7.2 静态链接](#72-静态链接)\n  - [7.3 目标文件](#73-目标文件)\n  - [7.4 可重定位目标文件](#74-可重定位目标文件)\n  - [7.5 符号和符号表](#75-符号和符号表)\n  - [7.6 符号解析](#76-符号解析)\n    - [7.6.1 链接器如何解析多重定义的全局符号](#761-链接器如何解析多重定义的全局符号)\n    - [7.6.2 与静态库链接](#762-与静态库链接)\n    - [7.6.3 链接器如何使用静态库来解析引用](#763-链接器如何使用静态库来解析引用)\n  - [7.7 重定位](#77-重定位)\n    - [7.7.1 重定位条目](#771-重定位条目)\n    - [7.7.2 重定位符号引用](#772-重定位符号引用)\n  - [7.8 可执行目标文件](#78-可执行目标文件)\n  - [7.9 加载可执行目标文件](#79-加载可执行目标文件)\n  - [7.10 动态链接共享库](#710-动态链接共享库)\n  - [7.11 从应用程序中加载和链接共享库](#711-从应用程序中加载和链接共享库)\n  - [7.12 位置无关代码](#712-位置无关代码)\n  - [7.13 库打桩机制](#713-库打桩机制)\n    - [7.13.1 编译时打桩](#7131-编译时打桩)\n    - [7.13.2 链接时打桩](#7132-链接时打桩)\n    - [7.13.3 运行时打桩](#7133-运行时打桩)"}},l=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"第-7-章-链接"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第-7-章-链接"}},[t._v("#")]),t._v(" 第 7 章 链接")]),t._v(" "),a("div",{staticClass:"custom-block note"},[a("p",{staticClass:"custom-block-title"},[t._v("笔记")]),t._v(" "),a("ul",[a("li",[t._v("链接是由叫做链接器程序自动执行的")]),t._v(" "),a("li",[t._v("链接 (linking) 是将各种代码和数据片段收集并组合为一个单一文件的过程\n"),a("ul",[a("li",[t._v("这个文件可被加载到内存并执行")]),t._v(" "),a("li",[t._v("使用分离编译成为可能")])])]),t._v(" "),a("li",[t._v("链接执行的时机\n"),a("ul",[a("li",[t._v("编译时")]),t._v(" "),a("li",[t._v("加载时\n"),a("ul",[a("li",[t._v("操作系统中的"),a("strong",[t._v("加载器")]),t._v(" (loader) 函数将可执行文件中的代码和数据复制到内存，然后将控制转移到这个程序的开头")])])]),t._v(" "),a("li",[t._v("运行时\n"),a("ul",[a("li",[t._v("由应用程序来执行")])])])])])])]),t._v(" "),a("Markmap",{attrs:{id:"markmap_382ee1e6",code:t.$dataBlock.markmap_382ee1e6}}),a("h2",{attrs:{id:"71-编译器驱动程序"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#71-编译器驱动程序"}},[t._v("#")]),t._v(" 7.1 编译器驱动程序")]),t._v(" "),a("div",{staticClass:"custom-block note"},[a("p",{staticClass:"custom-block-title"},[t._v("编译器驱动程序 (complier driver)")]),t._v(" "),a("ul",[a("li",[t._v("代表用户在需要时调用语言预处理器、编译器、汇编器和链接器")])])]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("静态链接的过程")]),t._v(" "),a("ul",[a("li",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220221160509-2022-02-21-16-05-09.png",alt:"20220221160509-2022-02-21-16-05-09"}}),t._v(" "),a("ul",[a("li",[a("code",[t._v("cpp")]),t._v(" 为 C 预处理器\n"),a("ul",[a("li",[t._v("由 "),a("code",[t._v("main.c")]),t._v(" 翻译为 "),a("code",[t._v("main.i")])])])]),t._v(" "),a("li",[a("code",[t._v("cc1")]),t._v(" 为 C 编译器\n"),a("ul",[a("li",[t._v("由 "),a("code",[t._v("main.i")]),t._v(" 翻译成一个汇编语言文件 "),a("code",[t._v("main.s")])])])]),t._v(" "),a("li",[a("code",[t._v("as")]),t._v(" 为汇编器，将 "),a("code",[t._v("main.s")]),t._v(" 翻译为一个可重定位的目标文件 (relocatable object file) "),a("code",[t._v("main.o")])]),t._v(" "),a("li",[a("code",[t._v("ld")]),t._v(" 为链接器程序，将 "),a("code",[t._v("main.o")]),t._v(" 和 "),a("code",[t._v("sum.o")]),t._v(" 以及一些必要的系统目标文件组合起来，创建一个可执行的目标文件 (executable object file)")])])]),t._v(" "),a("li",[a("div",{staticClass:"custom-block note"},[a("p",{staticClass:"custom-block-title"},[a("code",[t._v("gcc -v")]),t._v(" 可以查看编译的具体的过程")])])])])]),t._v(" "),a("h2",{attrs:{id:"72-静态链接"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#72-静态链接"}},[t._v("#")]),t._v(" 7.2 静态链接")]),t._v(" "),a("div",{staticClass:"custom-block note"},[a("p",{staticClass:"custom-block-title"},[t._v("链接器的两个主要任务")]),t._v(" "),a("ul",[a("li",[t._v("符号解析 (symbol resolution)\n"),a("ul",[a("li",[t._v("符号解析的目的是将每个符号"),a("strong",[t._v("引用")]),t._v("正好和每个符号"),a("strong",[t._v("定义")]),t._v("关联起来")])])]),t._v(" "),a("li",[t._v("重定位 (relocation)\n"),a("ul",[a("li",[t._v("编译器和汇编器生成从地址 0 开始的代码和数据节")]),t._v(" "),a("li",[t._v("链接器通过把每个符号定义与一个内存位置关联起来，从而重定位这些节")]),t._v(" "),a("li",[t._v("然后修改所有这些符号的引用，使得它们指向符号定义的内存位置")]),t._v(" "),a("li",[a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("链接器使用汇编器产生的重定位条目（relocation entry）的详细指令，不加甄别地执行这样的重定位。")])])])])])])]),t._v(" "),a("h2",{attrs:{id:"73-目标文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#73-目标文件"}},[t._v("#")]),t._v(" 7.3 目标文件")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("三种形式的目标文件")]),t._v(" "),a("ul",[a("li",[t._v("可重定位目标文件\n"),a("ul",[a("li",[t._v("包含二进制代码和数据，")]),t._v(" "),a("li",[t._v("其形式可以在编译时与其他可重定位目标文件合并起来，创建一个可执行目标文件")])])]),t._v(" "),a("li",[t._v("可执行目标文件\n"),a("ul",[a("li",[t._v("包含二进制代码和数据\n"),a("ul",[a("li",[t._v("其形式可以被直接复制到内存并执行")])])])])]),t._v(" "),a("li",[t._v("共享目标文件\n"),a("ul",[a("li",[t._v("一种特殊类型的可重定位目标文件，可以在加载或者运行时被动态地加载进内存并链接")])])])])]),t._v(" "),a("div",{staticClass:"custom-block note"},[a("p",{staticClass:"custom-block-title"},[t._v("目标文件的格式")]),t._v(" "),a("ul",[a("li",[t._v("现代 x86-64 Linux 和 Unix 系统使用"),a("strong",[t._v("可执行可链接格式")]),t._v("（Executable and Linkable Format，ELF）")])])]),t._v(" "),a("h2",{attrs:{id:"74-可重定位目标文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#74-可重定位目标文件"}},[t._v("#")]),t._v(" 7.4 可重定位目标文件")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("ELF 头与节头部表")]),t._v(" "),a("ul",[a("li",[t._v("ELF 头（ELF header）以一个 16 字节的序列开始\n"),a("ul",[a("li",[t._v("这个序列描述了生成该文件的系统的字的大小和字节顺序")])])]),t._v(" "),a("li",[t._v("ELF 头剩下的部分包含帮助链接器语法分析和解释目标文件的信息，包括\n"),a("ul",[a("li",[t._v("ELF 头的大小")]),t._v(" "),a("li",[t._v("目标文件的类型（如可重定位、可执行或者共享的）")]),t._v(" "),a("li",[t._v("机器类型（如 X86-64）")]),t._v(" "),a("li",[t._v("节头部表（section header table）的文件偏移\n"),a("ul",[a("li",[t._v("以及节头部表中条目的大小和数量")])])])])]),t._v(" "),a("li",[t._v("不同节的位置和大小是由节头部表描述的\n"),a("ul",[a("li",[t._v("目标文件中每个节在节头部表中都有一个固定大小的条目（entry）。")])])])])]),t._v(" "),a("div",{staticClass:"custom-block note"},[a("p",{staticClass:"custom-block-title"},[t._v("典型的 ELF 可重定位目标文件")]),t._v(" "),a("ul",[a("li",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220221163151-2022-02-21-16-31-51.png",alt:"20220221163151-2022-02-21-16-31-51"}})])])]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("节 (segment)")]),t._v(" "),a("ul",[a("li",[t._v("一个典型的 ELF 可重定位目标文件包含下面几个节\n"),a("ul",[a("li",[a("code",[t._v(".text")]),t._v(" "),a("ul",[a("li",[t._v("已编译程序的机器代码")])])]),t._v(" "),a("li",[a("code",[t._v(".rodata")]),t._v(" "),a("ul",[a("li",[t._v("只读数据\n"),a("ul",[a("li",[t._v("比如 "),a("code",[t._v("printf")]),t._v(" 语句中的格式串和开关语句的跳转表。")])])])])]),t._v(" "),a("li",[a("code",[t._v(".data")]),t._v(" "),a("ul",[a("li",[t._v("已初始化的全局和静态 C 变量")]),t._v(" "),a("li",[t._v("局部 C 变量在运行时被保存在栈中")])])]),t._v(" "),a("li",[a("code",[t._v(".bss")]),t._v(" "),a("ul",[a("li",[t._v("未初始化的全局和静态 C 变量，以及所有被初始化为 0 的全局或静态变量")]),t._v(" "),a("li",[t._v("在目标文件中这个节不占据实际的空间，它仅仅是一个占位符\n"),a("ul",[a("li",[a("div",{staticClass:"custom-block note"},[a("p",{staticClass:"custom-block-title"},[t._v("bss 可以理解为 better save space")])])])])]),t._v(" "),a("li",[a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("目标文件格式区分已初始化和未初始化变量是为了空间效率")]),t._v(" "),a("ul",[a("li",[t._v("在目标文件中，未初始化变量不需要占据任何实际的磁盘空间")]),t._v(" "),a("li",[t._v("运行时，在内存中分配这些变量，初始值为 0")])])])])])]),t._v(" "),a("li",[a("code",[t._v(".symtab")]),t._v(" "),a("ul",[a("li",[t._v("一个符号表，它存放在程序中定义和引用的函数和全局变量的信息")]),t._v(" "),a("li",[t._v("每个可重定位目标文件在 "),a("code",[t._v(".symtab")]),t._v(" 中都有一张符号表\n"),a("ul",[a("li",[t._v("除非程序员特意用 STRIP 命令去掉它")])])]),t._v(" "),a("li",[t._v("和编译器中的符号表不同，"),a("code",[t._v(".symtab")]),t._v(" 符号表不包含局部变量的条目")])])]),t._v(" "),a("li",[a("code",[t._v(".rel.text")]),t._v(" "),a("ul",[a("li",[t._v("一个 "),a("code",[t._v(".text")]),t._v(" 节中位置的列表")]),t._v(" "),a("li",[t._v("当链接器把这个目标文件和其他文件组合时，需要修改这些位置\n"),a("ul",[a("li",[t._v("一般而言，任何调用外部函数或者引用全局变量的指令都需要修改")]),t._v(" "),a("li",[t._v("另一方面，调用本地函数的指令则不需要修改")])])]),t._v(" "),a("li",[a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("可执行目标文件中并不需要重定位信息，因此通常省略")]),t._v(" "),a("ul",[a("li",[t._v("除非用户显式地指示链接器包含这些信息")])])])])])]),t._v(" "),a("li",[a("code",[t._v(".rel.data")]),t._v(" "),a("ul",[a("li",[t._v("被模块引用或定义的所有全局变量的重定位信息\n"),a("ul",[a("li",[t._v("一般而言，任何已初始化的全局变量，如果它的初始值是一个全局变量地址或者外部定义函数的地址，都需要被修改。")])])])])]),t._v(" "),a("li",[a("code",[t._v(".debug")]),t._v(" "),a("ul",[a("li",[t._v("一个调试符号表，其条目是\n"),a("ul",[a("li",[t._v("程序中定义的局部变量和类型定义")]),t._v(" "),a("li",[t._v("程序中定义和引用的全局变量")]),t._v(" "),a("li",[t._v("原始的 C 源文件")])])]),t._v(" "),a("li",[t._v("只有以 "),a("code",[t._v("-g")]),t._v(" 选项调用编译器驱动程序时，才会得到这张表")])])]),t._v(" "),a("li",[a("code",[t._v(".line")]),t._v(" "),a("ul",[a("li",[t._v("原始 C 源程序中的行号和 .text 节中机器指令之间的映射")]),t._v(" "),a("li",[t._v("只有以 "),a("code",[t._v("-g")]),t._v(" 选项调用编译器驱动程序时，才会得到这张表。")])])]),t._v(" "),a("li",[a("code",[t._v(".strtab")]),t._v(" "),a("ul",[a("li",[t._v("一个字符串表，其内容包括\n"),a("ul",[a("li",[a("code",[t._v(".symtab")]),t._v(" 和 "),a("code",[t._v(".debug")]),t._v(" 节中的符号表")]),t._v(" "),a("li",[t._v("节头部中的节名字")])])]),t._v(" "),a("li",[t._v("字符串表就是以 "),a("code",[t._v("null")]),t._v(" 结尾的字符串的序列")])])])])])])]),t._v(" "),a("h2",{attrs:{id:"75-符号和符号表"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#75-符号和符号表"}},[t._v("#")]),t._v(" 7.5 符号和符号表")]),t._v(" "),a("div",{staticClass:"custom-block note"},[a("p",{staticClass:"custom-block-title"},[t._v("每个可重定位目标模块 m 都有一个符号表 "),a("code",[t._v(".symtab")]),t._v("，它包含 m 定义和引用的符号的信息")])]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("在链接器的上下文中，有三种不同的符号")]),t._v(" "),a("ul",[a("li",[t._v("由模块 m 定义并能被其他模块引用的全局符号\n"),a("ul",[a("li",[t._v("全局链接器符号对应于非静态的 C 函数和全局变量")])])]),t._v(" "),a("li",[t._v("由其他模块定义并被模块 m 引用的全局符号\n"),a("ul",[a("li",[t._v("这些符号称为外部符号")]),t._v(" "),a("li",[t._v("对应于在其他模块中定义的非静态 C 函数和全局变量")])])]),t._v(" "),a("li",[t._v("只被模块 m 定义和引用的局部符号\n"),a("ul",[a("li",[t._v("它们对应于带 "),a("code",[t._v("static")]),t._v(" 属性的 C 函数和全局变量")]),t._v(" "),a("li",[t._v("这些符号在模块 m 中任何位置都可见，但是不能被其他模块引用")])])])])]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[a("code",[t._v(".symtab")]),t._v(" 节包含 ELF 符号表")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("这张符号表包含一个条目的数组，每个条目的格式如下")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typedef")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v("     name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* String table offset */")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),t._v("    type"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* Function or data (4 bits) */")]),t._v("\n          binding"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* Local or global (4 bits) */")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),t._v("    reserved"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* Unused */")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("short")]),t._v("   section"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* Section header index */")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),t._v("    value"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* Section offset or absolute address */")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),t._v("    size"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* Object size in bytes */")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" Elf64_Symbol"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br")])])]),t._v(" "),a("li",[a("p",[a("code",[t._v("name")]),t._v(" 是字符串表 ("),a("code",[t._v(".strtab")]),t._v(") 中的字节偏移")])]),t._v(" "),a("li",[a("p",[t._v("每个符号都被分配到目标文件的某个节，由 "),a("code",[t._v("section")]),t._v(" 字段表示")]),t._v(" "),a("ul",[a("li",[t._v("该字段也是一个到节头部表的索引")]),t._v(" "),a("li",[t._v("有三个特殊的伪节（pseudosection），它们在节头部表中是没有条目的\n"),a("ul",[a("li",[a("code",[t._v("ABS")]),t._v(" 代表不该被重定位的符号")]),t._v(" "),a("li",[a("code",[t._v("UNDEF")]),t._v(" 代表未定义的符号\n"),a("ul",[a("li",[t._v("也就是在本目标模块中引用，但是却在其他地方定义的符号")])])]),t._v(" "),a("li",[a("code",[t._v("COMMON")]),t._v(" 表示还未被分配位置的未初始化的数据目标\n"),a("ul",[a("li",[t._v("对于 "),a("code",[t._v("COMMON")]),t._v(" 符号\n"),a("ul",[a("li",[a("code",[t._v("value")]),t._v(" 字段给出对齐要求")]),t._v(" "),a("li",[t._v("而 "),a("code",[t._v("size")]),t._v(" 给出最小的大小")])])])])]),t._v(" "),a("li",[a("div",{staticClass:"custom-block note"},[a("p",{staticClass:"custom-block-title"},[t._v("只有可重定位目标文件中才有这些伪节，可执行目标文件中是没有的")])])]),t._v(" "),a("li",[a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[a("code",[t._v("COMMON")]),t._v(" 和 "),a("code",[t._v(".bss")]),t._v(" 的区别")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("COMMON")]),t._v(" "),a("ul",[a("li",[t._v("未初始化的全局变量")])])]),t._v(" "),a("li",[a("code",[t._v(".bss")]),t._v(" "),a("ul",[a("li",[t._v("未初始化的静态变量，以及初始化为 0 的全局或静态变量")])])])])])])])])])])])]),t._v(" "),a("div",{staticClass:"custom-block note"},[a("p",{staticClass:"custom-block-title"},[t._v("可以使用 "),a("code",[t._v("readelf")]),t._v(" 程序来查看目标文件的内容")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://www.geeksforgeeks.org/readelf-command-in-linux-with-examples/",target:"_blank",rel:"noopener noreferrer"}},[t._v("readelf 使用参考"),a("OutboundLink")],1)])])]),t._v(" "),a("h2",{attrs:{id:"76-符号解析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#76-符号解析"}},[t._v("#")]),t._v(" 7.6 符号解析")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("链接器解析符号引用的方法是将每个引用与它输入的可重定位目标文件的符号表中的一个确定的符号定义关联起来")])]),t._v(" "),a("div",{staticClass:"custom-block note"},[a("p",{staticClass:"custom-block-title"},[t._v("引用和定义在相同模块中的局部符号的解析")]),t._v(" "),a("ul",[a("li",[t._v("编译器只允许每个模块中每个局部符号有一个定义")]),t._v(" "),a("li",[t._v("静态局部变量也会有本地链接器符号\n"),a("ul",[a("li",[t._v("但编译器需要确保它们拥有唯一的名字")])])])])]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("全局符号的解析")]),t._v(" "),a("ul",[a("li",[t._v("当编译器遇到一个不是在当前模块中定义的符号（变量或函数名）时\n"),a("ul",[a("li",[t._v("编译器会假设该符号是在其他某个模块中定义的")]),t._v(" "),a("li",[t._v("其会生成一个链接器符号表条目，并把它交给链接器处理\n"),a("ul",[a("li",[t._v("如果链接器在它的任何输入模块中都找不到这个被引用符号的定义")]),t._v(" "),a("li",[t._v("链接器就输出一条（通常很难阅读的）错误信息并终止")])])])])]),t._v(" "),a("li",[t._v("多个目标文件可能会定义相同名字的全局符号\n"),a("ul",[a("li",[t._v("这种情况下，链接器可以标志一个错误\n"),a("ul",[a("li",[t._v("gcc 中使用 "),a("code",[t._v("-fno-common")]),t._v(" 的标志告诉链接器\n"),a("ul",[a("li",[t._v("在遇到多重定义的全局符号时，触发一个错误")])])]),t._v(" "),a("li",[a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("最新版的 gcc 会直接报错")]),t._v(" "),a("ul",[a("li",[t._v("可以使用 "),a("code",[t._v("-fcommon")]),t._v(" 来达到书中的效果")])])])])])]),t._v(" "),a("li",[t._v("也可以以某种方法选出一个定义并抛弃其他定义\n"),a("ul",[a("li",[t._v("参见 "),a("a",{attrs:{href:"#761-%E9%93%BE%E6%8E%A5%E5%99%A8%E5%A6%82%E4%BD%95%E8%A7%A3%E6%9E%90%E5%A4%9A%E9%87%8D%E5%AE%9A%E4%B9%89%E7%9A%84%E5%85%A8%E5%B1%80%E7%AC%A6%E5%8F%B7"}},[t._v("7.6.1 链接器如何解析多重定义的全局符号")])])])])])])])]),t._v(" "),a("h3",{attrs:{id:"761-链接器如何解析多重定义的全局符号"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#761-链接器如何解析多重定义的全局符号"}},[t._v("#")]),t._v(" 7.6.1 链接器如何解析多重定义的全局符号")]),t._v(" "),a("div",{staticClass:"custom-block note"},[a("p",{staticClass:"custom-block-title"},[t._v("强符号与弱符号")]),t._v(" "),a("ul",[a("li",[t._v("在编译时，编译器向汇编器输岀每个全局符号，或者是强（strong）或者是弱（weak\n"),a("ul",[a("li",[t._v("汇编器把这个信息隐含地编码在可重定位目标文件的符号表里")])])]),t._v(" "),a("li",[t._v("函数和已初始化的全局变量是"),a("strong",[t._v("强符号")])]),t._v(" "),a("li",[t._v("未初始化的全局变量是"),a("strong",[t._v("弱符号")])])])]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("Linux 链接器处理多重定义的符号名的规则")]),t._v(" "),a("ul",[a("li",[t._v("规则 1：不允许有多个同名的强符号")]),t._v(" "),a("li",[t._v("规则 2：如果有一个强符号和多个弱符号同名，那么选择强符号")]),t._v(" "),a("li",[t._v("规则 3：如果有多个弱符号同名，那么从这些弱符号中任意选择一个")])])]),t._v(" "),a("h3",{attrs:{id:"762-与静态库链接"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#762-与静态库链接"}},[t._v("#")]),t._v(" 7.6.2 与静态库链接")]),t._v(" "),a("div",{staticClass:"custom-block note"},[a("p",{staticClass:"custom-block-title"},[t._v("静态库")]),t._v(" "),a("ul",[a("li",[t._v("将所有相关的目标模块打包成为一个单独的文件，称为静态库\n"),a("ul",[a("li",[t._v("可以用做链接器的输入\n"),a("ul",[a("li",[t._v("当链接器构造一个输出的可执行文件时，它只复制静态库里被应用程序引用的目标模块")])])])])]),t._v(" "),a("li",[t._v("在 Linux 系统中，静态库以一种称为"),a("strong",[t._v("存档")]),t._v("（archive）的特殊文件格式存放在磁盘中\n"),a("ul",[a("li",[t._v("存档文件是一组连接起来的可重定位目标文件的集合\n"),a("ul",[a("li",[t._v("有一个头部用来描述每个成员目标文件的大小和位置")])])]),t._v(" "),a("li",[t._v("存档文件名由后缀 .a 标识。")])])])])]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("与静态库链接的示例")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("创建静态库")]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("linux"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" gcc -c addvec.c multvec.c\nlinux"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" ar rcs libvector.a addvec.o multvec.o \n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])])]),t._v(" "),a("li",[a("p",[t._v("编译时使用静态库")]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("linux"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("gcc -c main2.c\nlinux"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("gcc -static -o prog2c main2.o ./libvector.a\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("ul",[a("li",[t._v("或等价的使用")])]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("linux"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("gcc -c main2.c\nlinux"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("gcc -static -o prog2c main2.o -L. -lvector\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("ul",[a("li",[a("code",[t._v("-static")]),t._v(" 参数告诉编译器驱动程序，链接器应该构建一个完全链接的可执行目标文件")]),t._v(" "),a("li",[a("code",[t._v("-lvector")]),t._v(" 参数是 "),a("code",[t._v("libvector.a")]),t._v(" 的缩写")]),t._v(" "),a("li",[a("code",[t._v("L.")]),t._v(" 告诉链接器首先在当前目录下查找 "),a("code",[t._v("libvector.a")])])])]),t._v(" "),a("li",[a("p",[t._v("与静态库链接的过程")]),t._v(" "),a("ul",[a("li",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220221184603-2022-02-21-18-46-03.png",alt:"20220221184603-2022-02-21-18-46-03"}})])])])])]),t._v(" "),a("h3",{attrs:{id:"763-链接器如何使用静态库来解析引用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#763-链接器如何使用静态库来解析引用"}},[t._v("#")]),t._v(" 7.6.3 链接器如何使用静态库来解析引用")]),t._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[t._v("命令行上的库和目标文件的顺序非常重要。在命令行中，如果定义一个符号的库出现在引用这个符号的目标文件之前，那么引用就不能被解析，链接会失败")]),t._v(" "),a("ul",[a("li",[t._v("其逻辑是从左到右扫描命令行，逐个处理指定的库，处理完该库后其会丢掉该库中当前未被引用的内容")])])]),t._v(" "),a("h2",{attrs:{id:"77-重定位"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#77-重定位"}},[t._v("#")]),t._v(" 7.7 重定位")]),t._v(" "),a("div",{staticClass:"custom-block note"},[a("p",{staticClass:"custom-block-title"},[t._v("符号解析的作用")]),t._v(" "),a("ul",[a("li",[t._v("链接器完成了符号解析后，就将代码中的每个符号引用正好和一个符号定义（即它的一个输入目标模块中的一个符号表条目）关联起来")]),t._v(" "),a("li",[t._v("此时，链接器也知道了它的输入目标模块中的代码节和数据节的确切大小\n"),a("ul",[a("li",[t._v("现在，就可以开始重定位步骤")])])])])]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("重定位的两个步骤")]),t._v(" "),a("ul",[a("li",[t._v("重定位节和符号定义\n"),a("ul",[a("li",[t._v("在这一步中，链接器将所有相同类型的节合并为同一类型的新的聚合节\n"),a("ul",[a("li",[t._v("例如，来自所有输入模块的 "),a("code",[t._v(".data")]),t._v(" 节被全部合并成一个节，这个节成为输出的可执行目标文件的 "),a("code",[t._v(".data")]),t._v(" 节")])])]),t._v(" "),a("li",[t._v("然后，链接器将运行时内存地址赋给新的聚合节，赋给输入模块定义的每个节，以及赋给输入模块定义的每个符号\n"),a("ul",[a("li",[t._v("当这一步完成时，程序中的每条指令和全局变量都有唯一的运行时内存地址了")])])])])]),t._v(" "),a("li",[t._v("重定位节中的符号引用\n"),a("ul",[a("li",[t._v("在这一步中，链接器修改代码节和数据节中对每个符号的引用，使得它们指向正确的运行时地址")]),t._v(" "),a("li",[t._v("要执行这一步，链接器依赖于可重定位目标模块中称为 "),a("a",{attrs:{href:"#771-%E9%87%8D%E5%AE%9A%E4%BD%8D%E6%9D%A1%E7%9B%AE"}},[t._v("重定位条目")]),t._v("（relocation entry）的数据结构")])])])])]),t._v(" "),a("h3",{attrs:{id:"771-重定位条目"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#771-重定位条目"}},[t._v("#")]),t._v(" 7.7.1 重定位条目")]),t._v(" "),a("div",{staticClass:"custom-block note"},[a("p",{staticClass:"custom-block-title"},[t._v("无论何时汇编器遇到对最终位置未知的目标引用，它就会生成一个重定位条目")]),t._v(" "),a("ul",[a("li",[t._v("这个条目会告诉链接器在将目标文件合并成可执行文件时如何修改这个引用")]),t._v(" "),a("li",[t._v("代码的重定位条目放在 "),a("code",[t._v(".rel.text")]),t._v(" 中。已初始化数据的重定位条目放在 "),a("code",[t._v(".rel.data")]),t._v(" 中")])])]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("ELF 重定位条目")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typedef")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),t._v(" offset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* Offset of the reference to relocate */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),t._v(" type"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* Relocation type */")]),t._v("\n         symbol"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* Symbol table index */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),t._v(" addend"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* Constant part of relocation expression */")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" Elf64_Rela"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br")])])]),t._v(" "),a("div",{staticClass:"custom-block note"},[a("p",{staticClass:"custom-block-title"},[t._v("ELF 重定位类型")]),t._v(" "),a("ul",[a("li",[t._v("ELF 定义了 32 种不同的重定位类型，其中有两种最基本的重定位类型")]),t._v(" "),a("li",[a("code",[t._v("R_X86_64_PC32")]),t._v(" "),a("ul",[a("li",[t._v("重定位一个使用 32 位 PC 相对地址的引用\n"),a("ul",[a("li",[t._v("一个 PC 相对地址就是距程序计数器（PC）的当前运行时值的偏移量")]),t._v(" "),a("li",[t._v("当 CPU 执行一条使用 PC 相对寻址的指令时\n"),a("ul",[a("li",[t._v("它就将在指令中编码的 32 位值加上 PC 的当前运行时值，得到有效地址（如 call 指令的目标）")])])]),t._v(" "),a("li",[t._v("PC 值通常是下一条指令在内存中的地址")]),t._v(" "),a("li",[t._v("参考 "),a("RouterLink",{attrs:{to:"/pages/306a79/#364-跳转指令的编码"}},[t._v("跳转指令的编码")])],1)])])])]),t._v(" "),a("li",[a("code",[t._v("R_X86_64_32")]),t._v(" "),a("ul",[a("li",[t._v("重定位一个使用 32 位绝对地址的引用")]),t._v(" "),a("li",[t._v("通过绝对寻址，CPU 直接使用在指令中编码的 32 位值作为有效地址，不需要进一步修改")])])]),t._v(" "),a("li",[a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("这两种重定位类型支持 x86-64 小型代码模型（small code model")]),t._v(" "),a("ul",[a("li",[t._v("该模型假设可执行目标文件中的代码和数据的总体大小小于 2GB\n"),a("ul",[a("li",[t._v("因此在运行时可以用 32 位 PC 相对地址来访问")])])]),t._v(" "),a("li",[t._v("GCC 默认使用小型代码模型")]),t._v(" "),a("li",[t._v("大于 2GB 的程序可以用 "),a("code",[t._v("-mcmodel=medium")]),t._v("（中型代码模型）和 "),a("code",[t._v("-mcmodel=large")]),t._v("（大型代码模型）标志来编译")])])])])])]),t._v(" "),a("h3",{attrs:{id:"772-重定位符号引用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#772-重定位符号引用"}},[t._v("#")]),t._v(" 7.7.2 重定位符号引用")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("重定位算法")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[t._v("foreach section s "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    foreach relocation entry r "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        refptr "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" s "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("offset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* ptr to reference to be relocated */")]),t._v("\n    \n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* Relocate a PC-relative reference */")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" R_X86_64_PC32"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            refaddr "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ADDR")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("offset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* ref's run-time address */")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("refptr "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ADDR")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("symbol"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("addend "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" refaddr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* Relocate an absolute reference */")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v("R_X86_64_32"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("refptr "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ADDR")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("symbol"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("addend"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br")])]),a("ul",[a("li",[t._v("本质上是填充指令中的地址字节")]),t._v(" "),a("li",[t._v("当使用相对寻址时， "),a("code",[t._v("addend")]),t._v(" 相当于地址所占用的字节数，从而计算相对于下一条指令的偏移值")])])]),t._v(" "),a("h2",{attrs:{id:"78-可执行目标文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#78-可执行目标文件"}},[t._v("#")]),t._v(" 7.8 可执行目标文件")]),t._v(" "),a("div",{staticClass:"custom-block note"},[a("p",{staticClass:"custom-block-title"},[t._v("典型的 ELF 可执行目标文件")]),t._v(" "),a("ul",[a("li",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220222165725-2022-02-22-16-57-25.png",alt:"20220222165725-2022-02-22-16-57-25"}}),t._v(" "),a("ul",[a("li",[t._v("ELF 头描述文件的总体格式\n"),a("ul",[a("li",[t._v("它包括程序的入口点（entry point\n"),a("ul",[a("li",[t._v("即程序运行时要执行的第一条指令的地址")])])])])]),t._v(" "),a("li",[a("code",[t._v(".text")]),t._v("、"),a("code",[t._v(".rodata")]),t._v(" 和 "),a("code",[t._v(".data")]),t._v(" 节与可重定位目标文件中的节是相似的\n"),a("ul",[a("li",[t._v("除了这些节已经被重定位到它们最终的运行时内存地址以外")])])]),t._v(" "),a("li",[a("code",[t._v(".init")]),t._v(" 节定义了一个小函数，叫做 "),a("code",[t._v("_init")]),t._v(" "),a("ul",[a("li",[t._v("程序的初始化代码会调用它")])])]),t._v(" "),a("li",[t._v("因为可执行文件是完全链接的（已被重定位），所以它不再需要 "),a("code",[t._v(".rel")]),t._v(" 节")])])])])]),t._v(" "),a("h2",{attrs:{id:"79-加载可执行目标文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#79-加载可执行目标文件"}},[t._v("#")]),t._v(" 7.9 加载可执行目标文件")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("Linux x86-64 运行时内存映像")]),t._v(" "),a("ul",[a("li",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220222171229-2022-02-22-17-12-29.png",alt:"20220222171229-2022-02-22-17-12-29"}}),t._v(" "),a("ul",[a("li",[t._v("代码段总是从地址 "),a("code",[t._v("0x400000")]),t._v(" 处开始")]),t._v(" "),a("li",[t._v("后面是数据段")]),t._v(" "),a("li",[t._v("运行时堆在数据段之后，通过调用 malloc 库往上增长")]),t._v(" "),a("li",[t._v("堆后面的区域是为共享库保留的")]),t._v(" "),a("li",[t._v("用户栈总是从最大的合法用户地址（"),a("mjx-container",{staticClass:"MathJax",attrs:{jax:"SVG"}},[a("svg",{staticStyle:{"vertical-align":"0"},attrs:{xmlns:"http://www.w3.org/2000/svg",width:"2.919ex",height:"1.904ex",role:"img",focusable:"false",viewBox:"0 -841.7 1290.1 841.7","xmlns:xlink":"http://www.w3.org/1999/xlink"}},[a("defs",[a("path",{attrs:{id:"MJX-1219-TEX-N-32",d:"M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"}}),a("path",{attrs:{id:"MJX-1219-TEX-N-34",d:"M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"}}),a("path",{attrs:{id:"MJX-1219-TEX-N-38",d:"M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z"}})]),a("g",{attrs:{stroke:"currentColor",fill:"currentColor","stroke-width":"0",transform:"scale(1,-1)"}},[a("g",{attrs:{"data-mml-node":"math"}},[a("g",{attrs:{"data-mml-node":"msup"}},[a("g",{attrs:{"data-mml-node":"mn"}},[a("use",{attrs:{"data-c":"32","xlink:href":"#MJX-1219-TEX-N-32"}})]),a("g",{attrs:{"data-mml-node":"TeXAtom",transform:"translate(533,363) scale(0.707)","data-mjx-texclass":"ORD"}},[a("g",{attrs:{"data-mml-node":"mn"}},[a("use",{attrs:{"data-c":"34","xlink:href":"#MJX-1219-TEX-N-34"}}),a("use",{attrs:{"data-c":"38","xlink:href":"#MJX-1219-TEX-N-38",transform:"translate(500,0)"}})])])])])])])]),t._v("）开始，向较小内存地址增长")],1),t._v(" "),a("li",[t._v("栈上的区域，从地址("),a("mjx-container",{staticClass:"MathJax",attrs:{jax:"SVG"}},[a("svg",{staticStyle:{"vertical-align":"0"},attrs:{xmlns:"http://www.w3.org/2000/svg",width:"2.919ex",height:"1.904ex",role:"img",focusable:"false",viewBox:"0 -841.7 1290.1 841.7","xmlns:xlink":"http://www.w3.org/1999/xlink"}},[a("defs",[a("path",{attrs:{id:"MJX-1219-TEX-N-32",d:"M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"}}),a("path",{attrs:{id:"MJX-1219-TEX-N-34",d:"M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"}}),a("path",{attrs:{id:"MJX-1219-TEX-N-38",d:"M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z"}})]),a("g",{attrs:{stroke:"currentColor",fill:"currentColor","stroke-width":"0",transform:"scale(1,-1)"}},[a("g",{attrs:{"data-mml-node":"math"}},[a("g",{attrs:{"data-mml-node":"msup"}},[a("g",{attrs:{"data-mml-node":"mn"}},[a("use",{attrs:{"data-c":"32","xlink:href":"#MJX-1219-TEX-N-32"}})]),a("g",{attrs:{"data-mml-node":"TeXAtom",transform:"translate(533,363) scale(0.707)","data-mjx-texclass":"ORD"}},[a("g",{attrs:{"data-mml-node":"mn"}},[a("use",{attrs:{"data-c":"34","xlink:href":"#MJX-1219-TEX-N-34"}}),a("use",{attrs:{"data-c":"38","xlink:href":"#MJX-1219-TEX-N-38",transform:"translate(500,0)"}})])])])])])])]),t._v(")开始，是为内核（kernel）中的代码和数据保留的\n"),a("ul",[a("li",[t._v("所谓内核就是操作系统驻留在内存的部分")])])],1)])])])]),t._v(" "),a("h2",{attrs:{id:"710-动态链接共享库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#710-动态链接共享库"}},[t._v("#")]),t._v(" 7.10 动态链接共享库")]),t._v(" "),a("div",{staticClass:"custom-block note"},[a("p",{staticClass:"custom-block-title"},[t._v("静态库的缺点")]),t._v(" "),a("ul",[a("li",[t._v("静态库更新后，程序员必须显式地将他们的程序与更新了的库重新链接")]),t._v(" "),a("li",[t._v("另一个问题是几乎每个 C 程序都使用标准 I/O 函数，比如 printf 和 scanf\n"),a("ul",[a("li",[t._v("在运行时，这些函数的代码会被复制到每个运行进程的文本段中")]),t._v(" "),a("li",[t._v("在一个运行上百个进程的典型系统上，这将是对稀缺的内存系统资源的极大浪费")])])])])]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("共享库与动态链接")]),t._v(" "),a("ul",[a("li",[t._v("共享库（shared library）是致力于解决静态库缺陷的一个现代创新产物")]),t._v(" "),a("li",[t._v("共享库是一个目标模块，在运行或加载时，可以加载到任意的内存地址，并和一个在内存中的程序链接起来\n"),a("ul",[a("li",[t._v("这个过程称为动态链接（dynamic linking），是由一个叫做动态链接器（dynamic linker）的程序来执行的")])])]),t._v(" "),a("li",[t._v("共享库也称为共享目标（shared object）\n"),a("ul",[a("li",[t._v("在 Linux 系统中通常用 "),a("code",[t._v(".so")]),t._v(" 后缀来表示")]),t._v(" "),a("li",[t._v("微软的操作系统大量地使用了共享库，它们称为 "),a("code",[t._v("DLL")]),t._v("（动态链接库）")])])]),t._v(" "),a("li",[a("div",{staticClass:"custom-block note"},[a("p",{staticClass:"custom-block-title"},[t._v("共享库的优点")]),t._v(" "),a("ul",[a("li",[t._v("在任何给定的文件系统中，对于一个库只有一个 "),a("code",[t._v(".so")]),t._v(" 文件")]),t._v(" "),a("li",[t._v("所有引用该库的可执行目标文件共享这个 "),a("code",[t._v(".so")]),t._v(" 文件中的代码和数据\n"),a("ul",[a("li",[t._v("而不是像静态库的内容那样被复制和嵌入到引用它们的可执行的文件中")]),t._v(" "),a("li",[t._v("如此，可以节约磁盘空间")])])]),t._v(" "),a("li",[t._v("在内存中，一个共享库的 "),a("code",[t._v(".text")]),t._v(" 节的一个副本可以被不同的正在运行的进程共享\n"),a("ul",[a("li",[t._v("主要通过动态链接和虚拟内存来实现")])])])])])])])]),t._v(" "),a("div",{staticClass:"custom-block note"},[a("p",{staticClass:"custom-block-title"},[t._v("生成与使用共享库")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("生成共享库")]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("linux"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" gcc -shared -fpic -o libvector.so addvec.c multvec.c\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("ul",[a("li",[t._v("-fpic 选项指示编译器生成"),a("a",{attrs:{href:"#712-%E4%BD%8D%E7%BD%AE%E6%97%A0%E5%85%B3%E4%BB%A3%E7%A0%81"}},[t._v("与位置无关的代码")])])])]),t._v(" "),a("li",[a("p",[t._v("编译时使用共享库")]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("linux"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" gcc -o prog2l main2.c ./libvector.so\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("ul",[a("li",[t._v("此时生成的 "),a("code",[t._v("prog2l")]),t._v(" 包含一个 "),a("code",[t._v(".interp")]),t._v(" 节\n"),a("ul",[a("li",[t._v("这一节包含动态链接器的路径名")]),t._v(" "),a("li",[t._v("动态链接器本身就是一个共享目标（如在 Linux 系统上的 "),a("code",[t._v("ld-linux.so")]),t._v("）")])])])])]),t._v(" "),a("li",[a("p",[t._v("动态链接的过程")]),t._v(" "),a("ul",[a("li",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220222172722-2022-02-22-17-27-23.png",alt:"20220222172722-2022-02-22-17-27-23"}})]),t._v(" "),a("li",[t._v("加载器加载部分链接的可执行文件 prog2l")]),t._v(" "),a("li",[t._v("接着，它注意到 prog2l 包含一个 "),a("code",[t._v(".interp 节")]),t._v(" "),a("ul",[a("li",[t._v("这一节包含动态链接器的路径名")])])]),t._v(" "),a("li",[t._v("加载器不会像它通常所做地那样将控制传递给应用，而是加载和运行动态链接器")]),t._v(" "),a("li",[t._v("然后，动态链接器通过执行下面的重定位完成链接任务\n"),a("ul",[a("li",[t._v("重定位 "),a("code",[t._v("libc.so")]),t._v(" 的文本和数据到某个内存段")]),t._v(" "),a("li",[t._v("重定位 "),a("code",[t._v("libvector.so")]),t._v(" 的文本和数据到另一个内存段")]),t._v(" "),a("li",[t._v("重定位 prog2l 中所有对由 "),a("code",[t._v("libc.so")]),t._v(" 和 "),a("code",[t._v("libvector.so")]),t._v(" 定义的符号的引用")])])]),t._v(" "),a("li",[t._v("最后，动态链接器将控制传递给应用程序\n"),a("ul",[a("li",[t._v("从这个时刻开始，共享库的位置就固定了，并且在程序执行的过程中都不会改变")])])])])])])]),t._v(" "),a("h2",{attrs:{id:"711-从应用程序中加载和链接共享库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#711-从应用程序中加载和链接共享库"}},[t._v("#")]),t._v(" 7.11 从应用程序中加载和链接共享库")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("Linux 系统为动态链接器提供了一个简单的接口，允许应用程序在运行时加载和链接共享库")]),t._v(" "),a("ul",[a("li",[t._v("使用此类函数时，用 gcc 编译时，需要加上 "),a("code",[t._v("-ldl")]),t._v(" 参数")])])]),t._v(" "),a("div",{staticClass:"custom-block note"},[a("p",{staticClass:"custom-block-title"},[a("code",[t._v("dlopen")]),t._v(" 函数")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("include")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("<dlfcn.h>")])]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dlopen")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" flag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 返回：若成功则为指向句柄的指针，若出错则为 NULL。")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("ul",[a("li",[a("code",[t._v("dlopen")]),t._v(" 函数加载和链接共享库 filename\n"),a("ul",[a("li",[t._v("用已用带 "),a("code",[t._v("RTLD_GLOBAL")]),t._v(" 选项打开了的库解析 "),a("code",[t._v("filename")]),t._v(" 中的外部符号")]),t._v(" "),a("li",[t._v("如果当前可执行文件是带 "),a("code",[t._v("-rdynamic")]),t._v(" 选项编译的\n"),a("ul",[a("li",[t._v("那么对符号解析而言，它的全局符号也是可用的")])])]),t._v(" "),a("li",[t._v("flag 参数\n"),a("ul",[a("li",[t._v("必须要么包括 "),a("code",[t._v("RTLD_NOW")]),t._v(" "),a("ul",[a("li",[t._v("该标志告诉链接器立即解析对外部符号的引用")])])]),t._v(" "),a("li",[t._v("要么包括 "),a("code",[t._v("RTLD_LAZY")]),t._v(" 标志\n"),a("ul",[a("li",[t._v("该标志指示链接器推迟符号解析直到执行来自库中的代码")])])]),t._v(" "),a("li",[t._v("这两个值中的任意一个都可以和 "),a("code",[t._v("RTLD_GLOBAL")]),t._v(" 标志取或")])])])])])])]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[a("code",[t._v("dlsym")]),t._v(" 函数")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("include")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("<dlfcn.h>")])]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dlsym")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("handle"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("symbol"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 返回：若成功则为指向符号的指针，若出错则为 NULL。")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("ul",[a("li",[a("code",[t._v("dlsym")]),t._v(" 函数的输入是一个指向前面已经打开了的共享库的句柄和一个 "),a("code",[t._v("symbol")]),t._v(" 名字\n"),a("ul",[a("li",[t._v("如果该符号存在，就返回符号的地址，否则返回 "),a("code",[t._v("NULL")])])])])])]),t._v(" "),a("div",{staticClass:"custom-block note"},[a("p",{staticClass:"custom-block-title"},[a("code",[t._v("dlclose")])]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("include")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("<dlfcn.h>")])]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dlclose")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("handle"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 返回:若成功则为0，若出错则为-1.")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("ul",[a("li",[t._v("如果没有其他共享库还在使用这个共享库，"),a("code",[t._v("dlclose")]),t._v(" 函数就卸载该共享库")])])]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[a("code",[t._v("dlerror")]),t._v(" 函数")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[t._v("include "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("dlfcn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("h"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dlerror")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 返回：如果前面对 dlopen、dlsym 或 dlclose 的调用失败，")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 则为错误消息，如果前面的调用成功，则为 NULL。")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br")])]),a("ul",[a("li",[a("code",[t._v("dlerror")]),t._v(" 函数返回一个字符串")]),t._v(" "),a("li",[t._v("它描述的是调用 "),a("code",[t._v("dlopen")]),t._v("、"),a("code",[t._v("dlsym")]),t._v(" 或者 "),a("code",[t._v("dlclose")]),t._v(" 函数时发生的最近的错误\n"),a("ul",[a("li",[t._v("如果没有错误发生，就返回 "),a("code",[t._v("NULL")])])])])])]),t._v(" "),a("details",{staticClass:"custom-block details"},[a("summary",[t._v("使用示例")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("include")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("<stdio.h>")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("include")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("<stdlib.h>")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("include")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("<dlfcn.h>")])]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" x"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" y"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" z"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("handle"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("addvec"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* Dynamically load the shared library containing addvec() */")]),t._v("\n    handle "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dlopen")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"./libvector.so"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" RTLD_LAZY"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("handle"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fprintf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("stderr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"%s\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dlerror")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("exit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* Get a pointer to the addvec() function we just loaded */")]),t._v("\n    addvec "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dlsym")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("handle"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"addvec"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("error "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dlerror")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fprintf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("stderr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"%s\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("exit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* Now we can call addvec() just like any other function */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("addvec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("x"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" y"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" z"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("printf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"z = [%d %d]\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" z"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" z"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* Unload the shared library */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dlclose")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("handle"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fprintf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("stderr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"%s\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dlerror")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("exit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br"),a("span",{staticClass:"line-number"},[t._v("35")]),a("br"),a("span",{staticClass:"line-number"},[t._v("36")]),a("br"),a("span",{staticClass:"line-number"},[t._v("37")]),a("br"),a("span",{staticClass:"line-number"},[t._v("38")]),a("br"),a("span",{staticClass:"line-number"},[t._v("39")]),a("br")])]),a("ul",[a("li",[a("p",[t._v("编译命令")]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("linux"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" gcc -rdynamic -o prog2r dll.c -ldl\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])])])])]),t._v(" "),a("h2",{attrs:{id:"712-位置无关代码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#712-位置无关代码"}},[t._v("#")]),t._v(" 7.12 位置无关代码")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("位置无关代码")]),t._v(" "),a("ul",[a("li",[t._v("可以加载而无需重定位的代码称为位置无关代码（Position-Independent Code，"),a("strong",[t._v("PIC")]),t._v(" "),a("ul",[a("li",[t._v("用户对 GCC 使用 "),a("code",[t._v("-fpic")]),t._v(" 选项指示 GNU 编译系统生成 PIC 代码")]),t._v(" "),a("li",[t._v("共享库的编译必须总是使用该选项")])])]),t._v(" "),a("li",[t._v("这种方法使得共享库可以加载到内存的任何位置而无需链接器进行修改\n"),a("ul",[a("li",[t._v("从而可以允许无限多个进程可以共享一个共享模块的代码段的单一副本\n"),a("ul",[a("li",[t._v("当然，每个进程仍然会有它自己独有读/写数据块")])])])])])])]),t._v(" "),a("div",{staticClass:"custom-block note"},[a("p",{staticClass:"custom-block-title"},[t._v("PIC 数据引用")]),t._v(" "),a("ul",[a("li",[a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[t._v("只是数据的引用，不包括对函数的引用")])])]),t._v(" "),a("li",[t._v("编译器通过运用以下事实来生成对全局变量的 PIC 引用\n"),a("ul",[a("li",[t._v("无论在内存中的何处加载一个目标模块（包括共享目标模块）\n"),a("ul",[a("li",[t._v("数据段与代码段的距离总是保持不变")])])]),t._v(" "),a("li",[t._v("因此，代码段中任何指令和数据段中任何变量之间的距离都是一个运行时常量\n"),a("ul",[a("li",[t._v("这与代码段和数据段的绝对内存位置是无关的")])])])])]),t._v(" "),a("li",[t._v("编译器在数据段开始的地方创建了一个全局偏移量表（Global Offset Table，"),a("strong",[t._v("GOT")]),t._v("）\n"),a("ul",[a("li",[t._v("在 GOT 中，每个被这个目标模块引用的全局数据目标（过程或全局变量）都有一个 8 字节条目")]),t._v(" "),a("li",[t._v("编译器还为 GOT 中每个条目生成一个重定位记录\n"),a("ul",[a("li",[t._v("在加载时，动态链接器会重定位 GOT 中的每个条目，使得它包含目标的正确的绝对地址")])])]),t._v(" "),a("li",[t._v("每个引用全局目标的目标模块都有自己的 GOT\n"),a("ul",[a("li",[t._v("编译器使用 GOT 进行所有的全局变量引用")])])])])]),t._v(" "),a("li",[a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("在程序运行前，即完成了 GOT 中全局变量(不含函数) 条目的更新")])])]),t._v(" "),a("li",[a("details",{staticClass:"custom-block details"},[a("summary",[t._v("示例")]),t._v(" "),a("ul",[a("li",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220222184625-2022-02-22-18-46-25.png",alt:"20220222184625-2022-02-22-18-46-25"}})])])])])])]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("PIC 函数调用")]),t._v(" "),a("ul",[a("li",[t._v("GNU 编译系统中 PIC 的函数调用使用了 "),a("strong",[t._v("延迟绑定")]),t._v(" (lazy binding) 的技术\n"),a("ul",[a("li",[t._v("将过程地址的绑定推迟到第一次调用该过程时")]),t._v(" "),a("li",[t._v("把函数地址的解析推迟到它实际被调用的地方，能避免动态链接器在加载时进行成百上千个其实并不需要的重定位")]),t._v(" "),a("li",[t._v("第一次调用过程的运行时开销很大，但是其后的每次调用都只会花费一条指令和一个间接的内存引用")])])]),t._v(" "),a("li",[t._v("延迟绑定通过 GOT 和过程链接表 (Procedure Linkage Table， PLT) 这两个数据结构的交互来实现")])])]),t._v(" "),a("h2",{attrs:{id:"713-库打桩机制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#713-库打桩机制"}},[t._v("#")]),t._v(" 7.13 库打桩机制")]),t._v(" "),a("div",{staticClass:"custom-block note"},[a("p",{staticClass:"custom-block-title"},[t._v("库打桩技术")]),t._v(" "),a("ul",[a("li",[t._v("库打桩（library interpositioning），允许截获对共享库函数的调用，取而代之执行自定义的代码\n"),a("ul",[a("li",[t._v("使用打桩机制\n"),a("ul",[a("li",[t._v("可以追踪对某个特殊库函数的调用次数")]),t._v(" "),a("li",[t._v("验证和追踪它的输入和输出值")]),t._v(" "),a("li",[t._v("或者甚至把它替换成一个完全不同的实现")])])])])]),t._v(" "),a("li",[t._v("基本思想\n"),a("ul",[a("li",[t._v("给定一个需要打桩的目标函数，创建一个包装函数，它的原型与目标函数完全一样")]),t._v(" "),a("li",[t._v("使用某种特殊的打桩机制，欺骗系统调用包装函数而不是目标函数")]),t._v(" "),a("li",[a("strong",[t._v("包装函数")]),t._v(" "),a("ul",[a("li",[t._v("通常会执行它自己的逻辑")]),t._v(" "),a("li",[t._v("然后调用目标函数")]),t._v(" "),a("li",[t._v("再将目标函数的返回值传递给调用者")])])])])])])]),t._v(" "),a("h3",{attrs:{id:"7131-编译时打桩"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#7131-编译时打桩"}},[t._v("#")]),t._v(" 7.13.1 编译时打桩")]),t._v(" "),a("div",{staticClass:"custom-block note"},[a("p",{staticClass:"custom-block-title"},[t._v("通过宏定义将目标函数替换为包装函数")]),t._v(" "),a("ul",[a("li",[t._v("编译时使用 "),a("code",[t._v("-I.")]),t._v(" 参数让 C 预处理器在搜索通常的系统目录之前\n"),a("ul",[a("li",[t._v("先在当前目录中查找 "),a("code",[t._v("malloc.h")])]),t._v(" "),a("li",[t._v("从而将源文件中定义的目标函数替换为包装函数")])])])])]),t._v(" "),a("h3",{attrs:{id:"7132-链接时打桩"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#7132-链接时打桩"}},[t._v("#")]),t._v(" 7.13.2 链接时打桩")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("静态链接器使用 "),a("code",[t._v("--wrap f")]),t._v(" 标志进行链接时打桩")]),t._v(" "),a("ul",[a("li",[t._v("其会把对符号 "),a("code",[t._v("f")]),t._v(" 的引用解析为 "),a("code",[t._v("__wrap_f")])]),t._v(" "),a("li",[t._v("还把对符号 "),a("code",[t._v("__real_f")]),t._v(" 的引用解析为 "),a("code",[t._v("f")])]),t._v(" "),a("li",[t._v("gcc 中可以使用 "),a("code",[t._v("-Wl,option")]),t._v(" 标志把 "),a("code",[t._v("option")]),t._v(" 传递给链接器\n"),a("ul",[a("li",[a("p",[a("code",[t._v("option")]),t._v(" 中的每个逗号都要替换为一个空格")])]),t._v(" "),a("li",[a("p",[t._v("所以 "),a("code",[t._v("-Wl,--wrap,malloc")]),t._v(" 就把 "),a("code",[t._v("--wrap malloc")]),t._v(" 传递给链接器")])]),t._v(" "),a("li",[a("p",[t._v("示例")]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("linux"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" gcc -Wl,--wrap,malloc -Wl,--wrap,free -o intl int.o mymalloc.o\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])])])])])])]),t._v(" "),a("h3",{attrs:{id:"7133-运行时打桩"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#7133-运行时打桩"}},[t._v("#")]),t._v(" 7.13.3 运行时打桩")]),t._v(" "),a("div",{staticClass:"custom-block note"},[a("p",{staticClass:"custom-block-title"},[t._v("只要能够访问可执行目标文件，就可以进行打桩")]),t._v(" "),a("ul",[a("li",[t._v("主要借助动态链接器的 "),a("code",[t._v("LD_PRELOAD")]),t._v(" 环境变量来实现相关的功能\n"),a("ul",[a("li",[a("p",[t._v("示例")]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("LD_PRELOAD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"./mymalloc.so"')]),t._v(" /usr/bin/uptime\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])])])])])])]),t._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[t._v("书中的代码在 gcc (GCC) 11.1.0 版本下会报错")]),t._v(" "),a("ul",[a("li",[t._v("问题原因是，"),a("code",[t._v("printf")]),t._v(" 会使用用 "),a("code",[t._v("malloc")]),t._v(" 分配内存，原代码会造成循环调用\n"),a("ul",[a("li",[t._v("参照 "),a("a",{attrs:{href:"https://stackoverflow.com/questions/65275140/library-interpositioning",target:"_blank",rel:"noopener noreferrer"}},[t._v("stackoverflow"),a("OutboundLink")],1)])])]),t._v(" "),a("li",[t._v("可以在自定义的 "),a("code",[t._v("malloc")]),t._v(" 和 "),a("code",[t._v("free")]),t._v(" 函数中使用 "),a("code",[t._v('fprintf(stderr, "")')]),t._v(" 来打印相关的消息\n"),a("ul",[a("li",[a("code",[t._v("stderr")]),t._v(" 不会使用缓冲区，不涉及内存分配")])])])])])],1)}),[],!1,null,null,null);"function"==typeof e&&e(l);s.default=l.exports}}]);