(window.webpackJsonp=window.webpackJsonp||[]).push([[475],{1157:function(s,t,a){"use strict";a.r(t);var e=a(12),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"中断、异常和系统调用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#中断、异常和系统调用"}},[s._v("#")]),s._v(" 中断、异常和系统调用")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"assets/lec3-%E5%90%AF%E5%8A%A8%E4%B8%AD%E6%96%AD%E5%BC%82%E5%B8%B8%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8_125003200.pdf"}},[s._v("🔗 课件")])])]),s._v(" "),a("hr"),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20210410163435-2021-04-10-16-34-35.png",alt:"20210410163435-2021-04-10-16-34-35"}})]),s._v(" "),a("ul",[a("li",[s._v("系统调用（system call）\n"),a("ul",[a("li",[s._v("应用程序主动向操作系统发出的服务请求")])])]),s._v(" "),a("li",[s._v("异常(exception)\n"),a("ul",[a("li",[s._v("非法指令或者其他原因导致当前指令执行失败"),a("br"),s._v("\n(如：内存出错)后的处理请求")])])]),s._v(" "),a("li",[s._v("中断(hardware interrupt)\n"),a("ul",[a("li",[s._v("来自硬件设备的处理请求")])])])]),s._v(" "),a("h2",{attrs:{id:"中断、异常和系统的调用比较"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#中断、异常和系统的调用比较"}},[s._v("#")]),s._v(" 中断、异常和系统的调用比较")]),s._v(" "),a("ul",[a("li",[s._v("源头\n"),a("ul",[a("li",[s._v("中断：外设")]),s._v(" "),a("li",[s._v("异常：应用程序意想不到的行为")]),s._v(" "),a("li",[s._v("系统调用：应用程序请求操作提供服务")])])]),s._v(" "),a("li",[s._v("响应方式\n"),a("ul",[a("li",[s._v("中断：异步")]),s._v(" "),a("li",[s._v("异常：同步")]),s._v(" "),a("li",[s._v("系统调用：异步或同步")])])]),s._v(" "),a("li",[s._v("处理机制\n"),a("ul",[a("li",[s._v("中断：持续，对用户应用程序是透明的")]),s._v(" "),a("li",[s._v("异常：杀死或者重新执行意想不到的应用程序指令")]),s._v(" "),a("li",[s._v("系统调用：等待和持续")])])])]),s._v(" "),a("h2",{attrs:{id:"中断"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#中断"}},[s._v("#")]),s._v(" 中断")]),s._v(" "),a("h3",{attrs:{id:"中断处理机制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#中断处理机制"}},[s._v("#")]),s._v(" 中断处理机制")]),s._v(" "),a("p",[s._v("先硬件处理再软件处理")]),s._v(" "),a("ul",[a("li",[s._v("硬件处理\n"),a("ul",[a("li",[s._v("在CPU初始化时设置中断使能标志\n"),a("ul",[a("li",[s._v("依据内部或外部事件设置中断标志")]),s._v(" "),a("li",[s._v("依据中断向量调用相应中断服务例程")])])])])]),s._v(" "),a("li",[s._v("软件处理\n"),a("ul",[a("li",[s._v("现场保存（编译器）\n"),a("ul",[a("li",[s._v("保存中断前的状态")])])]),s._v(" "),a("li",[s._v("中断服务处理（服务例程）")]),s._v(" "),a("li",[s._v("清除中断标记（服务例程）")]),s._v(" "),a("li",[s._v("现场恢复（编译器）\n"),a("ul",[a("li",[s._v("恢复到中断前的状态")])])])])])]),s._v(" "),a("h3",{attrs:{id:"中断嵌套"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#中断嵌套"}},[s._v("#")]),s._v(" 中断嵌套")]),s._v(" "),a("ul",[a("li",[s._v("硬件中断服务例程可被打断\n"),a("ul",[a("li",[s._v("不同硬件中断源可能硬件中断处理时出现")]),s._v(" "),a("li",[s._v("硬件中断服务例程中需要临时禁止中断请求")]),s._v(" "),a("li",[s._v("中断请求会保持到CPU做出响应")])])]),s._v(" "),a("li",[s._v("异常服务例程可被打断\n"),a("ul",[a("li",[s._v("异常服务例程执行时可能出现硬件中断")])])]),s._v(" "),a("li",[s._v("异常服务例程可嵌套\n"),s._v(" "),a("ul",[a("li",[s._v("异常服务例程可能出现缺页")])])])]),s._v(" "),a("h2",{attrs:{id:"系统调用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#系统调用"}},[s._v("#")]),s._v(" 系统调用")]),s._v(" "),a("ul",[a("li",[s._v("应用程序调用"),a("code",[s._v("printf()")]),s._v(" 时，会触发系统调用"),a("code",[s._v("write()")])])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20210410165852-2021-04-10-16-58-52.png",alt:"20210410165852-2021-04-10-16-58-52"}})]),s._v(" "),a("ul",[a("li",[s._v("操作系统服务的编程接口")]),s._v(" "),a("li",[s._v("通常由高级语言编写（C或者C++）")]),s._v(" "),a("li",[s._v("程序访问通常是通过高层次的API接口而不是直接进行系统调用")]),s._v(" "),a("li",[s._v("三种最常用的应用程序编程接口（API）\n"),a("ul",[a("li",[s._v("Win32 API 用于 Windows")]),s._v(" "),a("li",[s._v("POSIX API 用于 POSIX-based systems (包括UNIX，LINUX，Mac OS X的所有版本)")]),s._v(" "),a("li",[s._v("Java API 用于JAVA虚拟机(JVM)")])])])]),s._v(" "),a("h3",{attrs:{id:"系统调用的实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#系统调用的实现"}},[s._v("#")]),s._v(" 系统调用的实现")]),s._v(" "),a("ul",[a("li",[s._v("每个系统调用对应一个系统调用号\n"),a("ul",[a("li",[s._v("系统调用接口根据系统调用号来维护系统调用表的索引")])])]),s._v(" "),a("li",[s._v("系统调用接口调用内核态中的系统调用功能实现，并返回系统调用的状态和结果")]),s._v(" "),a("li",[s._v("用户不需要知道系统调用的实现\n"),a("ul",[a("li",[s._v("需要设置调用参数和获取返回结果")]),s._v(" "),a("li",[s._v("操作系统接口的细节大部分都隐藏在应用编程接口后\n"),a("ul",[a("li",[a("strong",[s._v("通过运行程序支持的库来管理")])])])])])])]),s._v(" "),a("h3",{attrs:{id:"函数调用和系统调用的不同处"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#函数调用和系统调用的不同处"}},[s._v("#")]),s._v(" 函数调用和系统调用的不同处")]),s._v(" "),a("ul",[a("li",[s._v("INT和IRET指令用于系统调用\n"),a("ul",[a("li",[s._v("系统调用时，会进行"),a("strong",[s._v("堆栈切换和特权级的转换")])])])]),s._v(" "),a("li",[s._v("函数调用\n"),a("ul",[a("li",[a("code",[s._v("CALL")]),s._v("和"),a("code",[s._v("RET")]),s._v("用于常规调用")]),s._v(" "),a("li",[a("strong",[s._v("常规调用时没有堆栈切换")])])])])]),s._v(" "),a("h3",{attrs:{id:"中断异常和系统调用的开销"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#中断异常和系统调用的开销"}},[s._v("#")]),s._v(" 中断异常和系统调用的开销")]),s._v(" "),a("ul",[a("li",[s._v("超过函数调用")]),s._v(" "),a("li",[s._v("开销：\n"),a("ul",[a("li",[s._v("引导机制")]),s._v(" "),a("li",[s._v("建立内核堆栈")]),s._v(" "),a("li",[s._v("验证参数")]),s._v(" "),a("li",[s._v("内核态映射到用户态的地址空间\n"),a("ul",[a("li",[s._v("更新页面映射权限")])])])])]),s._v(" "),a("li",[s._v("内核态独立地址空间\n"),s._v(" "),a("ul",[a("li",[s._v("TLB")])])])]),s._v(" "),a("h3",{attrs:{id:"系统调用示例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#系统调用示例"}},[s._v("#")]),s._v(" 系统调用示例")]),s._v(" "),a("ul",[a("li",[s._v("为了与示例匹配，可以查看 lab8_answer\n"),a("ul",[a("li",[s._v("可从 "),a("a",{attrs:{href:"https://github.com/sbwcwso/sbwcwso.github.io/tree/main/md-file/0-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/1-%E6%B8%85%E5%8D%8E%E5%85%AC%E5%BC%80%E8%AF%BE/3-%E5%90%AF%E5%8A%A8%E4%B8%AD%E6%96%AD%E5%BC%82%E5%B8%B8%E5%92%8C%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/assets/lab8_result",target:"_blank",rel:"noopener noreferrer"}},[s._v("🔗 此处"),a("OutboundLink")],1),s._v(" 下载 la8_answer")])])])]),s._v(" "),a("h4",{attrs:{id:"文件复制过程中的系统调用序列"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#文件复制过程中的系统调用序列"}},[s._v("#")]),s._v(" 文件复制过程中的系统调用序列")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20210410175011-2021-04-10-17-50-11.png",alt:"20210410175011-2021-04-10-17-50-11"}})]),s._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// System call numbers")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("SYS_fork")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")])])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("SYS_exit")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")])])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("SYS_wait")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")])])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("SYS_pipe")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")])])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("SYS_write")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("  ")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 与文件复制相关")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("SYS_read")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("  ")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//  与文件复制相关")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("SYS_close")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(" ")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//  与文件复制相关")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("SYS_kill")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")])])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("SYS_exec")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")])])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("SYS_open")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("  ")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//  与文件复制相关")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("SYS_mknod")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")])])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("SYS_unlink")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")])])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("SYS_fstat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")])])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("SYS_link")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")])])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("SYS_mkdir")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")])])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("SYS_chdir")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")])])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("SYS_dup")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")])])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("SYS_getpid")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")])])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("SYS_sbrk")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")])])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("SYS_sleep")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")])])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("SYS_procmem")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")])])]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),s._v(" "),a("h4",{attrs:{id:"ucore-中相关应用函数"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ucore-中相关应用函数"}},[s._v("#")]),s._v(" ucore 中相关应用函数")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("在ucore中库函数"),a("code",[s._v("read()")]),s._v("的功能是读文件")]),s._v(" "),a("ul",[a("li",[s._v("user/libs/file.h: "),a("code",[s._v("int read(int fd, void * buf, int length)")])])])]),s._v(" "),a("li",[a("p",[s._v("库函数 "),a("code",[s._v("read()")]),s._v(" 的参数和返回值")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("int fd")]),s._v(": 文件句柄")]),s._v(" "),a("li",[a("code",[s._v("void * buf")]),s._v(": 数据缓冲区指针")]),s._v(" "),a("li",[a("code",[s._v("int length")]),s._v(": 数据缓冲区长度")]),s._v(" "),a("li",[a("code",[s._v("int return_value")]),s._v(": 返回读出数据长度")])])]),s._v(" "),a("li",[a("p",[s._v("库函数"),a("code",[s._v("read()")]),s._v("使用示例")]),s._v(" "),a("ul",[a("li",[s._v("in sfs_filetest1.c: "),a("code",[s._v("ret = read(fd, data, len)")])])])])]),s._v(" "),a("h4",{attrs:{id:"由应用态转到内核态调用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#由应用态转到内核态调用"}},[s._v("#")]),s._v(" 由应用态转到内核态调用")]),s._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[s._v("sfs_filetest1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("c"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" ret "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("read")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("fd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("len"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n……\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 此段代码主要用于压栈")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8029")]),s._v("a1"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("b "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("45")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("        mov "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v("ebp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v("eax\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8029")]),s._v("a4"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("89")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("44")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("08")]),s._v("     mov "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v("eax"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v("esp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8029")]),s._v("a8"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("b "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("45")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("c        mov "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0xc")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v("ebp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v("eax\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8029")]),s._v("ab"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("89")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("44")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("04")]),s._v("     mov "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v("eax"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v("esp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8029")]),s._v("af"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("b "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("45")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("08")]),s._v("        mov "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v("ebp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v("eax\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8029")]),s._v("b2"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("89")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("04")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v("        mov "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v("eax"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v("esp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8029")]),s._v("b5"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("   e8 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("33")]),s._v(" d8 ff ff  call "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8001")]),s._v("ed "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("read"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("syscall")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" num"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 相当于调用 kern/trap/trapentry.S 中的 alltraps")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("asm")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("volatile")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"int %1;"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"=a"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"i"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("T_SYSCALL"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"a"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("num"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"d"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"c"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("https"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//github.com/sbwcwso/sbwcwso.github.io/tree/main/md-file/0-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/1-%E6%B8%85%E5%8D%8E%E5%85%AC%E5%BC%80%E8%AF%BE/3-%E5%90%AF%E5%8A%A8%E4%B8%AD%E6%96%AD%E5%BC%82%E5%B8%B8%E5%92%8C%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/assets/lab8_result")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"b"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"D"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"S"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cc"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"memory"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" ret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br")])]),s._v(" "),a("h4",{attrs:{id:"ucore系统内核态用软中断实现系统调用的过程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ucore系统内核态用软中断实现系统调用的过程"}},[s._v("#")]),s._v(" ucore系统内核态用软中断实现系统调用的过程")]),s._v(" "),a("ul",[a("li",[s._v("kern/trap/trapentry.S: "),a("code",[s._v("alltraps()")]),s._v(" "),a("ul",[a("li",[s._v("软中断")])])]),s._v(" "),a("li",[s._v("kern/trap/trap.c: "),a("code",[s._v("trap(), trap_dispatch()")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("tf->trapno == T_SYSCALL")])]),s._v(" "),a("li",[a("code",[s._v("T_SYSCALL")]),s._v(" 为系统调用对应的中断向量")]),s._v(" "),a("li",[s._v("通过查询中断向量表，判断是系统调用，然后进入系统调用表进行查询")])])]),s._v(" "),a("li",[s._v("kern/syscall/syscall.c: "),a("code",[s._v("syscall()")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("tf->tf_regs.reg_eax == SYS_read")])]),s._v(" "),a("li",[s._v("由系统调用表确定需要调用的系统函数是 "),a("code",[s._v("SYS_read")]),s._v("，然后开始执行相应的函数")])])]),s._v(" "),a("li",[s._v("kern/syscall/syscall.c: "),a("code",[s._v("sys_read()")]),s._v(" "),a("ul",[a("li",[s._v("从 "),a("code",[s._v("tf->sp")]),s._v(" 获取 "),a("code",[s._v("fd, buf, length")])]),s._v(" "),a("li",[s._v("从堆栈 sp 中获取参数")]),s._v(" "),a("li",[s._v("调用相关函数实现文件读取")])])]),s._v(" "),a("li",[s._v("kern/fs/sysfile.c: "),a("code",[s._v("sysfile_read()")]),s._v(" "),a("ul",[a("li",[s._v("读取文件，并返回上级调用函数，直至 "),a("code",[s._v("alltraps()")])])])]),s._v(" "),a("li",[s._v("kern/trap/trapentry.S: "),a("code",[s._v("trapret()")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("trapret()")]),s._v(": 将读到的内容返回到用户态\n"),s._v(" "),a("ul",[a("li",[s._v("具体通过 "),a("code",[s._v("ireturn")]),s._v(" 来实现")])])])])])]),s._v(" "),a("ul",[a("li",[a("p",[s._v("Understand 的版本是 5.1")])]),s._v(" "),a("li",[a("p",[s._v("创建项目注意框选进一步配置\n"),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20210411090741-2021-04-11-09-07-41.png",alt:"20210411090741-2021-04-11-09-07-41"}})])]),s._v(" "),a("li",[a("p",[s._v("将 C/C++ 的分析模式设为 "),a("code",[s._v("Fuzzy")]),s._v(" "),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20210411090842-2021-04-11-09-08-42.png",alt:"20210411090842-2021-04-11-09-08-42"}})])]),s._v(" "),a("li",[a("p",[s._v("File Types 中确保 .S 对应的是 Assembly，如果没有相应的项，需要新建文件\n"),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20210411090946-2021-04-11-09-09-46.png",alt:"20210411090946-2021-04-11-09-09-46"}})])]),s._v(" "),a("li",[a("p",[s._v("将 Assembly 设置为 IBM\n"),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20210411173524-2021-04-11-17-35-24.png",alt:"20210411173524-2021-04-11-17-35-24"}})])])])])}),[],!1,null,null,null);t.default=n.exports}}]);