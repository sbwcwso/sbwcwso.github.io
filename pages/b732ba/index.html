<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第 9 章 虚拟内存 | mznote</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/img/note.png">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" def=""></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/d3@6"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/markmap-view"></script>
    <script src="https://cdn.jsdelivr.net/npm/react/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-XF5DN574WN"></script>
    <script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-XF5DN574WN');</script>
    <meta name="description" content="计算机基础知识博客, 个人博客">
    <meta name="keywords" content="个人技术博客,前端,技术文档,学习,c,c++,python,css3,html5,git,github,markdown">
    <meta name="theme-color" content="#11a8cd">
    <link rel="preload" href="/assets/css/0.styles.b7548b6d.css" as="style"><link rel="preload" href="/assets/js/app.095f6a1f.js" as="script"><link rel="preload" href="/assets/js/2.6bb19404.js" as="script"><link rel="preload" href="/assets/js/3.6d4bd9fe.js" as="script"><link rel="preload" href="/assets/js/103.33d325d0.js" as="script"><link rel="prefetch" href="/assets/js/10.494491dd.js"><link rel="prefetch" href="/assets/js/100.445a49dc.js"><link rel="prefetch" href="/assets/js/101.1d120680.js"><link rel="prefetch" href="/assets/js/102.7d38a1c6.js"><link rel="prefetch" href="/assets/js/104.94fbd3e4.js"><link rel="prefetch" href="/assets/js/105.5041358a.js"><link rel="prefetch" href="/assets/js/106.ecbd6f91.js"><link rel="prefetch" href="/assets/js/107.61002796.js"><link rel="prefetch" href="/assets/js/108.663b0f72.js"><link rel="prefetch" href="/assets/js/109.65ca5949.js"><link rel="prefetch" href="/assets/js/11.3b561095.js"><link rel="prefetch" href="/assets/js/110.79e92a1e.js"><link rel="prefetch" href="/assets/js/111.6ebb7462.js"><link rel="prefetch" href="/assets/js/112.89ec46d8.js"><link rel="prefetch" href="/assets/js/113.a8de6828.js"><link rel="prefetch" href="/assets/js/114.84e36fe5.js"><link rel="prefetch" href="/assets/js/115.fb5f54e6.js"><link rel="prefetch" href="/assets/js/116.3abf0f89.js"><link rel="prefetch" href="/assets/js/117.7f428d6c.js"><link rel="prefetch" href="/assets/js/118.9c0b2ba8.js"><link rel="prefetch" href="/assets/js/119.08d71f5c.js"><link rel="prefetch" href="/assets/js/12.c5d338bc.js"><link rel="prefetch" href="/assets/js/120.e5cdff04.js"><link rel="prefetch" href="/assets/js/121.aec618f0.js"><link rel="prefetch" href="/assets/js/122.ad75fdea.js"><link rel="prefetch" href="/assets/js/123.be419d92.js"><link rel="prefetch" href="/assets/js/124.287b7fef.js"><link rel="prefetch" href="/assets/js/125.1ce6a62e.js"><link rel="prefetch" href="/assets/js/126.61c19597.js"><link rel="prefetch" href="/assets/js/127.3a39216d.js"><link rel="prefetch" href="/assets/js/128.d0796efe.js"><link rel="prefetch" href="/assets/js/129.674ca3bf.js"><link rel="prefetch" href="/assets/js/13.89018181.js"><link rel="prefetch" href="/assets/js/130.a196f0ff.js"><link rel="prefetch" href="/assets/js/131.5ceae5b3.js"><link rel="prefetch" href="/assets/js/132.1f1df86b.js"><link rel="prefetch" href="/assets/js/133.5ff23d0c.js"><link rel="prefetch" href="/assets/js/134.d48d2bfb.js"><link rel="prefetch" href="/assets/js/135.034f0e0f.js"><link rel="prefetch" href="/assets/js/136.004d8b5b.js"><link rel="prefetch" href="/assets/js/137.d85175ad.js"><link rel="prefetch" href="/assets/js/138.8e156841.js"><link rel="prefetch" href="/assets/js/139.ac8f1585.js"><link rel="prefetch" href="/assets/js/14.bc808c38.js"><link rel="prefetch" href="/assets/js/140.de8cdddc.js"><link rel="prefetch" href="/assets/js/141.531b6dd2.js"><link rel="prefetch" href="/assets/js/142.f2235d30.js"><link rel="prefetch" href="/assets/js/143.71ad6ab0.js"><link rel="prefetch" href="/assets/js/144.2bbd7bed.js"><link rel="prefetch" href="/assets/js/145.bacdda91.js"><link rel="prefetch" href="/assets/js/146.17b42b03.js"><link rel="prefetch" href="/assets/js/147.deed8eea.js"><link rel="prefetch" href="/assets/js/148.4cda262d.js"><link rel="prefetch" href="/assets/js/149.3efd5184.js"><link rel="prefetch" href="/assets/js/15.0b48cdef.js"><link rel="prefetch" href="/assets/js/150.b2cd8144.js"><link rel="prefetch" href="/assets/js/151.b0cecdb1.js"><link rel="prefetch" href="/assets/js/152.29206387.js"><link rel="prefetch" href="/assets/js/153.f48bceb4.js"><link rel="prefetch" href="/assets/js/154.1e4a452e.js"><link rel="prefetch" href="/assets/js/155.44a5d1d2.js"><link rel="prefetch" href="/assets/js/156.06967467.js"><link rel="prefetch" href="/assets/js/157.edb441f9.js"><link rel="prefetch" href="/assets/js/158.d50e91dc.js"><link rel="prefetch" href="/assets/js/159.292cf499.js"><link rel="prefetch" href="/assets/js/16.43137832.js"><link rel="prefetch" href="/assets/js/160.6d859c92.js"><link rel="prefetch" href="/assets/js/161.46411040.js"><link rel="prefetch" href="/assets/js/162.eb19ae85.js"><link rel="prefetch" href="/assets/js/163.1c9f0ce4.js"><link rel="prefetch" href="/assets/js/164.127bd326.js"><link rel="prefetch" href="/assets/js/165.010f558e.js"><link rel="prefetch" href="/assets/js/166.1ada777c.js"><link rel="prefetch" href="/assets/js/167.f825f7e3.js"><link rel="prefetch" href="/assets/js/168.5e679311.js"><link rel="prefetch" href="/assets/js/169.08ca9e36.js"><link rel="prefetch" href="/assets/js/17.1236efa3.js"><link rel="prefetch" href="/assets/js/170.ffcdd3bb.js"><link rel="prefetch" href="/assets/js/171.1cff3d08.js"><link rel="prefetch" href="/assets/js/172.8e22c29c.js"><link rel="prefetch" href="/assets/js/173.14d0b4cb.js"><link rel="prefetch" href="/assets/js/174.12a70c34.js"><link rel="prefetch" href="/assets/js/175.76382f27.js"><link rel="prefetch" href="/assets/js/176.7df0d862.js"><link rel="prefetch" href="/assets/js/177.05db80cf.js"><link rel="prefetch" href="/assets/js/178.456f29eb.js"><link rel="prefetch" href="/assets/js/179.7f4c20a2.js"><link rel="prefetch" href="/assets/js/18.b1c77070.js"><link rel="prefetch" href="/assets/js/180.fda6f184.js"><link rel="prefetch" href="/assets/js/181.839acd60.js"><link rel="prefetch" href="/assets/js/182.b7b6a43f.js"><link rel="prefetch" href="/assets/js/183.ab2f05d8.js"><link rel="prefetch" href="/assets/js/184.fad21c92.js"><link rel="prefetch" href="/assets/js/185.d24a44da.js"><link rel="prefetch" href="/assets/js/186.9d066e53.js"><link rel="prefetch" href="/assets/js/187.96e7bdd8.js"><link rel="prefetch" href="/assets/js/188.c13b3ed3.js"><link rel="prefetch" href="/assets/js/189.879efb22.js"><link rel="prefetch" href="/assets/js/19.d79c58a1.js"><link rel="prefetch" href="/assets/js/190.a7096791.js"><link rel="prefetch" href="/assets/js/191.9e78de26.js"><link rel="prefetch" href="/assets/js/192.3b4df334.js"><link rel="prefetch" href="/assets/js/193.f9a14cad.js"><link rel="prefetch" href="/assets/js/194.9ed427d7.js"><link rel="prefetch" href="/assets/js/195.ee62ad15.js"><link rel="prefetch" href="/assets/js/196.5eadb168.js"><link rel="prefetch" href="/assets/js/197.19cb6f7b.js"><link rel="prefetch" href="/assets/js/198.33798b2a.js"><link rel="prefetch" href="/assets/js/199.c3cf1fe3.js"><link rel="prefetch" href="/assets/js/20.dd41c2ed.js"><link rel="prefetch" href="/assets/js/200.4bb57f89.js"><link rel="prefetch" href="/assets/js/201.578612bb.js"><link rel="prefetch" href="/assets/js/202.d7a48484.js"><link rel="prefetch" href="/assets/js/203.d11aed73.js"><link rel="prefetch" href="/assets/js/204.e74a7f9d.js"><link rel="prefetch" href="/assets/js/205.8e68b482.js"><link rel="prefetch" href="/assets/js/206.1c7d40bd.js"><link rel="prefetch" href="/assets/js/207.abef77d7.js"><link rel="prefetch" href="/assets/js/208.b0e820df.js"><link rel="prefetch" href="/assets/js/209.a567a864.js"><link rel="prefetch" href="/assets/js/21.eea6bdce.js"><link rel="prefetch" href="/assets/js/210.02af4494.js"><link rel="prefetch" href="/assets/js/211.caf7e3fe.js"><link rel="prefetch" href="/assets/js/212.1509c5da.js"><link rel="prefetch" href="/assets/js/213.25d1fe48.js"><link rel="prefetch" href="/assets/js/214.c49b28fe.js"><link rel="prefetch" href="/assets/js/215.43d106a8.js"><link rel="prefetch" href="/assets/js/216.97ed69f8.js"><link rel="prefetch" href="/assets/js/217.189b5316.js"><link rel="prefetch" href="/assets/js/218.f8eec35b.js"><link rel="prefetch" href="/assets/js/219.917288c7.js"><link rel="prefetch" href="/assets/js/22.ff0c971e.js"><link rel="prefetch" href="/assets/js/220.1ee01431.js"><link rel="prefetch" href="/assets/js/221.2f54ce07.js"><link rel="prefetch" href="/assets/js/222.9905809e.js"><link rel="prefetch" href="/assets/js/223.8c3f0494.js"><link rel="prefetch" href="/assets/js/224.ae6e47e8.js"><link rel="prefetch" href="/assets/js/225.c9ae592f.js"><link rel="prefetch" href="/assets/js/226.3b025908.js"><link rel="prefetch" href="/assets/js/227.6f4e9a52.js"><link rel="prefetch" href="/assets/js/228.ca0cfe8b.js"><link rel="prefetch" href="/assets/js/229.3433290b.js"><link rel="prefetch" href="/assets/js/23.ca2349d0.js"><link rel="prefetch" href="/assets/js/230.efb73cea.js"><link rel="prefetch" href="/assets/js/231.7b4b904f.js"><link rel="prefetch" href="/assets/js/232.1f3a96cd.js"><link rel="prefetch" href="/assets/js/233.53d419ad.js"><link rel="prefetch" href="/assets/js/234.0dc63c2c.js"><link rel="prefetch" href="/assets/js/235.130f09e8.js"><link rel="prefetch" href="/assets/js/236.af6fda35.js"><link rel="prefetch" href="/assets/js/237.c61e25ba.js"><link rel="prefetch" href="/assets/js/238.0ad2ec5f.js"><link rel="prefetch" href="/assets/js/239.e649c2a6.js"><link rel="prefetch" href="/assets/js/24.7abc0828.js"><link rel="prefetch" href="/assets/js/240.ae9d9ac3.js"><link rel="prefetch" href="/assets/js/241.7df959df.js"><link rel="prefetch" href="/assets/js/242.4ae5abf9.js"><link rel="prefetch" href="/assets/js/243.b9bfcba5.js"><link rel="prefetch" href="/assets/js/244.14e35685.js"><link rel="prefetch" href="/assets/js/245.fa48c854.js"><link rel="prefetch" href="/assets/js/246.56ec32b5.js"><link rel="prefetch" href="/assets/js/247.d7eef1f1.js"><link rel="prefetch" href="/assets/js/248.5b71c9af.js"><link rel="prefetch" href="/assets/js/249.f9f5e0ec.js"><link rel="prefetch" href="/assets/js/25.78279337.js"><link rel="prefetch" href="/assets/js/250.3c7a188c.js"><link rel="prefetch" href="/assets/js/251.fa1f591f.js"><link rel="prefetch" href="/assets/js/252.9840ca7b.js"><link rel="prefetch" href="/assets/js/253.9bec1d1d.js"><link rel="prefetch" href="/assets/js/254.501ec471.js"><link rel="prefetch" href="/assets/js/255.2b24b056.js"><link rel="prefetch" href="/assets/js/256.25cda263.js"><link rel="prefetch" href="/assets/js/257.00f5862c.js"><link rel="prefetch" href="/assets/js/258.7b0a0fe7.js"><link rel="prefetch" href="/assets/js/259.9065e975.js"><link rel="prefetch" href="/assets/js/26.317c2e67.js"><link rel="prefetch" href="/assets/js/260.1e2db99f.js"><link rel="prefetch" href="/assets/js/261.45463f74.js"><link rel="prefetch" href="/assets/js/262.780183d7.js"><link rel="prefetch" href="/assets/js/263.71e994c1.js"><link rel="prefetch" href="/assets/js/264.51f2afd6.js"><link rel="prefetch" href="/assets/js/265.bebf5d26.js"><link rel="prefetch" href="/assets/js/266.0f1f8efe.js"><link rel="prefetch" href="/assets/js/267.780f225e.js"><link rel="prefetch" href="/assets/js/268.5fb493e2.js"><link rel="prefetch" href="/assets/js/269.3497cb87.js"><link rel="prefetch" href="/assets/js/27.b530259c.js"><link rel="prefetch" href="/assets/js/270.d08461de.js"><link rel="prefetch" href="/assets/js/271.6ea44863.js"><link rel="prefetch" href="/assets/js/272.3c81f719.js"><link rel="prefetch" href="/assets/js/273.bc63655d.js"><link rel="prefetch" href="/assets/js/274.42335b12.js"><link rel="prefetch" href="/assets/js/275.a4b0b2f6.js"><link rel="prefetch" href="/assets/js/276.8c742b20.js"><link rel="prefetch" href="/assets/js/277.9c930787.js"><link rel="prefetch" href="/assets/js/278.a7086dae.js"><link rel="prefetch" href="/assets/js/279.bfccffdd.js"><link rel="prefetch" href="/assets/js/28.8579f37b.js"><link rel="prefetch" href="/assets/js/280.7d5c0869.js"><link rel="prefetch" href="/assets/js/281.0c13798e.js"><link rel="prefetch" href="/assets/js/282.78bb2100.js"><link rel="prefetch" href="/assets/js/283.102a9ac9.js"><link rel="prefetch" href="/assets/js/284.9c65d687.js"><link rel="prefetch" href="/assets/js/285.46df33cb.js"><link rel="prefetch" href="/assets/js/286.d5334f4a.js"><link rel="prefetch" href="/assets/js/287.b56768ba.js"><link rel="prefetch" href="/assets/js/288.4e8672cf.js"><link rel="prefetch" href="/assets/js/289.3b512333.js"><link rel="prefetch" href="/assets/js/29.4b34cb2e.js"><link rel="prefetch" href="/assets/js/290.13f5cb4f.js"><link rel="prefetch" href="/assets/js/291.9442af0c.js"><link rel="prefetch" href="/assets/js/292.fe087795.js"><link rel="prefetch" href="/assets/js/293.aca3b34f.js"><link rel="prefetch" href="/assets/js/294.c4a0d801.js"><link rel="prefetch" href="/assets/js/295.307848e1.js"><link rel="prefetch" href="/assets/js/296.9303a7fd.js"><link rel="prefetch" href="/assets/js/297.97b72c2d.js"><link rel="prefetch" href="/assets/js/298.304f4b36.js"><link rel="prefetch" href="/assets/js/299.f0f15709.js"><link rel="prefetch" href="/assets/js/30.801059de.js"><link rel="prefetch" href="/assets/js/300.4629592a.js"><link rel="prefetch" href="/assets/js/301.df68b2bd.js"><link rel="prefetch" href="/assets/js/302.3ed42c51.js"><link rel="prefetch" href="/assets/js/303.78b9243b.js"><link rel="prefetch" href="/assets/js/304.2956c5ab.js"><link rel="prefetch" href="/assets/js/305.626ccbda.js"><link rel="prefetch" href="/assets/js/306.72ce3f1d.js"><link rel="prefetch" href="/assets/js/307.db6afaf3.js"><link rel="prefetch" href="/assets/js/308.80a3800c.js"><link rel="prefetch" href="/assets/js/309.13b3f8b1.js"><link rel="prefetch" href="/assets/js/31.6710aa93.js"><link rel="prefetch" href="/assets/js/310.6333970d.js"><link rel="prefetch" href="/assets/js/311.e45ad1b0.js"><link rel="prefetch" href="/assets/js/312.cd1f4ba3.js"><link rel="prefetch" href="/assets/js/313.90ab428b.js"><link rel="prefetch" href="/assets/js/314.eb920c76.js"><link rel="prefetch" href="/assets/js/315.14575706.js"><link rel="prefetch" href="/assets/js/316.da5dc340.js"><link rel="prefetch" href="/assets/js/317.7447df2d.js"><link rel="prefetch" href="/assets/js/318.891c52cd.js"><link rel="prefetch" href="/assets/js/319.56c19bd9.js"><link rel="prefetch" href="/assets/js/32.b9f02dcb.js"><link rel="prefetch" href="/assets/js/320.bc490a46.js"><link rel="prefetch" href="/assets/js/321.24b2a71e.js"><link rel="prefetch" href="/assets/js/322.735d4197.js"><link rel="prefetch" href="/assets/js/323.a9c788f0.js"><link rel="prefetch" href="/assets/js/324.0827164a.js"><link rel="prefetch" href="/assets/js/325.902ab440.js"><link rel="prefetch" href="/assets/js/326.76f9509e.js"><link rel="prefetch" href="/assets/js/327.b1155a77.js"><link rel="prefetch" href="/assets/js/328.d888aec4.js"><link rel="prefetch" href="/assets/js/329.6ff51aa8.js"><link rel="prefetch" href="/assets/js/33.16e702fa.js"><link rel="prefetch" href="/assets/js/330.793a12c0.js"><link rel="prefetch" href="/assets/js/331.d939f25b.js"><link rel="prefetch" href="/assets/js/332.1b358cc1.js"><link rel="prefetch" href="/assets/js/333.2c0791ff.js"><link rel="prefetch" href="/assets/js/334.9c7488c6.js"><link rel="prefetch" href="/assets/js/335.69a6e4d2.js"><link rel="prefetch" href="/assets/js/336.924e2aa5.js"><link rel="prefetch" href="/assets/js/337.7bb62c80.js"><link rel="prefetch" href="/assets/js/338.cfa5930a.js"><link rel="prefetch" href="/assets/js/339.3568d177.js"><link rel="prefetch" href="/assets/js/34.7e8835da.js"><link rel="prefetch" href="/assets/js/340.82a4d9b8.js"><link rel="prefetch" href="/assets/js/341.f191985d.js"><link rel="prefetch" href="/assets/js/342.46cb268d.js"><link rel="prefetch" href="/assets/js/343.c5c2ec3a.js"><link rel="prefetch" href="/assets/js/344.7d3b5d58.js"><link rel="prefetch" href="/assets/js/345.7cd2a55a.js"><link rel="prefetch" href="/assets/js/346.1d67532d.js"><link rel="prefetch" href="/assets/js/347.e5746dbe.js"><link rel="prefetch" href="/assets/js/348.54850172.js"><link rel="prefetch" href="/assets/js/349.696a8b0a.js"><link rel="prefetch" href="/assets/js/35.afc00612.js"><link rel="prefetch" href="/assets/js/350.7d3afa7e.js"><link rel="prefetch" href="/assets/js/351.bc7aaf03.js"><link rel="prefetch" href="/assets/js/352.7e3238ce.js"><link rel="prefetch" href="/assets/js/353.4c200924.js"><link rel="prefetch" href="/assets/js/354.2bf378ee.js"><link rel="prefetch" href="/assets/js/355.8c826b92.js"><link rel="prefetch" href="/assets/js/356.2f11fc87.js"><link rel="prefetch" href="/assets/js/357.f6c43c27.js"><link rel="prefetch" href="/assets/js/358.062234c4.js"><link rel="prefetch" href="/assets/js/359.cdfd0d09.js"><link rel="prefetch" href="/assets/js/36.db4b98e4.js"><link rel="prefetch" href="/assets/js/360.ed79bd84.js"><link rel="prefetch" href="/assets/js/361.20be9591.js"><link rel="prefetch" href="/assets/js/362.366bda21.js"><link rel="prefetch" href="/assets/js/363.38340179.js"><link rel="prefetch" href="/assets/js/364.0d9a33d7.js"><link rel="prefetch" href="/assets/js/365.e52c5af6.js"><link rel="prefetch" href="/assets/js/366.80eeffd8.js"><link rel="prefetch" href="/assets/js/367.cfd266f9.js"><link rel="prefetch" href="/assets/js/368.bd3cc78d.js"><link rel="prefetch" href="/assets/js/369.b568de16.js"><link rel="prefetch" href="/assets/js/37.9fbc5926.js"><link rel="prefetch" href="/assets/js/370.8865233a.js"><link rel="prefetch" href="/assets/js/371.56772f61.js"><link rel="prefetch" href="/assets/js/372.d4c2cf3e.js"><link rel="prefetch" href="/assets/js/373.997d462c.js"><link rel="prefetch" href="/assets/js/374.4e8bbb79.js"><link rel="prefetch" href="/assets/js/375.4fe8075a.js"><link rel="prefetch" href="/assets/js/376.42e8f3bb.js"><link rel="prefetch" href="/assets/js/377.72220464.js"><link rel="prefetch" href="/assets/js/378.45808f14.js"><link rel="prefetch" href="/assets/js/379.446d58c4.js"><link rel="prefetch" href="/assets/js/38.abff2811.js"><link rel="prefetch" href="/assets/js/380.930f5de1.js"><link rel="prefetch" href="/assets/js/381.f5385e93.js"><link rel="prefetch" href="/assets/js/382.d3551ecd.js"><link rel="prefetch" href="/assets/js/383.4344d201.js"><link rel="prefetch" href="/assets/js/384.6b86db19.js"><link rel="prefetch" href="/assets/js/385.6491cce1.js"><link rel="prefetch" href="/assets/js/386.69c9b62b.js"><link rel="prefetch" href="/assets/js/387.55ddd1af.js"><link rel="prefetch" href="/assets/js/388.e62fd98d.js"><link rel="prefetch" href="/assets/js/389.487083d1.js"><link rel="prefetch" href="/assets/js/39.de548a46.js"><link rel="prefetch" href="/assets/js/390.4ebe9975.js"><link rel="prefetch" href="/assets/js/391.2adb910a.js"><link rel="prefetch" href="/assets/js/392.cca72635.js"><link rel="prefetch" href="/assets/js/393.9b1c2435.js"><link rel="prefetch" href="/assets/js/394.d85b4431.js"><link rel="prefetch" href="/assets/js/395.d3288ae2.js"><link rel="prefetch" href="/assets/js/396.b3bfe727.js"><link rel="prefetch" href="/assets/js/397.8e8c329f.js"><link rel="prefetch" href="/assets/js/398.18d752d3.js"><link rel="prefetch" href="/assets/js/399.060021a5.js"><link rel="prefetch" href="/assets/js/4.289dc493.js"><link rel="prefetch" href="/assets/js/40.155c5f23.js"><link rel="prefetch" href="/assets/js/400.d0ec2779.js"><link rel="prefetch" href="/assets/js/401.aae12d2c.js"><link rel="prefetch" href="/assets/js/402.4c1e36ee.js"><link rel="prefetch" href="/assets/js/403.27b40602.js"><link rel="prefetch" href="/assets/js/404.f1e342ca.js"><link rel="prefetch" href="/assets/js/405.8b78b984.js"><link rel="prefetch" href="/assets/js/406.6175a4f4.js"><link rel="prefetch" href="/assets/js/407.49b22b20.js"><link rel="prefetch" href="/assets/js/408.917027d3.js"><link rel="prefetch" href="/assets/js/409.ef934658.js"><link rel="prefetch" href="/assets/js/41.9d17ef6e.js"><link rel="prefetch" href="/assets/js/410.4394cdfa.js"><link rel="prefetch" href="/assets/js/411.639427b2.js"><link rel="prefetch" href="/assets/js/412.39fa66e7.js"><link rel="prefetch" href="/assets/js/413.655206dd.js"><link rel="prefetch" href="/assets/js/414.9c71744c.js"><link rel="prefetch" href="/assets/js/415.815804fb.js"><link rel="prefetch" href="/assets/js/416.f16833eb.js"><link rel="prefetch" href="/assets/js/417.e36ce3b2.js"><link rel="prefetch" href="/assets/js/418.13401265.js"><link rel="prefetch" href="/assets/js/419.fb48320b.js"><link rel="prefetch" href="/assets/js/42.ea0dd33b.js"><link rel="prefetch" href="/assets/js/420.e7d0acc3.js"><link rel="prefetch" href="/assets/js/421.f0974b18.js"><link rel="prefetch" href="/assets/js/422.71bb1214.js"><link rel="prefetch" href="/assets/js/423.2933f26c.js"><link rel="prefetch" href="/assets/js/424.d73e5d07.js"><link rel="prefetch" href="/assets/js/425.76efc0b6.js"><link rel="prefetch" href="/assets/js/426.f3cc0d4e.js"><link rel="prefetch" href="/assets/js/427.f460718e.js"><link rel="prefetch" href="/assets/js/428.7a2e0b51.js"><link rel="prefetch" href="/assets/js/429.d396e33b.js"><link rel="prefetch" href="/assets/js/43.a4bcd5c1.js"><link rel="prefetch" href="/assets/js/430.cd2c1221.js"><link rel="prefetch" href="/assets/js/431.41d92cf2.js"><link rel="prefetch" href="/assets/js/432.4c961f1e.js"><link rel="prefetch" href="/assets/js/433.fd9590fb.js"><link rel="prefetch" href="/assets/js/434.a071a883.js"><link rel="prefetch" href="/assets/js/435.b43d72f5.js"><link rel="prefetch" href="/assets/js/436.b6cc4c7e.js"><link rel="prefetch" href="/assets/js/437.b82f1ba6.js"><link rel="prefetch" href="/assets/js/438.c7cdd003.js"><link rel="prefetch" href="/assets/js/439.62205b84.js"><link rel="prefetch" href="/assets/js/44.60a3a5c4.js"><link rel="prefetch" href="/assets/js/440.1bb4c051.js"><link rel="prefetch" href="/assets/js/441.bb2ab767.js"><link rel="prefetch" href="/assets/js/442.fd634853.js"><link rel="prefetch" href="/assets/js/443.2c83c8a0.js"><link rel="prefetch" href="/assets/js/444.2a65abd8.js"><link rel="prefetch" href="/assets/js/445.c67e96eb.js"><link rel="prefetch" href="/assets/js/446.1f229940.js"><link rel="prefetch" href="/assets/js/447.bdda1c4c.js"><link rel="prefetch" href="/assets/js/448.dc52e6f4.js"><link rel="prefetch" href="/assets/js/449.23958348.js"><link rel="prefetch" href="/assets/js/45.4ecc9166.js"><link rel="prefetch" href="/assets/js/450.7ea48cd3.js"><link rel="prefetch" href="/assets/js/451.2f4ef468.js"><link rel="prefetch" href="/assets/js/452.232a3747.js"><link rel="prefetch" href="/assets/js/453.c19c9493.js"><link rel="prefetch" href="/assets/js/454.10ef5ecd.js"><link rel="prefetch" href="/assets/js/455.8b534044.js"><link rel="prefetch" href="/assets/js/456.97cc7756.js"><link rel="prefetch" href="/assets/js/457.47caf365.js"><link rel="prefetch" href="/assets/js/458.b642097f.js"><link rel="prefetch" href="/assets/js/459.6c0f0bab.js"><link rel="prefetch" href="/assets/js/46.a2a97498.js"><link rel="prefetch" href="/assets/js/460.d4b716da.js"><link rel="prefetch" href="/assets/js/461.b3bc6aa1.js"><link rel="prefetch" href="/assets/js/462.261958e2.js"><link rel="prefetch" href="/assets/js/463.d2522029.js"><link rel="prefetch" href="/assets/js/464.fc287b93.js"><link rel="prefetch" href="/assets/js/465.e1b6a702.js"><link rel="prefetch" href="/assets/js/466.603fd881.js"><link rel="prefetch" href="/assets/js/467.4be682df.js"><link rel="prefetch" href="/assets/js/468.867411e9.js"><link rel="prefetch" href="/assets/js/469.9abd953c.js"><link rel="prefetch" href="/assets/js/47.2f079d35.js"><link rel="prefetch" href="/assets/js/470.57efab94.js"><link rel="prefetch" href="/assets/js/471.986e8f8c.js"><link rel="prefetch" href="/assets/js/472.06c4fa13.js"><link rel="prefetch" href="/assets/js/473.bb917d33.js"><link rel="prefetch" href="/assets/js/474.a96a06da.js"><link rel="prefetch" href="/assets/js/475.be817991.js"><link rel="prefetch" href="/assets/js/476.d8e6aab7.js"><link rel="prefetch" href="/assets/js/477.8a154034.js"><link rel="prefetch" href="/assets/js/478.74ab706c.js"><link rel="prefetch" href="/assets/js/479.c68341d9.js"><link rel="prefetch" href="/assets/js/48.5eeb8a44.js"><link rel="prefetch" href="/assets/js/480.d8f2fef3.js"><link rel="prefetch" href="/assets/js/481.3b1e928d.js"><link rel="prefetch" href="/assets/js/482.fd62d7b9.js"><link rel="prefetch" href="/assets/js/483.644a32e4.js"><link rel="prefetch" href="/assets/js/484.2c56c65a.js"><link rel="prefetch" href="/assets/js/485.75f8e02c.js"><link rel="prefetch" href="/assets/js/486.f169c4a6.js"><link rel="prefetch" href="/assets/js/487.c0fc1d0e.js"><link rel="prefetch" href="/assets/js/488.2450c255.js"><link rel="prefetch" href="/assets/js/489.36f0d0ed.js"><link rel="prefetch" href="/assets/js/49.43b5a8fe.js"><link rel="prefetch" href="/assets/js/490.c0fbfc79.js"><link rel="prefetch" href="/assets/js/491.4ef937f8.js"><link rel="prefetch" href="/assets/js/492.814248ac.js"><link rel="prefetch" href="/assets/js/493.65c8c9ff.js"><link rel="prefetch" href="/assets/js/494.e9fd53b1.js"><link rel="prefetch" href="/assets/js/495.06ce1b89.js"><link rel="prefetch" href="/assets/js/496.6ef29da3.js"><link rel="prefetch" href="/assets/js/497.d2b567f2.js"><link rel="prefetch" href="/assets/js/498.a696783a.js"><link rel="prefetch" href="/assets/js/499.3519597a.js"><link rel="prefetch" href="/assets/js/5.bdbe3014.js"><link rel="prefetch" href="/assets/js/50.51e57417.js"><link rel="prefetch" href="/assets/js/500.2da4db9f.js"><link rel="prefetch" href="/assets/js/501.9e84d79d.js"><link rel="prefetch" href="/assets/js/502.0b1f1ee6.js"><link rel="prefetch" href="/assets/js/503.16853c6e.js"><link rel="prefetch" href="/assets/js/504.01ff87fe.js"><link rel="prefetch" href="/assets/js/505.bb7450bf.js"><link rel="prefetch" href="/assets/js/506.fc2f8a19.js"><link rel="prefetch" href="/assets/js/507.6f711555.js"><link rel="prefetch" href="/assets/js/508.35c48a49.js"><link rel="prefetch" href="/assets/js/509.221af1e6.js"><link rel="prefetch" href="/assets/js/51.aef419f4.js"><link rel="prefetch" href="/assets/js/510.c96e4dc0.js"><link rel="prefetch" href="/assets/js/511.a1d377ff.js"><link rel="prefetch" href="/assets/js/512.88776012.js"><link rel="prefetch" href="/assets/js/513.c708de91.js"><link rel="prefetch" href="/assets/js/514.db14718e.js"><link rel="prefetch" href="/assets/js/515.879b8ccc.js"><link rel="prefetch" href="/assets/js/516.7152f397.js"><link rel="prefetch" href="/assets/js/517.21928a12.js"><link rel="prefetch" href="/assets/js/518.b6368128.js"><link rel="prefetch" href="/assets/js/519.d4c0d627.js"><link rel="prefetch" href="/assets/js/52.0ea32a87.js"><link rel="prefetch" href="/assets/js/520.7261308b.js"><link rel="prefetch" href="/assets/js/521.effa00ad.js"><link rel="prefetch" href="/assets/js/522.7922068d.js"><link rel="prefetch" href="/assets/js/523.ca05bb88.js"><link rel="prefetch" href="/assets/js/524.847464a8.js"><link rel="prefetch" href="/assets/js/525.6ea37be1.js"><link rel="prefetch" href="/assets/js/526.c2ffdc32.js"><link rel="prefetch" href="/assets/js/527.a42e0cb4.js"><link rel="prefetch" href="/assets/js/528.3036c125.js"><link rel="prefetch" href="/assets/js/529.5f35b218.js"><link rel="prefetch" href="/assets/js/53.a675003b.js"><link rel="prefetch" href="/assets/js/530.32e6ff9a.js"><link rel="prefetch" href="/assets/js/531.1d052765.js"><link rel="prefetch" href="/assets/js/532.e193e281.js"><link rel="prefetch" href="/assets/js/533.46144301.js"><link rel="prefetch" href="/assets/js/534.527e1550.js"><link rel="prefetch" href="/assets/js/535.48d8f2ef.js"><link rel="prefetch" href="/assets/js/536.daa89088.js"><link rel="prefetch" href="/assets/js/537.754ebdfe.js"><link rel="prefetch" href="/assets/js/538.29948ac3.js"><link rel="prefetch" href="/assets/js/539.7ee98087.js"><link rel="prefetch" href="/assets/js/54.69b15868.js"><link rel="prefetch" href="/assets/js/540.bb605d82.js"><link rel="prefetch" href="/assets/js/541.3c1a92e4.js"><link rel="prefetch" href="/assets/js/542.f720dc45.js"><link rel="prefetch" href="/assets/js/543.e3300b33.js"><link rel="prefetch" href="/assets/js/544.aa2be3bc.js"><link rel="prefetch" href="/assets/js/545.1be71ebc.js"><link rel="prefetch" href="/assets/js/546.2ae30677.js"><link rel="prefetch" href="/assets/js/547.f1eb5c82.js"><link rel="prefetch" href="/assets/js/548.afe053b3.js"><link rel="prefetch" href="/assets/js/549.0fa20de2.js"><link rel="prefetch" href="/assets/js/55.16e31180.js"><link rel="prefetch" href="/assets/js/550.d1218c6b.js"><link rel="prefetch" href="/assets/js/551.03bbe561.js"><link rel="prefetch" href="/assets/js/552.4258de00.js"><link rel="prefetch" href="/assets/js/553.fae22d64.js"><link rel="prefetch" href="/assets/js/554.a1de6989.js"><link rel="prefetch" href="/assets/js/555.89299f39.js"><link rel="prefetch" href="/assets/js/556.b3a3e1bf.js"><link rel="prefetch" href="/assets/js/557.7571494d.js"><link rel="prefetch" href="/assets/js/558.39dcf4cc.js"><link rel="prefetch" href="/assets/js/559.35b2ac5d.js"><link rel="prefetch" href="/assets/js/56.b0c4f131.js"><link rel="prefetch" href="/assets/js/560.a24a7313.js"><link rel="prefetch" href="/assets/js/561.824ea25f.js"><link rel="prefetch" href="/assets/js/562.a814d4ff.js"><link rel="prefetch" href="/assets/js/563.7b26c068.js"><link rel="prefetch" href="/assets/js/564.69a310f3.js"><link rel="prefetch" href="/assets/js/565.1574e33b.js"><link rel="prefetch" href="/assets/js/566.13564bd4.js"><link rel="prefetch" href="/assets/js/567.469eb27c.js"><link rel="prefetch" href="/assets/js/568.a21fc9be.js"><link rel="prefetch" href="/assets/js/569.9451d87f.js"><link rel="prefetch" href="/assets/js/57.cc5907e3.js"><link rel="prefetch" href="/assets/js/570.23a93abd.js"><link rel="prefetch" href="/assets/js/571.329379b7.js"><link rel="prefetch" href="/assets/js/572.8eae719e.js"><link rel="prefetch" href="/assets/js/573.e9f66fb2.js"><link rel="prefetch" href="/assets/js/574.13437590.js"><link rel="prefetch" href="/assets/js/575.89a62043.js"><link rel="prefetch" href="/assets/js/576.c65ea9c1.js"><link rel="prefetch" href="/assets/js/577.3feeffe3.js"><link rel="prefetch" href="/assets/js/578.1e3a138e.js"><link rel="prefetch" href="/assets/js/579.99e0d91b.js"><link rel="prefetch" href="/assets/js/58.f18a0092.js"><link rel="prefetch" href="/assets/js/580.14d6039b.js"><link rel="prefetch" href="/assets/js/581.673167b5.js"><link rel="prefetch" href="/assets/js/582.f5d7d5a1.js"><link rel="prefetch" href="/assets/js/583.cbd2660c.js"><link rel="prefetch" href="/assets/js/584.ce096077.js"><link rel="prefetch" href="/assets/js/585.03aa88fc.js"><link rel="prefetch" href="/assets/js/586.05599247.js"><link rel="prefetch" href="/assets/js/587.05947a43.js"><link rel="prefetch" href="/assets/js/588.732a8f38.js"><link rel="prefetch" href="/assets/js/589.bbe25597.js"><link rel="prefetch" href="/assets/js/59.ce268dd0.js"><link rel="prefetch" href="/assets/js/590.deae8a16.js"><link rel="prefetch" href="/assets/js/591.6dda25a3.js"><link rel="prefetch" href="/assets/js/592.d0b12c8f.js"><link rel="prefetch" href="/assets/js/593.1485ac69.js"><link rel="prefetch" href="/assets/js/594.27aa9f1b.js"><link rel="prefetch" href="/assets/js/595.62dd1621.js"><link rel="prefetch" href="/assets/js/596.76ea6f8c.js"><link rel="prefetch" href="/assets/js/597.0a6db182.js"><link rel="prefetch" href="/assets/js/598.b5a7d148.js"><link rel="prefetch" href="/assets/js/599.c5d6769d.js"><link rel="prefetch" href="/assets/js/6.9180a290.js"><link rel="prefetch" href="/assets/js/60.452b59a7.js"><link rel="prefetch" href="/assets/js/600.b1118e84.js"><link rel="prefetch" href="/assets/js/601.8cb2cb8e.js"><link rel="prefetch" href="/assets/js/602.017d72ed.js"><link rel="prefetch" href="/assets/js/603.3040f246.js"><link rel="prefetch" href="/assets/js/604.e5368b8d.js"><link rel="prefetch" href="/assets/js/605.e553dced.js"><link rel="prefetch" href="/assets/js/606.ce7c0bd5.js"><link rel="prefetch" href="/assets/js/607.cf6f6fdf.js"><link rel="prefetch" href="/assets/js/608.e2118d62.js"><link rel="prefetch" href="/assets/js/609.099a7557.js"><link rel="prefetch" href="/assets/js/61.d2fd31d6.js"><link rel="prefetch" href="/assets/js/610.218a0531.js"><link rel="prefetch" href="/assets/js/611.7a61e18d.js"><link rel="prefetch" href="/assets/js/612.5e138a18.js"><link rel="prefetch" href="/assets/js/613.5d73afd8.js"><link rel="prefetch" href="/assets/js/614.d8af26b5.js"><link rel="prefetch" href="/assets/js/615.1de79450.js"><link rel="prefetch" href="/assets/js/616.9555b7dd.js"><link rel="prefetch" href="/assets/js/617.59ac4db7.js"><link rel="prefetch" href="/assets/js/618.e0b4e9d8.js"><link rel="prefetch" href="/assets/js/619.c74fbc7d.js"><link rel="prefetch" href="/assets/js/62.bfb787fa.js"><link rel="prefetch" href="/assets/js/620.6437df6e.js"><link rel="prefetch" href="/assets/js/621.cc3cb0ac.js"><link rel="prefetch" href="/assets/js/622.87c8979a.js"><link rel="prefetch" href="/assets/js/623.d284c9e3.js"><link rel="prefetch" href="/assets/js/624.fea80144.js"><link rel="prefetch" href="/assets/js/625.c3475da3.js"><link rel="prefetch" href="/assets/js/626.791c8f03.js"><link rel="prefetch" href="/assets/js/627.4ad1941b.js"><link rel="prefetch" href="/assets/js/628.9dac6ee1.js"><link rel="prefetch" href="/assets/js/629.bac92225.js"><link rel="prefetch" href="/assets/js/63.301d0aa4.js"><link rel="prefetch" href="/assets/js/630.2218fa92.js"><link rel="prefetch" href="/assets/js/631.4be1487c.js"><link rel="prefetch" href="/assets/js/632.e527e02d.js"><link rel="prefetch" href="/assets/js/633.8f2e6120.js"><link rel="prefetch" href="/assets/js/634.67cfe34b.js"><link rel="prefetch" href="/assets/js/635.98750be5.js"><link rel="prefetch" href="/assets/js/636.fc68c03d.js"><link rel="prefetch" href="/assets/js/637.b1e71f2a.js"><link rel="prefetch" href="/assets/js/638.bcc97a8e.js"><link rel="prefetch" href="/assets/js/639.d528f731.js"><link rel="prefetch" href="/assets/js/64.bf8570fc.js"><link rel="prefetch" href="/assets/js/640.68b5f79d.js"><link rel="prefetch" href="/assets/js/641.02f53b72.js"><link rel="prefetch" href="/assets/js/642.730c56e8.js"><link rel="prefetch" href="/assets/js/643.7e79d5d8.js"><link rel="prefetch" href="/assets/js/644.d3d41010.js"><link rel="prefetch" href="/assets/js/645.ef636ddd.js"><link rel="prefetch" href="/assets/js/646.499ed862.js"><link rel="prefetch" href="/assets/js/647.31e78ba4.js"><link rel="prefetch" href="/assets/js/648.6b61b9ea.js"><link rel="prefetch" href="/assets/js/649.e703d5aa.js"><link rel="prefetch" href="/assets/js/65.77132072.js"><link rel="prefetch" href="/assets/js/650.ee63cc59.js"><link rel="prefetch" href="/assets/js/651.33b9eb36.js"><link rel="prefetch" href="/assets/js/652.ef35a0a8.js"><link rel="prefetch" href="/assets/js/653.2fba33b4.js"><link rel="prefetch" href="/assets/js/654.2fce6f2b.js"><link rel="prefetch" href="/assets/js/655.aa43d15a.js"><link rel="prefetch" href="/assets/js/656.1a43a0a6.js"><link rel="prefetch" href="/assets/js/657.a4641a43.js"><link rel="prefetch" href="/assets/js/658.8a7d1c0a.js"><link rel="prefetch" href="/assets/js/659.22529255.js"><link rel="prefetch" href="/assets/js/66.15254072.js"><link rel="prefetch" href="/assets/js/660.ff29789d.js"><link rel="prefetch" href="/assets/js/661.13e524e6.js"><link rel="prefetch" href="/assets/js/662.b3fe9d78.js"><link rel="prefetch" href="/assets/js/663.fa72128b.js"><link rel="prefetch" href="/assets/js/664.8920984a.js"><link rel="prefetch" href="/assets/js/665.5c33957c.js"><link rel="prefetch" href="/assets/js/666.541f7ff0.js"><link rel="prefetch" href="/assets/js/667.9a8c270f.js"><link rel="prefetch" href="/assets/js/668.daee2330.js"><link rel="prefetch" href="/assets/js/669.08e9f304.js"><link rel="prefetch" href="/assets/js/67.17fe092c.js"><link rel="prefetch" href="/assets/js/670.6cc1963a.js"><link rel="prefetch" href="/assets/js/671.5d3d74d1.js"><link rel="prefetch" href="/assets/js/672.7c74299d.js"><link rel="prefetch" href="/assets/js/673.f6d5b553.js"><link rel="prefetch" href="/assets/js/674.2969064d.js"><link rel="prefetch" href="/assets/js/68.60afc773.js"><link rel="prefetch" href="/assets/js/69.452131e8.js"><link rel="prefetch" href="/assets/js/7.c5dab81d.js"><link rel="prefetch" href="/assets/js/70.9b3bf8ad.js"><link rel="prefetch" href="/assets/js/71.b66684c1.js"><link rel="prefetch" href="/assets/js/72.97945bdf.js"><link rel="prefetch" href="/assets/js/73.871989da.js"><link rel="prefetch" href="/assets/js/74.931a6b08.js"><link rel="prefetch" href="/assets/js/75.f59920eb.js"><link rel="prefetch" href="/assets/js/76.631f9db0.js"><link rel="prefetch" href="/assets/js/77.c36f7b96.js"><link rel="prefetch" href="/assets/js/78.2f61eda3.js"><link rel="prefetch" href="/assets/js/79.8c723213.js"><link rel="prefetch" href="/assets/js/8.1a320525.js"><link rel="prefetch" href="/assets/js/80.f2ae23ce.js"><link rel="prefetch" href="/assets/js/81.bbb60795.js"><link rel="prefetch" href="/assets/js/82.06c7ca81.js"><link rel="prefetch" href="/assets/js/83.a83fc715.js"><link rel="prefetch" href="/assets/js/84.edcd8c27.js"><link rel="prefetch" href="/assets/js/85.d31eee28.js"><link rel="prefetch" href="/assets/js/86.10ec3513.js"><link rel="prefetch" href="/assets/js/87.051fdd23.js"><link rel="prefetch" href="/assets/js/88.4f49be9c.js"><link rel="prefetch" href="/assets/js/89.59877c73.js"><link rel="prefetch" href="/assets/js/9.a9688781.js"><link rel="prefetch" href="/assets/js/90.fd306930.js"><link rel="prefetch" href="/assets/js/91.8ba84d12.js"><link rel="prefetch" href="/assets/js/92.8660a55b.js"><link rel="prefetch" href="/assets/js/93.f5aa6f9d.js"><link rel="prefetch" href="/assets/js/94.f6320e1d.js"><link rel="prefetch" href="/assets/js/95.7aee9644.js"><link rel="prefetch" href="/assets/js/96.270b077f.js"><link rel="prefetch" href="/assets/js/97.2bf3e71f.js"><link rel="prefetch" href="/assets/js/98.7925b0c9.js"><link rel="prefetch" href="/assets/js/99.d45e8282.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b7548b6d.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/note.png" alt="mznote" class="logo"> <span class="site-name can-hide">mznote</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础知识" class="dropdown-title"><a href="/knowledge/" class="link-title">基础知识</a> <span class="title" style="display:none;">基础知识</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/01.基础知识/10.离散数学/" class="nav-link">离散数学</a></li><li class="dropdown-item"><!----> <a href="/01.基础知识/11.具体数学/" class="nav-link">具体数学</a></li><li class="dropdown-item"><!----> <a href="/01.基础知识/12.CSAPP/" class="nav-link">CSAPP</a></li><li class="dropdown-item"><!----> <a href="/01.基础知识/13.数据结构/" class="nav-link">数据结构</a></li><li class="dropdown-item"><!----> <a href="/01.基础知识/15.算法导论/" class="nav-link">算法导论</a></li><li class="dropdown-item"><!----> <a href="/01.基础知识/17.计算机组成原理/" class="nav-link">计算机组成原理</a></li><li class="dropdown-item"><!----> <a href="/01.基础知识/20.编译原理/" class="nav-link">编译原理</a></li><li class="dropdown-item"><!----> <a href="/01.基础知识/25.计算机网络/" class="nav-link">计算机网络</a></li><li class="dropdown-item"><!----> <a href="/01.基础知识/27.操作系统/" class="nav-link">操作系统</a></li><li class="dropdown-item"><!----> <a href="/01.基础知识/30.数据库系统/" class="nav-link">数据库系统</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程语言" class="dropdown-title"><a href="/language/" class="link-title">编程语言</a> <span class="title" style="display:none;">编程语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/02.编程语言/02.C/" class="nav-link">C</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="实用技术" class="dropdown-title"><a href="/technology/" class="link-title">实用技术</a> <span class="title" style="display:none;">实用技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/03.实用技术/01.Linux/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/03.实用技术/02.VScode/" class="nav-link">VScode</a></li><li class="dropdown-item"><!----> <a href="/03.实用技术/03.GitHub/" class="nav-link">GitHub</a></li><li class="dropdown-item"><!----> <a href="/03.实用技术/19.Vuepress/" class="nav-link">Vuepress</a></li><li class="dropdown-item"><!----> <a href="/03.实用技术/20.实用工具/" class="nav-link">实用工具</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/99.日课/2022.2022年/01.01月/" class="nav-link">学习日课</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/sbwcwso/sbwcwso.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatar.png"> <div class="blogger-info"><h3>木子识时务</h3> <span>CS小白，努力进步中 🏃</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础知识" class="dropdown-title"><a href="/knowledge/" class="link-title">基础知识</a> <span class="title" style="display:none;">基础知识</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/01.基础知识/10.离散数学/" class="nav-link">离散数学</a></li><li class="dropdown-item"><!----> <a href="/01.基础知识/11.具体数学/" class="nav-link">具体数学</a></li><li class="dropdown-item"><!----> <a href="/01.基础知识/12.CSAPP/" class="nav-link">CSAPP</a></li><li class="dropdown-item"><!----> <a href="/01.基础知识/13.数据结构/" class="nav-link">数据结构</a></li><li class="dropdown-item"><!----> <a href="/01.基础知识/15.算法导论/" class="nav-link">算法导论</a></li><li class="dropdown-item"><!----> <a href="/01.基础知识/17.计算机组成原理/" class="nav-link">计算机组成原理</a></li><li class="dropdown-item"><!----> <a href="/01.基础知识/20.编译原理/" class="nav-link">编译原理</a></li><li class="dropdown-item"><!----> <a href="/01.基础知识/25.计算机网络/" class="nav-link">计算机网络</a></li><li class="dropdown-item"><!----> <a href="/01.基础知识/27.操作系统/" class="nav-link">操作系统</a></li><li class="dropdown-item"><!----> <a href="/01.基础知识/30.数据库系统/" class="nav-link">数据库系统</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程语言" class="dropdown-title"><a href="/language/" class="link-title">编程语言</a> <span class="title" style="display:none;">编程语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/02.编程语言/02.C/" class="nav-link">C</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="实用技术" class="dropdown-title"><a href="/technology/" class="link-title">实用技术</a> <span class="title" style="display:none;">实用技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/03.实用技术/01.Linux/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/03.实用技术/02.VScode/" class="nav-link">VScode</a></li><li class="dropdown-item"><!----> <a href="/03.实用技术/03.GitHub/" class="nav-link">GitHub</a></li><li class="dropdown-item"><!----> <a href="/03.实用技术/19.Vuepress/" class="nav-link">Vuepress</a></li><li class="dropdown-item"><!----> <a href="/03.实用技术/20.实用工具/" class="nav-link">实用工具</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/99.日课/2022.2022年/01.01月/" class="nav-link">学习日课</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/sbwcwso/sbwcwso.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/01.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/10.%E7%A6%BB%E6%95%A3%E6%95%B0%E5%AD%A6/" class="sidebar-heading clickable"><span>离散数学</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/01.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/11.%E5%85%B7%E4%BD%93%E6%95%B0%E5%AD%A6/" class="sidebar-heading clickable"><span>具体数学</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/01.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/12.CSAPP/" class="sidebar-heading clickable open"><span>CSAPP</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/01.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/12.CSAPP/01.%E4%B9%A6%E6%9C%AC%E9%98%85%E8%AF%BB/" class="sidebar-heading clickable open"><span>书本阅读</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/cad752/" class="sidebar-link">第 2 章 信息的表示和处理</a></li><li><a href="/pages/306a79/" class="sidebar-link">第 3 章 程序的机器级表示</a></li><li><a href="/pages/e760c3/" class="sidebar-link">第 4 章 处理器体系结构</a></li><li><a href="/pages/ac0011/" class="sidebar-link">第 5 章 优化程序性能</a></li><li><a href="/pages/4d33d6/" class="sidebar-link">第 6 章 存储器层次结构</a></li><li><a href="/pages/c4f6e6/" class="sidebar-link">第 7 章 链接</a></li><li><a href="/pages/fb3a2a/" class="sidebar-link">第 8 章 异常控制流</a></li><li><a href="/pages/b732ba/" aria-current="page" class="active sidebar-link">第 9 章 虚拟内存</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/b732ba/#91-物理和虚拟寻址" class="sidebar-link">9.1 物理和虚拟寻址</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#92-地址空间" class="sidebar-link">9.2 地址空间</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#93-虚拟内存作为缓存工具" class="sidebar-link">9.3 虚拟内存作为缓存工具</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/b732ba/#931-dram-缓存的组织结构" class="sidebar-link">9.3.1 DRAM 缓存的组织结构</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#932-页表" class="sidebar-link">9.3.2 页表</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#933-页命中" class="sidebar-link">9.3.3 页命中</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#934-缺页" class="sidebar-link">9.3.4 缺页</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#935-分配页面" class="sidebar-link">9.3.5 分配页面</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#936-又是局部性救了我们" class="sidebar-link">9.3.6 又是局部性救了我们</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#94-虚拟内存作为内存管理的工具" class="sidebar-link">9.4 虚拟内存作为内存管理的工具</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#95-虚拟内存作为内存保护的工具" class="sidebar-link">9.5 虚拟内存作为内存保护的工具</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#96-地址翻译" class="sidebar-link">9.6 地址翻译</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/b732ba/#961-结合高速缓存和虚拟内存" class="sidebar-link">9.6.1 结合高速缓存和虚拟内存</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#962-利用-tlb-加速地址翻译" class="sidebar-link">9.6.2 利用 TLB 加速地址翻译</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#963-多级页表" class="sidebar-link">9.6.3 多级页表</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#964-综合-端到端的地址翻译" class="sidebar-link">9.6.4 综合: 端到端的地址翻译</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#97-案例研究-intel-core-i7linux-内存系统" class="sidebar-link">9.7 案例研究: Intel Core i7/Linux 内存系统</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/b732ba/#971-core-i7-地址翻译" class="sidebar-link">9.7.1 Core i7 地址翻译</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#972-linux-虚拟内存系统" class="sidebar-link">9.7.2 Linux 虚拟内存系统</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#98-内存映射" class="sidebar-link">9.8 内存映射</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/b732ba/#981-再看共享对象" class="sidebar-link">9.8.1 再看共享对象</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#982-再看-fork-函数" class="sidebar-link">9.8.2 再看 fork 函数</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#983-再看-execve-函数" class="sidebar-link">9.8.3 再看 execve 函数</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#984-使用-mmap-函数的用户级内存映射" class="sidebar-link">9.8.4 使用 mmap 函数的用户级内存映射</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#99-动态内存分配" class="sidebar-link">9.9 动态内存分配</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/b732ba/#991-malloc-和-free-函数" class="sidebar-link">9.9.1 malloc 和 free 函数</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#992-为什么使用动态内存分配" class="sidebar-link">9.9.2 为什么使用动态内存分配</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#993-分配器的要求和目标" class="sidebar-link">9.9.3 分配器的要求和目标</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#994-碎片" class="sidebar-link">9.9.4 碎片</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#995-实现问题" class="sidebar-link">9.9.5 实现问题</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#996-隐式空闲链表" class="sidebar-link">9.9.6 隐式空闲链表</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#997-放置已分配的块" class="sidebar-link">9.9.7 放置已分配的块</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#998-分割空闲块" class="sidebar-link">9.9.8 分割空闲块</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#999-获取额外的堆内存" class="sidebar-link">9.9.9 获取额外的堆内存</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#9910-合并空闲块" class="sidebar-link">9.9.10 合并空闲块</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#9911-带边界标记的合并" class="sidebar-link">9.9.11 带边界标记的合并</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#9912-综合-实现一个简单的分配器" class="sidebar-link">9.9.12 综合: 实现一个简单的分配器</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#9913-显式空闲链表" class="sidebar-link">9.9.13 显式空闲链表</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#9914-分离的空闲链表" class="sidebar-link">9.9.14 分离的空闲链表</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#910-垃圾收集" class="sidebar-link">9.10 垃圾收集</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/b732ba/#9101-垃圾收集器的基本知识" class="sidebar-link">9.10.1 垃圾收集器的基本知识</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#9102-mark--sweep-垃圾收集器" class="sidebar-link">9.10.2 Mark &amp; Sweep 垃圾收集器</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#9103-c-程序的保守的-mark--sweep" class="sidebar-link">9.10.3 C 程序的保守的 Mark &amp; Sweep</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#911-c-程序中常见的与内存有关的错误" class="sidebar-link">9.11 C 程序中常见的与内存有关的错误</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/b732ba/#9111-间接引用坏指针" class="sidebar-link">9.11.1 间接引用坏指针</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#9112-读未初始化的内存" class="sidebar-link">9.11.2 读未初始化的内存</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#9113-允许栈缓冲溢出" class="sidebar-link">9.11.3 允许栈缓冲溢出</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#9114-假设指针和它们指向的对象是相同大小的" class="sidebar-link">9.11.4 假设指针和它们指向的对象是相同大小的</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#9115-造成错位错误" class="sidebar-link">9.11.5 造成错位错误</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#9116-引用指针，而不是它所指向的对象" class="sidebar-link">9.11.6 引用指针，而不是它所指向的对象</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#9117-误解指针运算" class="sidebar-link">9.11.7 误解指针运算</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#9118-引用不存在的变量" class="sidebar-link">9.11.8 引用不存在的变量</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#9119-引用空闲堆块中的数据" class="sidebar-link">9.11.9 引用空闲堆块中的数据</a></li><li class="sidebar-sub-header"><a href="/pages/b732ba/#91110-引起内存泄漏" class="sidebar-link">9.11.10 引起内存泄漏</a></li></ul></li></ul></li><li><a href="/pages/41d266/" class="sidebar-link">第 10 章 系统级I/O</a></li><li><a href="/pages/e95797/" class="sidebar-link">第 11 章 网络编程</a></li><li><a href="/pages/6f6eba/" class="sidebar-link">第 12 章 并发编程</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/01.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/12.CSAPP/02.lab/" class="sidebar-heading clickable"><span>lab</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/01.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/12.CSAPP/03.%E5%85%AC%E5%BC%80%E8%AF%BE%E7%AC%94%E8%AE%B0/" class="sidebar-heading clickable"><span>公开课笔记</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/01.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/13.%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" class="sidebar-heading clickable"><span>数据结构</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/01.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/15.%E7%AE%97%E6%B3%95/" class="sidebar-heading clickable"><span>算法</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/01.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/17.%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/" class="sidebar-heading clickable"><span>计算机组成原理</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/01.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/20.%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" class="sidebar-heading clickable"><span>编译原理</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/01.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/25.%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" class="sidebar-heading clickable"><span>计算机网络</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/01.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/27.%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" class="sidebar-heading clickable"><span>操作系统</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/01.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/30.%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F/" class="sidebar-heading clickable"><span>数据库系统</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/01.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/40.%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/" class="sidebar-heading clickable"><span>软件工程</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-67beffb9><div class="articleInfo" data-v-67beffb9><ul class="breadcrumbs" data-v-67beffb9><li data-v-67beffb9><a href="/" class="iconfont icon-home router-link-active" data-v-67beffb9></a></li> <li data-v-67beffb9><a href="/01.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" data-v-67beffb9>
          基础知识
        </a></li><li data-v-67beffb9><a href="/01.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/12.CSAPP/" data-v-67beffb9>
          CSAPP
        </a></li><li data-v-67beffb9><a href="/01.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/12.CSAPP/01.%E4%B9%A6%E6%9C%AC%E9%98%85%E8%AF%BB/" data-v-67beffb9>
          书本阅读
        </a></li> <li data-v-67beffb9>第 9 章 虚拟内存</li></ul> <div class="info" data-v-67beffb9><div title="作者" class="author iconfont icon-touxiang" data-v-67beffb9><a href="https://github.com/sbwcwso" target="_blank" title="作者" class="beLink" data-v-67beffb9>木子识时务</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-67beffb9><a href="javascript:;" data-v-67beffb9>2022-02-25</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">
          第 9 章 虚拟内存
        </h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="第-9-章-虚拟内存"><a href="#第-9-章-虚拟内存" class="header-anchor">#</a> 第 9 章 虚拟内存</h1> <div class="custom-block tip"><p class="custom-block-title">虚拟内存是对主存的一个抽象</p> <ul><li>虚拟内存提供了三个重要的能力
<ul><li>它将主存看成是一个存储在磁盘上的地址空间的高速缓存
<ul><li>在主存中只保存活动区域
<ul><li>并根据需要在磁盘和主存之间来回传送数据</li></ul></li> <li>通过这种方式，它高效地使用了主存</li></ul></li> <li>它为每个进程提供了一致的地址空间，从而简化了内存管理</li> <li>它保护了每个进程的地址空间不被其他进程破坏</li></ul></li></ul></div> <div class="vuepress-markmap"><svg id="markmap_382ee1aa"></svg></div><h2 id="91-物理和虚拟寻址"><a href="#91-物理和虚拟寻址" class="header-anchor">#</a> 9.1 物理和虚拟寻址</h2> <div class="custom-block note"><p class="custom-block-title">物理寻址</p> <ul><li>物理地址 （Physical Address，PA）
<ul><li>计算机系统的主存被组织成一个由 M 个连续的<strong>字节</strong>大小的单元组成的数组</li> <li>每字节都有一个唯一的物理地址
<ul><li>第一个字节的地址为 0，接下来的字节地址为 1，再下一个为 2，依此类推</li></ul></li></ul></li> <li>使用物理地址访问内存，即被称为物理寻址（physical addressing）</li> <li>一个使用物理寻址的系统
<ul><li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220311105936-2022-03-11-10-59-36.png" alt="20220311105936-2022-03-11-10-59-36"></li></ul></li> <li>早期的 PC 使用物理寻址
<ul><li>而且诸如数字信号处理器、嵌入式微控制器以及 Cray 超级计算机这样的系统仍然继续使用这种寻址方式</li></ul></li></ul></div> <div class="custom-block tip"><p class="custom-block-title">虚拟寻址</p> <ul><li>现代处理器使用的是一种称为虚拟寻址（virtual addressing）的寻址形式
<ul><li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220311110057-2022-03-11-11-00-57.png" alt="20220311110057-2022-03-11-11-00-57"></li></ul></li> <li>使用虚拟寻址，CPU 通过生成一个虚拟地址（Virtual Address，VA）来访问主存</li> <li>将一个虚拟地址转换为物理地址的任务叫做地址翻译（address translation）
<ul><li>地址翻译需要 CPU 硬件和操作系统之间的紧密合作
<ul><li>CPU 芯片上叫做内存管理单元（Memory Management Unit，MMU）的专用硬件
<ul><li>其利用存放在主存中的查询表来动态翻译虚拟地址</li></ul></li> <li>该查询表的内容由操作系统管理</li></ul></li></ul></li></ul></div> <h2 id="92-地址空间"><a href="#92-地址空间" class="header-anchor">#</a> 9.2 地址空间</h2> <div class="custom-block note"><p class="custom-block-title">地址空间（address space）是一个非负整数地址的有序集合</p> <ul><li>如果地址空间中的整数是连续的，则它是一个<strong>线性地址空间</strong>（linear address space）</li> <li>地址空间分为<strong>虚拟地址空间</strong>（virtual address space）和<strong>物理地址空间</strong>（physical address space）</li></ul></div> <h2 id="93-虚拟内存作为缓存工具"><a href="#93-虚拟内存作为缓存工具" class="header-anchor">#</a> 9.3 虚拟内存作为缓存工具</h2> <div class="custom-block tip"><p class="custom-block-title">页的概念</p> <ul><li>VM 系统将虚拟内存分割为称为<strong>虚拟页</strong>（Virtual Page，VP）的大小固定的块
<ul><li>这些块是磁盘和主存（较高层）之间的传输单元</li> <li>每个虚拟页的大小为 <mjx-container jax="SVG" class="MathJax"><svg xmlns="http://www.w3.org/2000/svg" width="6.84ex" height="1.731ex" role="img" focusable="false" viewBox="0 -683 3023.2 765" xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align:-0.186ex;"><defs><path id="MJX-1217-TEX-I-1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path><path id="MJX-1217-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-1217-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-1217-TEX-I-1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D443" xlink:href="#MJX-1217-TEX-I-1D443"></use></g><g data-mml-node="mo" transform="translate(1028.8,0)"><use data-c="3D" xlink:href="#MJX-1217-TEX-N-3D"></use></g><g data-mml-node="msup" transform="translate(2084.6,0)"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-1217-TEX-N-32"></use></g><g data-mml-node="mi" transform="translate(533,363) scale(0.707)"><use data-c="1D45D" xlink:href="#MJX-1217-TEX-I-1D45D"></use></g></g></g></g></svg></mjx-container> 字节</li></ul></li> <li>类似地，物理内存被分割为<strong>物理页</strong>（Physical Page，PP）
<ul><li>大小也为 <mjx-container jax="SVG" class="MathJax"><svg xmlns="http://www.w3.org/2000/svg" width="1.699ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 751 683" xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align:0;"><defs><path id="MJX-513-TEX-I-1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D443" xlink:href="#MJX-513-TEX-I-1D443"></use></g></g></g></svg></mjx-container> 字节</li> <li>物理页也被称为页帧（page frame）</li></ul></li></ul></div> <div class="custom-block note"><p class="custom-block-title">在任意时刻，虚拟页面的集合都分为三个不相交的子集</p> <ul><li>未分配的
<ul><li>VM 系统还未分配（或者创建）的页</li> <li>未分配的块没有任何数据和它们相关联，因此也就不占用任何磁盘空间</li></ul></li> <li>缓存的
<ul><li>当前已缓存在物理内存中的已分配页</li></ul></li> <li>未缓存的
<ul><li>未缓存在物理内存中的已分配页</li></ul></li> <li>示意图
<ul><li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220313102545-2022-03-13-10-25-45.png" alt="20220313102545-2022-03-13-10-25-45"></li></ul></li></ul></div> <h3 id="931-dram-缓存的组织结构"><a href="#931-dram-缓存的组织结构" class="header-anchor">#</a> 9.3.1 DRAM 缓存的组织结构</h3> <div class="custom-block tip"><p class="custom-block-title">约定用术语 SRAM 缓存来表示位于 CPU 和主存之间的 Ll、L2 和 L3 高速缓存，并且用术语 DRAM 缓存来表示虚拟内存系统的缓存，它在主存中缓存虚拟页</p></div> <div class="custom-block note"><p class="custom-block-title">DRAM 缓存的组织结构完全是由巨大的不命中开销驱动的</p> <ul><li>因为大的不命中处罚和访问第一个字节的开销，<strong>虚拟页往往很大</strong>，通常是 4KB ~ 2MB
<ul><li>读第一个字的开销是指从磁盘的扇区读取数据</li></ul></li> <li>由于大的不命中处罚，DRAM 缓存是<strong>全相联的</strong> <ul><li>即任何虚拟页都可以放置在任何的物理页中</li></ul></li></ul></div> <h3 id="932-页表"><a href="#932-页表" class="header-anchor">#</a> 9.3.2 页表</h3> <div class="custom-block tip"><p class="custom-block-title">判定虚拟页的位置</p> <ul><li>虚拟内存系统必须有某种方法来判定一个虚拟页是否缓存在 DRAM 中的某个地方
<ul><li>如果命中，系统还必须确定这个虚拟页存放在哪个物理页中</li> <li>如果不命中，系统必须判断这个虚拟页存放在磁盘的哪个位置
<ul><li>还可能需要在物理内存中选择一个牺牲页，并将虚拟页从磁盘复制到 DRAM 中，替换这个牺牲页</li></ul></li></ul></li> <li>这些功能是由软硬件联合提供的
<ul><li>包括操作系统软件、MMU（内存管理单元）中的地址翻译硬件和一个存放在物理内存中叫做**页表（page table）**的数据结构</li></ul></li></ul></div> <div class="custom-block note"><p class="custom-block-title">页表将虚拟页映射到物理页</p> <ul><li>每次地址翻译硬件将一个虚拟地址转换为物理地址时，都会读取页表</li> <li>操作系统负责维护页表的内容，以及在磁盘与 DRAM 之间来回传送页</li> <li>页表就是一个<strong>页表条目（Page Table Entry，PTE）的数组</strong> <ul><li>虚拟地址空间中的每个页在页表中一个固定偏移量处都有一个 PTE</li> <li>每个 PTE 是由一个有效位（valid bit）和一个 n 位地址字段组成的</li> <li>有效位表明了该虚拟页当前是否被缓存在 DRAM 中
<ul><li>如果设置了有效位，那么地址字段就表示 DRAM 中相应的物理页的起始位置
<ul><li>这个物理页中缓存了该虚拟页</li></ul></li> <li>如果没有设置有效位
<ul><li>那么一个空地址表示这个虚拟页还未被分配</li> <li>否则，这个地址就指向该虚拟页在磁盘上的起始位置</li></ul></li></ul></li></ul></li> <li>示意图
<ul><li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220313103902-2022-03-13-10-39-02.png" alt="20220313103902-2022-03-13-10-39-02"></li></ul></li></ul></div> <h3 id="933-页命中"><a href="#933-页命中" class="header-anchor">#</a> 9.3.3 页命中</h3> <div class="custom-block tip"><p class="custom-block-title">下图中，对 VP 2 中一个字的引用就会命中</p> <p><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220313104612-2022-03-13-10-46-12.png" alt="20220313104612-2022-03-13-10-46-12"></p></div> <h3 id="934-缺页"><a href="#934-缺页" class="header-anchor">#</a> 9.3.4 缺页</h3> <div class="custom-block note"><p class="custom-block-title">缺页的处理过程</p> <ul><li>DRAM 缓存不命中称为<strong>缺页（page fault）</strong></li> <li>缺页会触发缺页异常
<ul><li>缺页异常调用内核中的缺页异常处理程序，该程序会选择一个牺牲页</li> <li>如果此牺牲块已经被修改了，那么内核就会将它复制回磁盘</li> <li>内核会修改牺牲块的页表条目，反映出其不再缓存在主存中这一事实</li></ul></li> <li>当异常处理程序返回时，它会重新启动导致缺页的指令</li> <li>示意图
<ul><li>VM 缺页（之前）。对 VP3 中的字的引用会不命中，从而触发了缺页
<ul><li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220313154537-2022-03-13-15-45-37.png" alt="20220313154537-2022-03-13-15-45-37"></li></ul></li> <li>VM 缺页（之后）。缺页处理程序选择 VP 4 作为牺牲页，并从磁盘上用 VP 3 的副本取代它
<ul><li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220313154615-2022-03-13-15-46-15.png" alt="20220313154615-2022-03-13-15-46-15"></li></ul></li> <li>在缺页处理程序重新启动导致缺页的指令之后，该指令将从内存中正常地读取字，而不会再产生异常</li></ul></li></ul></div> <div class="custom-block tip"><p class="custom-block-title">按需调度页面</p> <ul><li>在磁盘和内存之间传送页的活动叫做<strong>交换（swapping）<strong>或者</strong>页面调度（paging）</strong></li> <li>页从磁盘换入（或者页面调入）DRAM 和从 DRAM 换出（或者页面调出）磁盘</li> <li><strong>按需页面调度（demand paging）</strong> 会一直等待，直到最后时刻
<ul><li>也就是当有不命中发生时，才换入页面</li></ul></li></ul></div> <h3 id="935-分配页面"><a href="#935-分配页面" class="header-anchor">#</a> 9.3.5 分配页面</h3> <div class="custom-block tip"><p class="custom-block-title">操作系统分配一个新的虚拟内存页的过程</p> <ul><li>示意图: VP5 的分配过程是在磁盘上创建空间并更新 PTE 5，使它指向磁盘上这个新创建的页面
<ul><li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220313155214-2022-03-13-15-52-14.png" alt="20220313155214-2022-03-13-15-52-14"></li></ul></li></ul></div> <h3 id="936-又是局部性救了我们"><a href="#936-又是局部性救了我们" class="header-anchor">#</a> 9.3.6 又是局部性救了我们</h3> <div class="custom-block note"><p class="custom-block-title">程序的局部性保证了虚拟内存的性能</p> <ul><li>尽管在整个运行过程中程序引用的不同页面的总数可能超出物理内存总的大小</li> <li>但是局部性原则保证了在任意时刻，程序将趋向于在一个较小的活动页面（active page）集合上工作
<ul><li>这个集合叫做工作集（working set）或者常驻集合（resident set）</li></ul></li> <li>在初始开销，也就是将工作集页面调度到内存中之后
<ul><li>接下来对这个工作集的引用将导致命中，而不会产生额外的磁盘流量</li></ul></li></ul></div> <div class="custom-block tip"><p class="custom-block-title">抖动</p> <ul><li>如果工作集的大小超出了物理内存的大小，这时页面将不断地换进换出
<ul><li>这种状态叫做<strong>抖动（thrashing）</strong></li></ul></li></ul></div> <h2 id="94-虚拟内存作为内存管理的工具"><a href="#94-虚拟内存作为内存管理的工具" class="header-anchor">#</a> 9.4 虚拟内存作为内存管理的工具</h2> <div class="custom-block warning"><p class="custom-block-title">按需页面调度和独立的虚拟地址空间的结合，对系统中内存的使用和管理造成了深远的影响</p></div> <div class="custom-block note"><p class="custom-block-title">VM 简化了链接和加载、代码和数据共享，以及应用程序的内存分配</p> <ul><li><div class="custom-block tip"><p class="custom-block-title">简化链接</p> <ul><li><strong>独立的地址空间</strong>允许每个进程的内存映像使用相同的基本格式
<ul><li>而不管代码和数据实际存放在物理内存的何处</li></ul></li> <li>一个给定的 Linux 系统上的每个进程都使用类似的内存格式
<ul><li>对于 64 位地址空间，代码段总是从虚拟地址 0x400000 开始</li> <li>数据段跟在代码段之后，中间有一段符合要求的对齐空白</li> <li>栈占据用户进程地址空间最高的部分，并向下生长</li></ul></li> <li>这样的一致性极大地简化了链接器的设计和实现
<ul><li>允许链接器生成完全链接的可执行文件</li> <li>这些可执行文件是独立于物理内存中代码和数据的最终位置的</li></ul></li></ul></div></li> <li><div class="custom-block tip"><p class="custom-block-title">简化加载</p> <ul><li>虚拟内存还使得容易向内存中加载可执行文件和共享对象文件</li> <li>要把目标文件中 <code>.text</code> 和 <code>.data</code> 节加载到一个新创建的进程中
<ul><li>Linux 加载器为代码和数据段分配虚拟页，把它们标记为无效的（即未被缓存的）
<ul><li>并将页表条目指向目标文件中适当的位置(一般在磁盘上)</li></ul></li> <li><strong>加载器从不从磁盘到内存实际复制任何数据</strong> <ul><li>在每个页初次被引用时
<ul><li>要么是 CPU 取指令时引用的</li> <li>要么是一条正在执行的指令引用一个内存位置时引用的</li></ul></li> <li>虚拟内存系统会<strong>按照需要</strong>自动地调入数据页</li></ul></li></ul></li></ul></div></li> <li><div class="custom-block tip"><p class="custom-block-title">简化共享</p></div></li></ul></div> <h2 id="95-虚拟内存作为内存保护的工具"><a href="#95-虚拟内存作为内存保护的工具" class="header-anchor">#</a> 9.5 虚拟内存作为内存保护的工具</h2> <div class="custom-block tip"><p class="custom-block-title">通过在 PTE 上添加一些额外的许可位来控制对一个虚拟页面内容的访问十分简单</p> <p><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220323190018-2022-03-23-19-00-18.png" alt="20220323190018-2022-03-23-19-00-18"></p> <ul><li>每个 PTE 中已经添加了三个许可位</li> <li>SUP 位表示进程是否必须运行在内核（超级用户）模式下才能访问该页
<ul><li>运行在内核模式中的进程可以访问任何页面</li> <li>运行在用户模式中的进程只允许访问那些 SUP 为 0 的页面</li></ul></li> <li>READ 位和 WRITE 位控制对页面的读和写访问</li></ul></div> <div class="custom-block warning"><p class="custom-block-title">段错误（segmentation fault）</p> <ul><li>如果一条指令违反了许可条件，那么 CPU 就触发一个一般保护故障
<ul><li>将控制传递给一个内核中的异常处理程序</li></ul></li> <li>Linux shell 一般将这种异常报告为段错误（segmentation fault）</li></ul></div> <h2 id="96-地址翻译"><a href="#96-地址翻译" class="header-anchor">#</a> 9.6 地址翻译</h2> <div class="custom-block note"><p class="custom-block-title">相关符号及其含义</p> <p><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220323190621-2022-03-23-19-06-21.png" alt="20220323190621-2022-03-23-19-06-21"></p></div> <div class="custom-block tip"><p class="custom-block-title">使用页表的地址翻译</p> <ul><li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220323190803-2022-03-23-19-08-03.png" alt="20220323190803-2022-03-23-19-08-03"></li> <li>因为物理和虚拟页面都是 P 字节的，所以物理页面偏移（Physical Page Offset，PPO）和 VPO 是相同的</li></ul></div> <div class="custom-block note"><p class="custom-block-title">页面命中时，CPU 的执行步骤</p> <p><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220323190947-2022-03-23-19-09-47.png" alt="20220323190947-2022-03-23-19-09-47"></p></div> <div class="custom-block tip"><p class="custom-block-title">缺页时，CPU 的执行步骤</p> <p><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220323191027-2022-03-23-19-10-27.png" alt="20220323191027-2022-03-23-19-10-27"></p></div> <h3 id="961-结合高速缓存和虚拟内存"><a href="#961-结合高速缓存和虚拟内存" class="header-anchor">#</a> 9.6.1 结合高速缓存和虚拟内存</h3> <div class="custom-block note"><p class="custom-block-title">将物理寻址的高速缓存与虚拟内存结合起来</p> <ul><li>将地址翻译放在调整缓存查找之前即可
<ul><li>页表条目也可以缓存，就像其他的数据字一样</li></ul></li> <li>示意图
<ul><li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220323191339-2022-03-23-19-13-39.png" alt="20220323191339-2022-03-23-19-13-39"></li></ul></li></ul></div> <h3 id="962-利用-tlb-加速地址翻译"><a href="#962-利用-tlb-加速地址翻译" class="header-anchor">#</a> 9.6.2 利用 TLB 加速地址翻译</h3> <div class="custom-block tip"><p class="custom-block-title">MMU 中包括了一个关于 PTE 的小的缓存，称为翻译后备缓冲器（Translation Lookaside Buffer，TLB）</p> <ul><li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220323191704-2022-03-23-19-17-04.png" alt="20220323191704-2022-03-23-19-17-04"></li></ul></div> <div class="custom-block note"><p class="custom-block-title">TLB 命中和不命中的操作图</p> <p><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220323191930-2022-03-23-19-19-30.png" alt="20220323191930-2022-03-23-19-19-30"></p></div> <h3 id="963-多级页表"><a href="#963-多级页表" class="header-anchor">#</a> 9.6.3 多级页表</h3> <div class="custom-block tip"><p class="custom-block-title">多级页表的目的是为了减小驻留在内存中的页表的大小</p> <ul><li>一个两级页表层次结构
<ul><li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220323194531-2022-03-23-19-45-31.png" alt="20220323194531-2022-03-23-19-45-31"></li> <li>图中一级页表中的每个 PTE 负责映射虚拟地址空间中一个 4MB 的片（chunk）</li> <li>使用 4 字节的 PTE，每个一级和二级页表都是 4KB，刚好和一个页面的大小是一样的</li></ul></li> <li>如果一级页表中的一个 PTE 是空的，那么相应的二级页表就根本不会存在</li> <li>只有一级页表才需要总是在主存中；虚拟内存系统可以在需要时创建、页面调入或调出二级页表
<ul><li>只有最经常使用的二级页表才需要缓存在主存中
<ul><li>这就减少了主存的压力</li></ul></li></ul></li></ul></div> <div class="custom-block note"><p class="custom-block-title">使用 k 级页表的地址翻译</p> <ul><li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220323195017-2022-03-23-19-50-17.png" alt="20220323195017-2022-03-23-19-50-17"> <ul><li>TLB 可以将不同层次上页表的 PTE 缓存起来
<ul><li>因此带多级页表的地址翻译并不比单级页表慢很多</li></ul></li></ul></li></ul></div> <h3 id="964-综合-端到端的地址翻译"><a href="#964-综合-端到端的地址翻译" class="header-anchor">#</a> 9.6.4 综合: 端到端的地址翻译</h3> <h2 id="97-案例研究-intel-core-i7linux-内存系统"><a href="#97-案例研究-intel-core-i7linux-内存系统" class="header-anchor">#</a> 9.7 案例研究: Intel Core i7/Linux 内存系统</h2> <div class="custom-block tip"><p class="custom-block-title">Intel Core i7 的内存系统</p> <ul><li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220324095145-2022-03-24-09-51-45.png" alt="20220324095145-2022-03-24-09-51-45"></li> <li>Core i7 实现支持 48 位（256 TB）虚拟地址空间和 52 位（4 PB）物理地址空间
<ul><li>还有一个兼容模式，支持 32 位（4 GB）虚拟和物理地址空间</li></ul></li></ul></div> <h3 id="971-core-i7-地址翻译"><a href="#971-core-i7-地址翻译" class="header-anchor">#</a> 9.7.1 Core i7 地址翻译</h3> <div class="custom-block note"><p class="custom-block-title">Core i7 地址翻译的概况</p> <ul><li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220324095459-2022-03-24-09-54-59.png" alt="20220324095459-2022-03-24-09-54-59"> <ul><li>为了简化，没有显示 i-cache、i-TLB 和 L2 统一 TLB</li></ul></li></ul></div> <div class="custom-block tip"><p class="custom-block-title">页表条目格式</p> <ul><li>第一级、第二级和第三级页表条目格式。每个条目引用一个 4 KB 子页表
<ul><li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220325195213-2022-03-25-19-52-13.png" alt="20220325195213-2022-03-25-19-52-13"></li></ul></li> <li>第四级页表条目的格式。每个条目引用一个 4 KB 子页
<ul><li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220325195241-2022-03-25-19-52-41.png" alt="20220325195241-2022-03-25-19-52-41"></li></ul></li> <li>PTE 有<strong>三个权限位</strong>，控制对页的访问
<ul><li>R/W 位确定页的内容是可以读写的还是只读的</li> <li>U/S 位确定是否能够在用户模式中访问该页
<ul><li>从而保护操作系统内核中的代码和数据不被用户程序访问</li></ul></li> <li>XD（禁止执行）位是在 64 位系统中引入的，可以用来禁止从某些内存页取指令
<ul><li>通过限制只能执行只读代码段，使得操作系统内核降低了缓冲区溢出攻击的风险</li></ul></li></ul></li> <li>当 MMU 翻译每一个虚拟地址时，它还会更新<strong>另外两个内核缺页处理程序会用到的位</strong> <ul><li>每次访问一个页时，MMU 都会设置 A 位，称为<strong>引用位</strong>（reference bit）
<ul><li>内核可以用这个引用位来实现它的页替换算法</li></ul></li> <li>每次对一个页进行了写之后，MMU 都会设置 D 位，又称<strong>修改位或脏位</strong>（dirty bit）
<ul><li>修改位告诉内核在复制替换页之前是否必须写回牺牲页</li></ul></li> <li>内核可以通过调用一条特殊的内核模式指令来清除引用位或修改位。</li></ul></li></ul></div> <div class="custom-block note"><p class="custom-block-title">Core i7 页表翻译</p> <ul><li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220325195914-2022-03-25-19-59-14.png" alt="20220325195914-2022-03-25-19-59-14"></li> <li>（PT：页表，PTE：页表条目，VPN：虚拟页号，VPO：虚拟页偏移，PPN：物理页号，PPO：物理页偏移量。图中还给出了这四级页表的 Linux 名字）</li></ul></div> <div class="custom-block warning"><p class="custom-block-title">优化地址翻译</p> <ul><li>对地址进行翻译包括两个步骤
<ul><li>MMU 将虚拟地址翻译成物理地址</li> <li>将物理地址传送到 L1 高速缓存</li></ul></li> <li>实际上这两个步骤可以部分重叠，以加速对 L1 调整缓存的访问
<ul><li>因为 12 位的 VPO 和相应物理地址中的 PPO 的 12 位是相同的</li> <li>因为八路组相联的、物理寻址的 L1 高速缓存有 64 个组和大小为 64 字节的缓存块</li> <li>每个物理地址有 6 个缓存偏移位和 6 个索引位。<strong>这 12 位恰好符合虚拟地址的 VPO 部分</strong></li> <li>如此，PPN 正好对应于 CT (高速缓存标记) 的内容</li></ul></li> <li>当 CPU 需要翻译一个虚拟地址时，它就发送 VPN 到 MMU，发送 VPO 到高速 L1 缓存
<ul><li>当 MMU 向 TLB 请求一个页表条目时，L1 高速缓存正忙着利用 VPO 位查找相应的组
<ul><li>并读出这个组里的 8 个标记和相应的数据字</li></ul></li> <li>当 MMU 从 TLB 得到 PPN 时，缓存已经准备好试着把这个 PPN 与这 8 个标记中的一个进行匹配了</li></ul></li></ul></div> <h3 id="972-linux-虚拟内存系统"><a href="#972-linux-虚拟内存系统" class="header-anchor">#</a> 9.7.2 Linux 虚拟内存系统</h3> <div class="custom-block warning"><p class="custom-block-title">一个虚拟内存系统要求硬件和内核软件之间的紧密协作</p></div> <div class="custom-block tip"><p class="custom-block-title">Linux 为每个进程维护了一个单独的虚拟地址空间</p> <ul><li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220325201221-2022-03-25-20-12-21.png" alt="20220325201221-2022-03-25-20-12-21"> <ul><li>内核虚拟内存包含内核中的代码和数据结构
<ul><li>内核虚拟内存的某些区域被映射到所有进程共享的物理页面</li></ul></li> <li>Linux 也<strong>将一组连续的虚拟页面（大小等于系统中 DRAM 的总量）映射到相应的一组连续的物理页面</strong> <ul><li>这就为内核提供了一种便利的方法来访问物理内存中任何特定的位置，例如
<ul><li>当它需要访问页表</li> <li>或在一些设备上执行内存映射的 <strong>I/O 操作</strong>，而这些设备被映射到特定的物理内存位置时</li></ul></li></ul></li> <li>内核虚拟内存的其他区域包含每个进程都不相同的数据。比如说
<ul><li>页表、内核在进程的上下文中执行代码时使用的栈</li> <li>以及记录虚拟地址空间当前组织的各种数据结构</li></ul></li></ul></li></ul></div> <div class="custom-block note"><p class="custom-block-title">Linux 虚拟内存区域</p> <ul><li>Linux 将虚拟内存组织成一些区域（也叫做段）的集合</li> <li>一个区域（area）就是已经存在着的（已分配的）虚拟内存的连续片（chunk），这些页是以某种方式相关联的
<ul><li>例如，代码段、数据段、堆、共享库段，以及用户栈都是不同的区域</li> <li>每个存在的虚拟页面都保存在某个区域中，而不属于某个区域的虚拟页是不存在的，并且不能被进程引用</li> <li>区域的概念很重要，因为它允许虚拟地址空间有间隙
<ul><li>内核不用记录那些不存在的虚拟页，而这样的页也不占用内存、磁盘或者内核本身中的任何额外资源。</li></ul></li></ul></li> <li><div class="custom-block tip"><p class="custom-block-title">内核中虚拟内存区域的数据结构</p> <ul><li>图示
<ul><li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220326210117-2022-03-26-21-01-17.png" alt="20220326210117-2022-03-26-21-01-17"></li></ul></li> <li>内核为系统中的每个进程维护一个单独的任务结构（源代码中的 task_struct）</li> <li>任务结构中的元素包含或者指向内核运行该进程所需要的所有信息，例如
<ul><li>PID、指向用户栈的指针、可执行目标文件的名字，以及程序计数器</li> <li><code>pgd</code> 指向第一级页表的基址</li> <li><code>mmap</code> 指向一个 <code>vm_area_structs</code> (区域结构) 的链表</li></ul></li> <li>当内核运行这个进程时，就将 pgd 存放在 CR3 控制寄存器中</li> <li>一个具体区域的区域结构包含下面的字段：
<ul><li><code>vm_start</code> <ul><li>指向这个区域的起始处</li></ul></li> <li><code>vm_end</code> <ul><li>指向这个区域的结束处</li></ul></li> <li><code>vm_prot</code> <ul><li>描述这个区域内包含的所有页的读写许可权限</li></ul></li> <li><code>vm_flags</code> <ul><li>描述这个区域内的页面是与其他进程共享的，还是这个进程私有的（还描述了其他一些信息）</li></ul></li> <li><code>vm_next</code> <ul><li>指向链表中下一区域结构</li></ul></li></ul></li></ul></div></li></ul></div> <div class="custom-block tip"><p class="custom-block-title">Linux 缺页异常处理</p> <ul><li>假设 MMU 在试图翻译某个虚拟地址 A 时，触发了一个缺页</li> <li>这个异常导致控制转移到内核的缺页处理程序，处理程序随后就执行下面的步骤
<ul><li><strong>虚拟地址 A 是合法的吗？</strong> <ul><li>换句话说，A 在某个区域结构定义的区域内吗？</li> <li>实际应用中，Linux 在区域链表中构建了一棵树，并在这棵树上进行查找</li></ul></li> <li><strong>试图进行的内存访问是否合法？</strong> <ul><li>换句话说，进程是否有读、写或者执行这个区域内页面的权限</li></ul></li> <li>如果上面两项均合法，<strong>则内核知道了这个缺页是由于对合法的虚拟地址进行合法的操作造成的</strong></li></ul></li> <li>示意图
<ul><li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220326210952-2022-03-26-21-09-52.png" alt="20220326210952-2022-03-26-21-09-52"></li></ul></li></ul></div> <h2 id="98-内存映射"><a href="#98-内存映射" class="header-anchor">#</a> 9.8 内存映射</h2> <div class="custom-block note"><p class="custom-block-title">内存映射的基本概念</p> <ul><li>Linux 通过将一个虚拟内存区域与一个磁盘上的对象（object）关联起来，以初始化这个虚拟内存区域的内容
<ul><li>这个过程称为内存映射（memory mapping）</li></ul></li> <li>虚拟内存<strong>区域</strong>可以映射到两种类型的对象中的一种
<ul><li><strong>Linux 文件系统中的普通文件</strong> <ul><li>一个区域可以映射到一个普通磁盘文件的连续部分
<ul><li>例如一个可执行目标文件</li> <li>文件区（section）被分成页大小的片，每一片包含一个虚拟页面的初始内容</li> <li>因为按需进行页面调度，所以这些虚拟页面没有实际交换进入物理内存，直到 CPU 第一次引用到页面
<ul><li>即发射一个虚拟地址，落在地址空间这个页面的范围之内</li></ul></li> <li>如果区域比文件区要大，那么就用零来填充这个区域的余下部分。</li></ul></li></ul></li> <li><strong>匿名文件</strong> <ul><li>一个区域也可以映射到一个匿名文件</li> <li>匿名文件是由内核创建的，包含的全是二进制零</li> <li>CPU 第一次引用这样一个区域内的虚拟页面时，内核就在物理内存中找到一个合适的牺牲页面，如果该页面被修改过，就将这个页面换出来，用二进制零覆盖牺牲页面并更新页表，将这个页面标记为是驻留在内存中的</li> <li>注意在磁盘和内存之间并没有实际的数据传送
<ul><li>因为这个原因，映射到匿名文件的区域中的页面有时也叫做请求<strong>二进制零的页</strong>（demand-zero page）</li></ul></li></ul></li></ul></li></ul></div> <div class="custom-block tip"><p class="custom-block-title">交换空间（swap space）或者交换区域（swap area）</p> <ul><li>一旦一个虚拟页面被初始化了，它就在一个由内核维护的专门的交换文件（swap file）之间换来换去</li></ul></div> <h3 id="981-再看共享对象"><a href="#981-再看共享对象" class="header-anchor">#</a> 9.8.1 再看共享对象</h3> <div class="custom-block note"><p class="custom-block-title">内存映射提供了一种清晰的机制，用来控制多个进程如何共享对象</p> <ul><li>一个对象可以被映射到虚拟内存的一个区域，要么作为<strong>共享对象</strong>，要么作为<strong>私有对象</strong></li> <li>如果一个进程将一个<strong>共享对象</strong>映射到它的虚拟地址空间的一个区域内
<ul><li>那么这个进程对这个区域的任何写操作
<ul><li>对于那些也把这个共享对象映射到它们虚拟内存的其他进程而言，也是可见的</li></ul></li> <li>而且，这些变化也会反映在磁盘上的原始对象中</li></ul></li> <li>对于一个映射到私有对象的区域做的改变
<ul><li>对于其他进程来说是不可见的</li> <li>并且进程对这个区域所做的任何写操作都不会反映在磁盘上的对象中</li></ul></li> <li>一个映射到共享对象的虚拟内存区域叫做<strong>共享区域</strong>。类似地，也有<strong>私有区域</strong></li></ul></div> <div class="custom-block tip"><p class="custom-block-title">共享对象的共享过程</p> <ul><li>示意图
<ul><li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220327220522-2022-03-27-22-05-22.png" alt="20220327220522-2022-03-27-22-05-22"></li></ul></li> <li>因为每个对象都有一个唯一的文件名，内核可以迅速地判定进程 1 已经映射了这个对象
<ul><li>因而可以使进程 2 中的页表条目指向相应的物理页面</li></ul></li> <li>关键点在于即使对象被映射到了多个共享区域，物理内存中也<strong>只需要存放共享对象的一个副本</strong></li></ul></div> <div class="custom-block note"><p class="custom-block-title">私有对象的写时复制 (copy-on-write)</p> <ul><li>示意图
<ul><li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220327220749-2022-03-27-22-07-49.png" alt="20220327220749-2022-03-27-22-07-49"></li></ul></li> <li>一个私有对象开始生命周期的方式基本上与共享对象的一样，在物理内存中只保存有私有对象的一份副本</li> <li>图中两个进程将一个私有对象映射到它们虚拟内存的不同区域，但是共享这个对象同一个物理副本</li> <li>对于每个映射私有对象的进程，相应私有区域的页表条目都被标记为只读
<ul><li>并且区域结构被标记为<strong>私有的写时复制</strong></li></ul></li> <li>只要没有进程试图写它自己的私有区域，它们就可以继续共享物理内存中对象的一个单独副本</li> <li>然而，只要有一个进程试图写私有区域内的某个页面，那么这个<strong>写操作就会触发一个保护故障</strong> <ul><li>当故障处理程序注意到保护异常是由于进程试图写私有的写时复制区域中的一个页面而引起的
<ul><li>它就会在物理内存中创建这个页面的一个新副本</li> <li>更新页表条目指向这个新的副本，然后恢复这个页面的可写权限</li></ul></li> <li>当故障处理程序返回时，CPU 重新执行这个写操作，现在在新创建的页面上这个写操作就可以正常执行了</li></ul></li> <li><div class="custom-block warning"><p class="custom-block-title">通过延迟私有对象中的副本直到最后可能的时刻，写时复制最充分地使用了稀有的物理内存</p></div></li></ul></div> <h3 id="982-再看-fork-函数"><a href="#982-再看-fork-函数" class="header-anchor">#</a> 9.8.2 再看 <code>fork</code> 函数</h3> <div class="custom-block tip"><p class="custom-block-title"><code>fork</code> 函数的调用过程</p> <ul><li>当 <code>fork</code> 函数被当前进程调用时，内核为新进程创建各种数据结构，并分配给它一个唯一的 PID
<ul><li>为了给这个新进程创建虚拟内存，它创建了当前进程的 <code>mm_struct</code>、区域结构和页表的原样副本</li> <li>它将两个进程中的<strong>每个页面都标记为只读</strong>，并将两个进程中的<strong>每个区域结构都标记为私有的写时复制</strong></li></ul></li> <li>当 <code>fork</code> 在新进程中返回时，新进程现在的虚拟内存刚好和调用 <code>fork</code> 时存在的虚拟内存相同
<ul><li>当这两个进程中的任一个后来进行写操作时，写时复制机制就会创建新页面</li> <li>因此，也就<strong>为每个进程保持了私有地址空间的抽象概念</strong></li></ul></li></ul></div> <h3 id="983-再看-execve-函数"><a href="#983-再看-execve-函数" class="header-anchor">#</a> 9.8.3 再看 <code>execve</code> 函数</h3> <div class="custom-block note"><p class="custom-block-title"><code>execve</code> 函数的调用过程</p> <ul><li>以 <code>execve(&quot;a.out&quot;, NULL, NULL);</code> 为例</li> <li>加载并运行 <code>a.out</code> 需要以下几个步骤
<ul><li><strong>删除已存在的用户区域</strong> <ul><li>删除当前进程虚拟地址的用户部分中的已存在的区域结构</li></ul></li> <li><strong>映射私有区域</strong> <ul><li>为新程序的代码、数据、bss 和栈区域创建新的区域结构</li> <li>所有这些新的区域都是<strong>私有的、写时复制</strong>的</li> <li>代码和数据区域被映射为 <code>a.out</code> 文件中的 <code>.text</code> 和 <code>.data</code> 区</li> <li>bss 区域是请求二进制零的，映射到匿名文件，其大小包含在 a.out 中</li> <li>栈和堆区域也是请求二进制零的，初始长度为零</li></ul></li> <li><strong>映射共享区域</strong> <ul><li>如果 <code>a.out</code> 程序与共享对象（或目标）链接
<ul><li>比如标准 C 库 libc.so</li></ul></li> <li>那么这些对象都是动态链接到这个程序的，然后再映射到用户虚拟地址空间中的共享区域内</li></ul></li> <li><strong>设置程序计数器（PC）</strong> <ul><li><code>execve</code> 做的最后一件事情就是设置当前进程上下文中的程序计数器，使之指向代码区域的入口点</li></ul></li></ul></li> <li>示意图
<ul><li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220327222333-2022-03-27-22-23-33.png" alt="20220327222333-2022-03-27-22-23-33"></li></ul></li></ul></div> <h3 id="984-使用-mmap-函数的用户级内存映射"><a href="#984-使用-mmap-函数的用户级内存映射" class="header-anchor">#</a> 9.8.4 使用 <code>mmap</code> 函数的用户级内存映射</h3> <div class="custom-block tip"><p class="custom-block-title">Linux 进程可以使用 mmap 函数来创建新的虚拟内存区域，并将对象映射到这些区域中</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>start<span class="token punctuation">,</span> <span class="token class-name">size_t</span> length<span class="token punctuation">,</span> <span class="token keyword">int</span> prot<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span>
           <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token class-name">off_t</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 返回：若成功时则为指向映射区域的指针，若出错则为 MAP_FAILED(-1)。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li><code>mmap</code> 函数要求内核创建一个最好是从地址 <code>start</code> 开始的新的虚拟内存区域
<ul><li>并将文件描述符 <code>fd</code> 指定的对象的一个连续的片（chunk）映射到这个新的区域</li> <li>连续的对象片大小为 <code>length</code> 字节，从距文件开始处偏移量为 <code>offset</code> 字节的地方开始</li> <li><code>start</code> 通常被定义为 <code>NULL</code>，此时由内核来确定虚拟内存区域的起始地址</li> <li>各个参数的示意图如下
<ul><li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220331161918-2022-03-31-16-19-18.png" alt="20220331161918-2022-03-31-16-19-18"></li></ul></li> <li>参数 <code>port</code> 含描述新映射的虚拟内存区域的访问权限位（即在相应区域结构中的 <code>vm_prot</code> 位）
<ul><li><code>PROT_EXEC</code> <ul><li>这个区域内的页面由可以被 CPU 执行的指令组成</li></ul></li> <li><code>PROT_READ</code> <ul><li>这个区域内的页面可读</li></ul></li> <li><code>PROT_WRITE</code> <ul><li>这个区域内的页面可写</li></ul></li> <li><code>PROT_NONE</code> <ul><li>这个区域内的页面不能被访问</li></ul></li></ul></li> <li>参数 <code>flags</code> 由描述被映射对象类型的位组成
<ul><li><code>MAP_ANON</code> <ul><li>被映射的对象就是一个匿名对象，而相应的虚拟页面是请求二进制零的</li></ul></li> <li><code>MAP_PRIVATE</code> <ul><li>表示被映射的对象是一个私有的、写时复制的对象</li></ul></li> <li><code>MAP_SHARED</code> <ul><li>表示是一个共享对象</li></ul></li></ul></li></ul></li> <li><code>bufp = Mmap(NULL, size, PROT_READ, MAP_PRIVATE|MAP_ANON, 0, 0);</code> <ul><li>让内核创建一个新的包含 <code>size</code> 字节的只读、私有、请求二进制零的虚拟内存区域</li> <li>如果调用成功，那么 <code>bufp</code> 包含新区域的地址</li></ul></li></ul></div> <div class="custom-block note"><p class="custom-block-title"><code>munmap</code> 函数删除虚拟内存的区域</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">munmap</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>start<span class="token punctuation">,</span> <span class="token class-name">size_t</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 返回：若成功则为 0，若出错则为 -1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li><code>munmap</code> 函数删除从虚拟地址 <code>start</code> 开始的，由接下来 <code>length</code> 字节组成的区域</li> <li>接下来对已删除区域的引用会导致段错误</li></ul></div> <h2 id="99-动态内存分配"><a href="#99-动态内存分配" class="header-anchor">#</a> 9.9 动态内存分配</h2> <div class="custom-block warning"><p class="custom-block-title">当运行时需要额外虚拟内存时，用动态内存分配器（dynamic memory allocator）更方便，也有更好的可移植性</p></div> <div class="custom-block tip"><p class="custom-block-title">堆</p> <ul><li>动态内存分配器维护着一个进程的虚拟内存区域，称为堆（heap）</li> <li>系统之间细节不同，但是不失通用性，假设堆是一个请求二进制零的区域
<ul><li>它紧接在未初始化的数据区域后开始，并向上生长（向更高的地址）</li></ul></li> <li>对于每个进程，内核维护着一个变量 <code>brk</code>（读做 “break”），它指向堆的顶部</li></ul></div> <div class="custom-block note"><p class="custom-block-title">分配器对堆的维护过程</p> <ul><li>分配器将堆视为一组不同大小的块（block）的集合来维护</li> <li>每个块就是一个连续的虚拟内存片（chunk），要么是已分配的，要么是空闲的
<ul><li>已分配的块显式地保留为供应用程序使用
<ul><li>一个已分配的块保持已分配状态，直到它被释放
<ul><li>这种释放要么是应用程序显式执行的，要么是内存分配器自身隐式执行的。</li></ul></li></ul></li> <li>空闲块可用来分配
<ul><li>空闲块保持空闲，直到它显式地被应用所分配</li></ul></li></ul></li></ul></div> <div class="custom-block tip"><p class="custom-block-title">分配器的两种基本风格</p> <ul><li>两种风格都要求应用显式地分配块。它们的不同之处在于由哪个实体来负责释放已分配的块</li> <li><strong>显式分配器</strong>（explicit allocator）
<ul><li>要求应用显式地释放任何已分配的块
<ul><li>例如，C 标准库提供一种叫做 <code>malloc</code> 程序包的显式分配器
<ul><li>C 程序通过调用 <code>malloc</code> 函数来分配一个块，并通过调用 <code>free</code> 函数来释放一个块</li></ul></li> <li>C++ 中的 <code>new</code> 和 <code>delete</code> 操作符与 C 中的 <code>malloc</code> 和 <code>free</code> 相当</li></ul></li></ul></li> <li><strong>隐式分配器</strong>（implicit allocator）
<ul><li>要求分配器检测一个已分配块何时不再被程序所使用，然后释放这个块</li> <li>隐式分配器也叫做<strong>垃圾收集器</strong>（garbage collector）
<ul><li>自动释放未使用的已分配的块的过程叫做<strong>垃圾收集</strong>（garbage collection）</li></ul></li> <li>例如，诸如 Lisp、ML 以及 Java 之类的高级语言就依赖垃圾收集来释放已分配的块</li></ul></li></ul></div> <div class="custom-block danger"><p class="custom-block-title">本节中假定字是 4 字节的对象，而双字是 8 字节的对象</p></div> <h3 id="991-malloc-和-free-函数"><a href="#991-malloc-和-free-函数" class="header-anchor">#</a> 9.9.1 <code>malloc</code> 和 <code>free</code> 函数</h3> <div class="custom-block note"><p class="custom-block-title"><code>malloc</code> 函数</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 返回：若成功则为已分配块的指针，若出错则为 NULL。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li><code>malloc</code> 函数返回一个指针，指向大小为至少 <code>size</code> 字节的内存块
<ul><li>这个块会为可能包含在这个块内的任何数据对象类型做对齐</li> <li>实际中，对齐依赖于编译代码在 32 位模式（gcc -m32）还是 64 位模式（默认的）中运行</li> <li>在 32 位模式中，<code>malloc</code> 返回的块的地址总是 8 的倍数</li> <li>在 64 位模式中，该地址总是 16 的倍数</li></ul></li> <li><code>malloc</code> 出错时（例如，程序要求的内存块比可用的虚拟内存还要大），会返回 <code>NULL</code>，并设置 <code>errno</code></li> <li><code>malloc</code> 不初始化它返回的内存</li> <li><code>calloc</code> 是一个基于 <code>malloc</code> 的瘦包装函数，它将分配的内存初始化为零</li> <li><code>realloc</code> 函数可以改变一个以前已分配块的大小</li></ul></div> <div class="custom-block tip"><p class="custom-block-title">堆内存的分配和释放</p> <ul><li>动态内存分配器，例如 <code>malloc</code> <ul><li>可以通过使用 <code>mmap</code> 和 <code>munmap</code> 函数，显式地分配和释放堆内存</li> <li>或者还可以使用 <code>sbrk</code> 函数</li></ul></li></ul></div> <div class="custom-block note"><p class="custom-block-title"><code>sbrk</code> 函数</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">sbrk</span><span class="token punctuation">(</span><span class="token class-name">intptr_t</span> incr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 返回：若成功则为旧的 brk 指针，若出错则为 -1。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li><code>sbrk</code> 函数通过将内核的 <code>brk</code> 指针(堆顶)增加 <code>incr</code> 来扩展和收缩堆
<ul><li>如果成功，它就返回 <code>brk</code> 的旧值</li> <li>否则，它就返回 <code>-1</code>，并将 <code>errno</code> 设置为 <code>ENOMEM</code></li></ul></li> <li>如果 <code>incr</code> 为零，那么 <code>sbrk</code> 就返回 <code>brk</code>的当前值</li> <li>用一个为负的 <code>incr</code> 来调用 <code>sbrk</code> 是合法的
<ul><li>而且很巧妙，因为返回值（ <code>brk</code> 的旧值）指向距新堆顶向上 <code>abs(incr)</code> 字节处</li></ul></li></ul></div> <div class="custom-block tip"><p class="custom-block-title">程序通过调用 <code>free</code> 函数来释放已分配的堆块</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">free</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 返回：无</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li><code>ptr</code> 参数必须指向一个从 <code>malloc</code>、<code>calloc</code> 或者 <code>realloc</code> 获得的已分配块的起始位置
<ul><li>如果不是，那么 <code>free</code> 的行为就是未定义的</li> <li>更糟的是，既然它什么都不返回，<code>free</code> 就不会告诉应用出现了错误</li></ul></li></ul></div> <h3 id="992-为什么使用动态内存分配"><a href="#992-为什么使用动态内存分配" class="header-anchor">#</a> 9.9.2 为什么使用动态内存分配</h3> <div class="custom-block warning"><p class="custom-block-title">程序使用动态内存分配的最重要的原因是经常直到程序实际运行时，才知道某些数据结构的大小</p></div> <h3 id="993-分配器的要求和目标"><a href="#993-分配器的要求和目标" class="header-anchor">#</a> 9.9.3 分配器的要求和目标</h3> <div class="custom-block tip"><p class="custom-block-title">显式分配器必须在一些相当严格的约束条件下工作</p> <ul><li><strong>处理任意请求序列</strong> <ul><li>一个应用可以有任意的分配请求和释放请求序列，只要满足约束条件
<ul><li>每个释放请求必须对应于一个当前已分配块，这个块是由一个以前的分配请求获得的</li></ul></li> <li>因此，分配器不可以假设分配和释放请求的顺序</li></ul></li> <li><strong>立即响应请求</strong> <ul><li>分配器必须立即响应分配请求</li> <li>因此，不允许分配器为了提高性能重新排列或者缓冲请求</li></ul></li> <li><strong>只使用堆</strong> <ul><li>为了使分配器是可扩展的，分配器使用的任何非标量数据结构都必须保存在堆里</li></ul></li> <li><strong>不修改已分配的块</strong> <ul><li>分配器只能操作或者改变空闲块
<ul><li>特别是，一旦块被分配了，就不允许修改或者移动它了</li></ul></li> <li>因此，诸如压缩已分配块这样的技术是不允许使用的</li></ul></li></ul></div> <div class="custom-block note"><p class="custom-block-title">在上述限制条件下，分配器的编写者试图实现吞吐率最大化和内存使用率最大化，而这两个性能目标通常是相互冲突的</p> <ul><li><strong>目标 1：最大化呑吐率</strong> <ul><li>吞吐率定义为每个单位时间里完成的请求数</li> <li>开发一个具有合理性能的分配器并不困难
<ul><li>所谓合理性能是指一个分配请求的最糟运行时间与空闲块的数量成线性关系</li> <li>而一个释放请求的运行时间是个常数</li></ul></li></ul></li> <li><strong>目标 2：最大化内存利用率</strong> <ul><li>描述分配器使用堆的效率的一个有用的标准是<strong>峰值利用率</strong>（peak utilization），其计算公式如下
<ul><li><p><mjx-container jax="SVG" display="true" class="MathJax"><svg xmlns="http://www.w3.org/2000/svg" width="18.221ex" height="5.055ex" role="img" focusable="false" viewBox="0 -1390.6 8053.7 2234.4" xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align:-1.909ex;"><defs><path id="MJX-1218-TEX-I-1D448" d="M107 637Q73 637 71 641Q70 643 70 649Q70 673 81 682Q83 683 98 683Q139 681 234 681Q268 681 297 681T342 682T362 682Q378 682 378 672Q378 670 376 658Q371 641 366 638H364Q362 638 359 638T352 638T343 637T334 637Q295 636 284 634T266 623Q265 621 238 518T184 302T154 169Q152 155 152 140Q152 86 183 55T269 24Q336 24 403 69T501 205L552 406Q599 598 599 606Q599 633 535 637Q511 637 511 648Q511 650 513 660Q517 676 519 679T529 683Q532 683 561 682T645 680Q696 680 723 681T752 682Q767 682 767 672Q767 650 759 642Q756 637 737 637Q666 633 648 597Q646 592 598 404Q557 235 548 205Q515 105 433 42T263 -22Q171 -22 116 34T60 167V183Q60 201 115 421Q164 622 164 628Q164 635 107 637Z"></path><path id="MJX-1218-TEX-I-1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path><path id="MJX-1218-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-1218-TEX-N-6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"></path><path id="MJX-1218-TEX-N-61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z"></path><path id="MJX-1218-TEX-N-78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z"></path><path id="MJX-1218-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-1218-TEX-N-2264" d="M674 636Q682 636 688 630T694 615T687 601Q686 600 417 472L151 346L399 228Q687 92 691 87Q694 81 694 76Q694 58 676 56H670L382 192Q92 329 90 331Q83 336 83 348Q84 359 96 365Q104 369 382 500T665 634Q669 636 674 636ZM84 -118Q84 -108 99 -98H678Q694 -104 694 -118Q694 -130 679 -138H98Q84 -131 84 -118Z"></path><path id="MJX-1218-TEX-I-1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path><path id="MJX-1218-TEX-I-1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path><path id="MJX-1218-TEX-I-1D43B" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 219 683Q260 681 355 681Q389 681 418 681T463 682T483 682Q499 682 499 672Q499 670 497 658Q492 641 487 638H485Q483 638 480 638T473 638T464 637T455 637Q416 636 405 634T387 623Q384 619 355 500Q348 474 340 442T328 395L324 380Q324 378 469 378H614L615 381Q615 384 646 504Q674 619 674 627T617 637Q594 637 587 639T580 648Q580 650 582 660Q586 677 588 679T604 682Q609 682 646 681T740 680Q802 680 835 681T871 682Q888 682 888 672Q888 645 876 638H874Q872 638 869 638T862 638T853 637T844 637Q805 636 794 634T776 623Q773 618 704 340T634 58Q634 51 638 51Q646 48 692 46H723Q729 38 729 37T726 19Q722 6 716 0H701Q664 2 567 2Q533 2 504 2T458 2T437 1Q420 1 420 10Q420 15 423 24Q428 43 433 45Q437 46 448 46H454Q481 46 514 49Q520 50 522 50T528 55T534 64T540 82T547 110T558 153Q565 181 569 198Q602 330 602 331T457 332H312L279 197Q245 63 245 58Q245 51 253 49T303 46H334Q340 38 340 37T337 19Q333 6 327 0H312Q275 2 178 2Q144 2 115 2T69 2T48 1Q31 1 31 10Q31 12 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><use data-c="1D448" xlink:href="#MJX-1218-TEX-I-1D448"></use></g><g data-mml-node="mi" transform="translate(716,-150) scale(0.707)"><use data-c="1D458" xlink:href="#MJX-1218-TEX-I-1D458"></use></g></g><g data-mml-node="mo" transform="translate(1412.2,0)"><use data-c="3D" xlink:href="#MJX-1218-TEX-N-3D"></use></g><g data-mml-node="mfrac" transform="translate(2468,0)"><g data-mml-node="mrow" transform="translate(220,707.6)"><g data-mml-node="munder"><g data-mml-node="mo"><use data-c="6D" xlink:href="#MJX-1218-TEX-N-6D"></use><use data-c="61" xlink:href="#MJX-1218-TEX-N-61" transform="translate(833,0)"></use><use data-c="78" xlink:href="#MJX-1218-TEX-N-78" transform="translate(1333,0)"></use></g><g data-mml-node="TeXAtom" transform="translate(1894,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-1218-TEX-N-30"></use></g><g data-mml-node="mo" transform="translate(500,0)"><use data-c="2264" xlink:href="#MJX-1218-TEX-N-2264"></use></g><g data-mml-node="mi" transform="translate(1278,0)"><use data-c="1D456" xlink:href="#MJX-1218-TEX-I-1D456"></use></g><g data-mml-node="mo" transform="translate(1623,0)"><use data-c="2264" xlink:href="#MJX-1218-TEX-N-2264"></use></g><g data-mml-node="mi" transform="translate(2401,0)"><use data-c="1D458" xlink:href="#MJX-1218-TEX-I-1D458"></use></g></g></g><g data-mml-node="msub" transform="translate(4176.8,0)"><g data-mml-node="mi"><use data-c="1D443" xlink:href="#MJX-1218-TEX-I-1D443"></use></g><g data-mml-node="mi" transform="translate(675,-150) scale(0.707)"><use data-c="1D456" xlink:href="#MJX-1218-TEX-I-1D456"></use></g></g></g><g data-mml-node="msub" transform="translate(2151.7,-686)"><g data-mml-node="mi"><use data-c="1D43B" xlink:href="#MJX-1218-TEX-I-1D43B"></use></g><g data-mml-node="mi" transform="translate(864,-150) scale(0.707)"><use data-c="1D458" xlink:href="#MJX-1218-TEX-I-1D458"></use></g></g><rect width="5345.8" height="60" x="120" y="220"></rect></g></g></g></svg></mjx-container></p></li> <li><mjx-container jax="SVG" class="MathJax"><svg xmlns="http://www.w3.org/2000/svg" width="2.474ex" height="1.902ex" role="img" focusable="false" viewBox="0 -683 1093.4 840.8" xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align:-0.357ex;"><defs><path id="MJX-1219-TEX-I-1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path><path id="MJX-1219-TEX-I-1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><use data-c="1D443" xlink:href="#MJX-1219-TEX-I-1D443"></use></g><g data-mml-node="mi" transform="translate(675,-150) scale(0.707)"><use data-c="1D458" xlink:href="#MJX-1219-TEX-I-1D458"></use></g></g></g></g></svg></mjx-container> 表示第 <mjx-container jax="SVG" class="MathJax"><svg xmlns="http://www.w3.org/2000/svg" width="1.179ex" height="1.595ex" role="img" focusable="false" viewBox="0 -694 521 705" xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align:-0.025ex;"><defs><path id="MJX-63-TEX-I-1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D458" xlink:href="#MJX-63-TEX-I-1D458"></use></g></g></g></svg></mjx-container> 个请求完成后<strong>聚集有效载荷</strong>（aggregate payload）， 为当前已分配的块的有效载荷之和</li> <li>而 <mjx-container jax="SVG" class="MathJax"><svg xmlns="http://www.w3.org/2000/svg" width="2.901ex" height="1.902ex" role="img" focusable="false" viewBox="0 -683 1282.4 840.8" xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align:-0.357ex;"><defs><path id="MJX-1220-TEX-I-1D43B" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 219 683Q260 681 355 681Q389 681 418 681T463 682T483 682Q499 682 499 672Q499 670 497 658Q492 641 487 638H485Q483 638 480 638T473 638T464 637T455 637Q416 636 405 634T387 623Q384 619 355 500Q348 474 340 442T328 395L324 380Q324 378 469 378H614L615 381Q615 384 646 504Q674 619 674 627T617 637Q594 637 587 639T580 648Q580 650 582 660Q586 677 588 679T604 682Q609 682 646 681T740 680Q802 680 835 681T871 682Q888 682 888 672Q888 645 876 638H874Q872 638 869 638T862 638T853 637T844 637Q805 636 794 634T776 623Q773 618 704 340T634 58Q634 51 638 51Q646 48 692 46H723Q729 38 729 37T726 19Q722 6 716 0H701Q664 2 567 2Q533 2 504 2T458 2T437 1Q420 1 420 10Q420 15 423 24Q428 43 433 45Q437 46 448 46H454Q481 46 514 49Q520 50 522 50T528 55T534 64T540 82T547 110T558 153Q565 181 569 198Q602 330 602 331T457 332H312L279 197Q245 63 245 58Q245 51 253 49T303 46H334Q340 38 340 37T337 19Q333 6 327 0H312Q275 2 178 2Q144 2 115 2T69 2T48 1Q31 1 31 10Q31 12 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"></path><path id="MJX-1220-TEX-I-1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><use data-c="1D43B" xlink:href="#MJX-1220-TEX-I-1D43B"></use></g><g data-mml-node="mi" transform="translate(864,-150) scale(0.707)"><use data-c="1D458" xlink:href="#MJX-1220-TEX-I-1D458"></use></g></g></g></g></svg></mjx-container> 表示堆的当前的（在本节中假设为单调非递减的）大小</li></ul></li> <li>分配器的目标是在 <mjx-container jax="SVG" class="MathJax"><svg xmlns="http://www.w3.org/2000/svg" width="1.357ex" height="1.025ex" role="img" focusable="false" viewBox="0 -442 600 453" xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align:-0.025ex;"><defs><path id="MJX-53-TEX-I-1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D45B" xlink:href="#MJX-53-TEX-I-1D45B"></use></g></g></g></svg></mjx-container> 个分配和释放请求序列中使峰值利用率 <mjx-container jax="SVG" class="MathJax"><svg xmlns="http://www.w3.org/2000/svg" width="4.737ex" height="2.016ex" role="img" focusable="false" viewBox="0 -683 2093.9 891" xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align:-0.471ex;"><defs><path id="MJX-1221-TEX-I-1D448" d="M107 637Q73 637 71 641Q70 643 70 649Q70 673 81 682Q83 683 98 683Q139 681 234 681Q268 681 297 681T342 682T362 682Q378 682 378 672Q378 670 376 658Q371 641 366 638H364Q362 638 359 638T352 638T343 637T334 637Q295 636 284 634T266 623Q265 621 238 518T184 302T154 169Q152 155 152 140Q152 86 183 55T269 24Q336 24 403 69T501 205L552 406Q599 598 599 606Q599 633 535 637Q511 637 511 648Q511 650 513 660Q517 676 519 679T529 683Q532 683 561 682T645 680Q696 680 723 681T752 682Q767 682 767 672Q767 650 759 642Q756 637 737 637Q666 633 648 597Q646 592 598 404Q557 235 548 205Q515 105 433 42T263 -22Q171 -22 116 34T60 167V183Q60 201 115 421Q164 622 164 628Q164 635 107 637Z"></path><path id="MJX-1221-TEX-I-1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-1221-TEX-N-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path><path id="MJX-1221-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><use data-c="1D448" xlink:href="#MJX-1221-TEX-I-1D448"></use></g><g data-mml-node="TeXAtom" transform="translate(716,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D45B" xlink:href="#MJX-1221-TEX-I-1D45B"></use></g><g data-mml-node="mo" transform="translate(600,0)"><use data-c="2212" xlink:href="#MJX-1221-TEX-N-2212"></use></g><g data-mml-node="mn" transform="translate(1378,0)"><use data-c="31" xlink:href="#MJX-1221-TEX-N-31"></use></g></g></g></g></g></svg></mjx-container> 最大化</li></ul></li></ul></div> <div class="custom-block warning"><p class="custom-block-title">在最大化吞吐率和最大化利用率之间是互相牵制的</p> <ul><li>特别是，以堆利用率为代价，很容易编写出吞吐率最大化的分配器</li> <li>分配器设计中一个有趣的挑战就是在两个目标之间找到一个适当的平衡</li></ul></div> <h3 id="994-碎片"><a href="#994-碎片" class="header-anchor">#</a> 9.9.4 碎片</h3> <div class="custom-block tip"><p class="custom-block-title">碎片的定义</p> <ul><li>当虽然有未使用的内存但不能用来满足分配请求时，就产生碎片现象</li> <li>碎片是造成堆利用率很低的主要原因</li></ul></div> <div class="custom-block note"><p class="custom-block-title">碎片的分类</p> <ul><li>有两种形式的碎片：<strong>内部碎片</strong>（internal fragmentation）和<strong>外部碎片</strong>（external fragmentation）</li> <li><strong>内部碎片</strong>是在一个已分配块比有效载荷大时发生的
<ul><li>很多原因都可能造成这个问题。例如
<ul><li>一个分配器的实现可能对已分配块强加一个最小的大小值，而这个大小要比某个请求的有效载荷大</li> <li>或者，分配器可能增加块大小以满足对齐约束条件</li></ul></li> <li>内部碎片的量化是简单明了的
<ul><li>它就是已分配块大小和它们的有效载荷大小之差的和</li> <li>因此，在任意时刻，内部碎片的数量只取决于以前请求的模式和分配器的实现方式</li></ul></li></ul></li> <li><strong>外部碎片</strong>是当空闲内存合计起来足够满足一个分配请求，但是没有一个单独的空闲块足够大可以来处理这个请求时发生的
<ul><li>外部碎片比内部碎片的量化要困难得多
<ul><li>因为它不仅取决于以前请求的模式和分配器的实现方式</li> <li>还取决于将来请求的模式</li></ul></li></ul></li> <li><div class="custom-block tip"><p class="custom-block-title">因为外部碎片难以量化且不可能预测，所以分配器通常釆用启发式策略来试图维持少量的大空闲块，而不是维持大量的小空闲块</p></div></li></ul></div> <h3 id="995-实现问题"><a href="#995-实现问题" class="header-anchor">#</a> 9.9.5 实现问题</h3> <div class="custom-block tip"><p class="custom-block-title">一个实际的分配器要在吞吐率和利用率之间把握好平衡，就必须考虑以下几个问题</p> <ul><li><strong>空闲块组织</strong> <ul><li>如何记录空闲块？</li></ul></li> <li><strong>放置</strong> <ul><li>如何选择一个合适的空闲块来放置一个新分配的块？</li></ul></li> <li><strong>分割</strong> <ul><li>在将一个新分配的块放置到某个空闲块之后，如何处理这个空闲块中的剩余部分？</li></ul></li> <li><strong>合并</strong> <ul><li>如何处理一个刚刚被释放的块？</li></ul></li></ul></div> <h3 id="996-隐式空闲链表"><a href="#996-隐式空闲链表" class="header-anchor">#</a> 9.9.6 隐式空闲链表</h3> <div class="custom-block note"><p class="custom-block-title">任何实际的分配器都需要一些数据结构，允许它来区别块边界，以及区别已分配块和空闲块。大多数分配器将这些信息嵌入块本身</p> <ul><li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220423170558-2022-04-23-17-05-58.png" alt="20220423170558-2022-04-23-17-05-58"></li> <li>在这种情况中，一个块是由一个字的头部、有效载荷，以及可能的一些额外的填充组成的</li> <li>头部编码了这个块的大小（包括头部和所有的填充），以及这个块是已分配的还是空闲的
<ul><li>如果我们强加一个双字的对齐约束条件，那么块大小就总是 8 的倍数，且块大小的最低 3 位总是零</li> <li>因此，我们只需要内存大小的 29 个高位，释放剩余的 3 位来编码其他信息</li> <li>在这种情况中，可以用其中的最低位（已分配位）来指明这个块是已分配的还是空闲的</li></ul></li> <li>头部后面就是应用调用 <code>malloc</code> 时请求的有效载荷</li> <li>有效载荷后面是一片不使用的填充块，其大小可以是任意的
<ul><li>需要填充有很多原因。比如，填充可能是分配器策略的一部分，用来对付外部碎片。</li> <li>或者也需要用它来满足对齐要求</li></ul></li></ul></div> <div class="custom-block tip"><p class="custom-block-title">隐式空闲链表</p> <ul><li>可以将堆组织为一个连续的已分配块和空闲块的序列
<ul><li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220423171102-2022-04-23-17-11-02.png" alt="20220423171102-2022-04-23-17-11-02"></li></ul></li> <li>这种结构即为隐式空闲链表
<ul><li>是因为空闲块是通过头部中的大小字段隐含地连接着的</li> <li>分配器可以通过遍历堆中所有的块，从而间接地遍历整个空闲块的集合</li></ul></li> <li>这种情况下需要某种<strong>特殊标记的结束块</strong> <ul><li>在本例中，就是一个设置了已分配位而大小为零的终止头部（terminating header）</li></ul></li></ul></div> <h3 id="997-放置已分配的块"><a href="#997-放置已分配的块" class="header-anchor">#</a> 9.9.7 放置已分配的块</h3> <div class="custom-block note"><p class="custom-block-title">放置策略</p> <ul><li>当一个应用请求一个 <mjx-container jax="SVG" class="MathJax"><svg xmlns="http://www.w3.org/2000/svg" width="1.179ex" height="1.595ex" role="img" focusable="false" viewBox="0 -694 521 705" xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align:-0.025ex;"><defs><path id="MJX-63-TEX-I-1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D458" xlink:href="#MJX-63-TEX-I-1D458"></use></g></g></g></svg></mjx-container> 字节的块时，分配器搜索空闲链表，查找一个足够大可以放置所请求块的空闲块</li> <li>分配器执行这种搜索的方式是由<strong>放置策略</strong>（placement policy）确定的</li> <li>一些常见的策略是<strong>首次适配</strong>（first fit），<strong>下一次适配</strong>（next fit）和<strong>最佳适配</strong>（best fit）
<ul><li>首次适配从头开始搜索空闲链表，选择第一个合适的空闲块
<ul><li>优点是它<strong>趋向于将大的空闲块保留在链表的后面</strong>。缺点是它<strong>趋向于在靠近链表起始处留下小空闲块</strong></li></ul></li> <li>下一次适配和首次适配很相似，只不过不是从链表的起始处开始每次搜索，而是从上一次查询结束的地方开始
<ul><li>其作为首次适配的一种代替品被提出，源于这样一个想法
<ul><li>如果上一次在某个空闲块里已经发现了一个匹配，那么很可能下一次也能在这个剩余块中发现匹配</li></ul></li> <li><strong>下一次适配比首次适配运行起来明显要快一些</strong>，尤其是当链表的前面布满了许多小的碎片时</li> <li>然而，一些研究表明，<strong>下一次适配的内存利用率要比首次适配低得多</strong></li></ul></li> <li>最佳适配检查每个空闲块，选择适合所需请求大小的最小空闲块
<ul><li>研究表明<strong>最佳适配比首次适配和下一次适配的内存利用率都要高一些</strong></li> <li>然而，<strong>在简单空闲链表组织结构中</strong>，比如隐式空闲链表中
<ul><li><strong>使用最佳适配的缺点是它要求对堆进行彻底的搜索</strong></li></ul></li></ul></li></ul></li></ul></div> <h3 id="998-分割空闲块"><a href="#998-分割空闲块" class="header-anchor">#</a> 9.9.8 分割空闲块</h3> <div class="custom-block tip"><p class="custom-block-title">一旦分配器找到一个匹配的空闲块，它就必须做另一个策略决定，那就是分配这个空闲块中多少空间</p> <ul><li>一个选择是用整个空闲块
<ul><li>虽然这种方式简单而快捷，但是主要的缺点就是它会造成内部碎片</li> <li>如果放置策略趋向于产生好的匹配，那么额外的内部碎片也是可以接受的。</li></ul></li> <li>然而，如果匹配不太好，那么分配器通常会选择将这个空闲块分割为两部分
<ul><li>第一部分变成分配块</li> <li>而剩下的变成一个新的空闲块</li></ul></li></ul></div> <h3 id="999-获取额外的堆内存"><a href="#999-获取额外的堆内存" class="header-anchor">#</a> 9.9.9 获取额外的堆内存</h3> <div class="custom-block note"><p class="custom-block-title">分配器不能为请求块找到合适的空闲块时的处理措施</p> <ul><li>一个选择是通过合并那些在内存中物理上相邻的空闲块来创建一些更大的空闲块（在下一节中描述）</li> <li>然而，如果合并空闲块还是不能生成一个足够大的块，或者如果空闲块已经最大程度地合并了
<ul><li>那么分配器就会通过调用 <code>sbrk</code> 函数，向内核请求额外的堆内存</li> <li>分配器将额外的内存转化成一个大的空闲块，将这个块插入到空闲链表中</li> <li>然后将被请求的块放置在这个新的空闲块中。</li></ul></li></ul></div> <h3 id="9910-合并空闲块"><a href="#9910-合并空闲块" class="header-anchor">#</a> 9.9.10 合并空闲块</h3> <div class="custom-block tip"><p class="custom-block-title">假碎片现象</p> <ul><li>当分配器释放一个已分配块时，可能有其他空闲块与这个新释放的空闲块相邻</li> <li>这些邻接的空闲块可能引起一种现象，叫做<strong>假碎片</strong>（fault fragmentation）
<ul><li>就是有许多可用的空闲块被切割成为小的、无法使用的空闲块。</li></ul></li></ul></div> <div class="custom-block note"><p class="custom-block-title">利用合并来解决假碎片问题</p> <ul><li>为了解决假碎片问题，任何实际的分配器都必须合并相邻的空闲块，这个过程称为<strong>合并</strong>（coalescing）</li> <li>这就出现了一个重要的策略决定，那就是<strong>何时执行合并</strong> <ul><li>分配器可以选择<strong>立即合并</strong>（immediate coalescing）
<ul><li>也就是在每次一个块被释放时，就合并所有的相邻块</li></ul></li> <li>或者它也可以选择<strong>推迟合并</strong>（deferred coalescing）
<ul><li>也就是等到某个稍晚的时候再合并空闲块</li> <li>例如，分配器可以推迟合并，直到某个分配请求失败，然后扫描整个堆，合并所有的空闲块</li></ul></li></ul></li> <li><div class="custom-block warning"><p class="custom-block-title">立即合并很简单明了，可以在常数时间内执行完成，但是对于某些请求模式，这种方式会产生一种形式的抖动，块会反复地合并，然后马上分割</p> <ul><li>比如反复地分配和释放一个 3 个字的块将产生大量不必要的分割和合并</li> <li>在对分配器的讨论中，我们会假设使用立即合并</li> <li>但是在实际应用中，快速的分配器通常会选择某种形式的推迟合并</li></ul></div></li></ul></div> <h3 id="9911-带边界标记的合并"><a href="#9911-带边界标记的合并" class="header-anchor">#</a> 9.9.11 带边界标记的合并</h3> <div class="custom-block tip"><p class="custom-block-title">边界标记</p> <ul><li><strong>边界标记</strong>（boundary tag），允许在常数时间内进行对前面块的合并</li> <li>使用边界标记的堆块的格式
<ul><li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220423175102-2022-04-23-17-51-02.png" alt="20220423175102-2022-04-23-17-51-02"></li></ul></li> <li>分配器释放当前块时，可能存在的情况
<ul><li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220423175245-2022-04-23-17-52-46.png" alt="20220423175245-2022-04-23-17-52-46"></li></ul></li> <li><div class="custom-block note"><p class="custom-block-title">边界标记的概念是简单优雅的，它对许多不同类型的分配器和空闲链表组织都是通用的</p></div></li></ul></div> <div class="custom-block note"><p class="custom-block-title">边界标记的缺陷及改进方法</p> <ul><li>边界标记要求每个块都保持一个头部和一个脚部，在应用程序操作许多个小块时，会产生显著的内存开销</li> <li>有一种非常聪明的边界标记的优化方法，能够使得<strong>在已分配块中不再需要脚部</strong> <ul><li>当我们试图在内存中合并当前块以及前面的块和后面的块时
<ul><li>只有在前面的块是空闲时，才会需要用到它的脚部</li></ul></li> <li>如果我们<strong>把前面块的已分配/空闲位存放在当前块中多出来的低位中</strong> <ul><li>那么已分配的块就不需要脚部了</li> <li>这样我们就可以将这个多出来的空间用作有效载荷了</li></ul></li></ul></li> <li><div class="custom-block warning"><p class="custom-block-title">注意，空闲块仍然需要脚部</p></div></li></ul></div> <h3 id="9912-综合-实现一个简单的分配器"><a href="#9912-综合-实现一个简单的分配器" class="header-anchor">#</a> 9.9.12 综合: 实现一个简单的分配器</h3> <div class="custom-block warning"><p class="custom-block-title">构造一个分配器是一件富有挑战性的任务</p> <ul><li>设计空间很大
<ul><li>有多种块格式、空闲链表格式，以及放置、分割和合并策略可供选择</li></ul></li> <li>需要依赖于容易出错的指针强制类型转换和指针运算</li></ul></div> <h4 id="通用分配器的设计"><a href="#通用分配器的设计" class="header-anchor">#</a> 通用分配器的设计</h4> <div class="custom-block tip"><p class="custom-block-title">使用 <code>memlib.c</code> 包所提供的一个内存系统模型</p> <ul><li>模型的目的在于允许我们在不干涉已存在的系统层 malloc 包的情况下，运行分配器。</li> <li><details class="custom-block details"><summary><code>memlib.c</code></summary> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* Private global variables */</span>
<span class="token keyword">static</span> <span class="token keyword">char</span> <span class="token operator">*</span>mem_heap<span class="token punctuation">;</span>     <span class="token comment">/* Points to first byte of heap */</span>
<span class="token keyword">static</span> <span class="token keyword">char</span> <span class="token operator">*</span>mem_brk<span class="token punctuation">;</span>      <span class="token comment">/* Points to last byte of heap plus 1 */</span>
<span class="token keyword">static</span> <span class="token keyword">char</span> <span class="token operator">*</span>mem_max_addr<span class="token punctuation">;</span> <span class="token comment">/* Max legal heap addr plus 1*/</span>

<span class="token comment">/*
* mem_init - Initialize the memory system model
*/</span>
<span class="token keyword">void</span> <span class="token function">mem_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    mem_heap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">Malloc</span><span class="token punctuation">(</span>MAX_HEAP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mem_brk <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>mem_heap<span class="token punctuation">;</span>
    mem_max_addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>mem_heap <span class="token operator">+</span> MAX_HEAP<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
* mem_sbrk - Simple model of the sbrk function. Extends the heap
*    by incr bytes and returns the start address of the new area. In
*    this model, the heap cannot be shrunk.
*/</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">mem_sbrk</span><span class="token punctuation">(</span><span class="token keyword">int</span> incr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>old_brk <span class="token operator">=</span> mem_brk<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>incr <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mem_brk <span class="token operator">+</span> incr<span class="token punctuation">)</span> <span class="token operator">&gt;</span> mem_max_addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        errno <span class="token operator">=</span> ENOMEM<span class="token punctuation">;</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;ERROR: mem_sbrk failed. Ran out of memory...\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    mem_brk <span class="token operator">+=</span> incr<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>old_brk<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div></details></li></ul></div> <div class="custom-block note"><p class="custom-block-title">分配器包含在一个源文件中（<code>mm.c</code>）</p> <ul><li><p>用户可以编译和链接这个源文件到他们的应用之中</p></li> <li><p>分配器输出三个函数到应用程序</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">mm_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">mm_malloc</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">mm_free</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ul></div> <div class="custom-block tip"><p class="custom-block-title">隐式空闲链表的恒定形式</p> <ul><li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220515104810-2022-05-15-10-48-10.png" alt="20220515104810-2022-05-15-10-48-10"> <ul><li><strong>序言块</strong>（prologue block）和<strong>结尾块</strong>（epilogue block）在初始化时创建的，并且永不释放</li> <li>序言块和结尾块是一种消除合并时边界条件的技巧</li></ul></li></ul></div> <h4 id="操作空闲链表的基本常数和宏"><a href="#操作空闲链表的基本常数和宏" class="header-anchor">#</a> 操作空闲链表的基本常数和宏</h4> <div class="custom-block note"><p class="custom-block-title">定义一小组宏来访问和遍历空闲链表是很有帮助的</p> <ul><li><details class="custom-block details"><summary><code>mm.c</code></summary> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* Basic constants and macros */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">WSIZE</span> <span class="token expression"><span class="token number">4</span>             </span><span class="token comment">/* Word and header/footer size (bytes) */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DSIZE</span> <span class="token expression"><span class="token number">8</span>             </span><span class="token comment">/* Double word size (bytes) */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CHUNKSIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">12</span><span class="token punctuation">)</span>   </span><span class="token comment">/* Extend heap by this amount (bytes) */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">MAX</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token operator">?</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/* Pack a size and allocated bit into a word */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PACK</span><span class="token expression"><span class="token punctuation">(</span>size<span class="token punctuation">,</span> alloc<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>alloc<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/* Read and write a word at address p */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">GET</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">)</span>       <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PUT</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">,</span> val<span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/* Read the size and allocated fields from address p */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">GET_SIZE</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token function">GET</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token number">0x7</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">GET_ALLOC</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">GET</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x1</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/* Given block ptr bp, compute address of its header and footer */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">HDRP</span><span class="token expression"><span class="token punctuation">(</span>bp<span class="token punctuation">)</span>       <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span> <span class="token operator">-</span> WSIZE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">FTRP</span><span class="token expression"><span class="token punctuation">(</span>bp<span class="token punctuation">)</span>       <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">GET_SIZE</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> DSIZE<span class="token punctuation">)</span></span></span>

<span class="token comment">/* Given block ptr bp, compute address of next and previous blocks */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">NEXT_BLKP</span><span class="token expression"><span class="token punctuation">(</span>bp<span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">GET_SIZE</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span> <span class="token operator">-</span> WSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PREV_BLKP</span><span class="token expression"><span class="token punctuation">(</span>bp<span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">GET_SIZE</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span> <span class="token operator">-</span> DSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div></details></li></ul></div> <h4 id="创建初始空闲链表"><a href="#创建初始空闲链表" class="header-anchor">#</a> 创建初始空闲链表</h4> <details class="custom-block details"><summary><code>mm.c</code> 中的 <code>mm_init</code></summary> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">mm_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">/* Create the initial empty heap */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>heap_listp <span class="token operator">=</span> <span class="token function">mem_sbrk</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> WSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">PUT</span><span class="token punctuation">(</span>heap_listp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment">/* Alignment padding */</span>
    <span class="token function">PUT</span><span class="token punctuation">(</span>heap_listp <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> WSIZE<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>DSIZE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Prologue header */</span>
    <span class="token function">PUT</span><span class="token punctuation">(</span>heap_listp <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> WSIZE<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>DSIZE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Prologue footer */</span>
    <span class="token function">PUT</span><span class="token punctuation">(</span>heap_listp <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> WSIZE<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">/* Epilogue header */</span>
    heap_listp <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> WSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Extend the empty heap with a free block of CHUNKSIZE bytes */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">extend_heap</span><span class="token punctuation">(</span>CHUNKSIZE <span class="token operator">/</span> WSIZE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div></details> <details class="custom-block details"><summary><code>mm.c</code> 中的 <code>extend_heap</code></summary> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">extend_heap</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> words<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>bp<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> size<span class="token punctuation">;</span>

    <span class="token comment">/* Allocate an even number of words to maintain alignment */</span>
    size <span class="token operator">=</span> <span class="token punctuation">(</span>words <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>words <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> WSIZE <span class="token operator">:</span> words <span class="token operator">*</span> WSIZE<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>bp <span class="token operator">=</span> <span class="token function">mem_sbrk</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token comment">/* Initialize free block header/footer and the epilogue header */</span>
    <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">/* Free block header */</span>
    <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">FTRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">/* Free block footer */</span>
    <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span><span class="token function">NEXT_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* New epilogue header */</span>

    <span class="token comment">/* Coalesce if the previous block was free */</span>
    <span class="token keyword">return</span> <span class="token function">coalesce</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div></details> <h4 id="释放和合并块"><a href="#释放和合并块" class="header-anchor">#</a> 释放和合并块</h4> <details class="custom-block details"><summary><code>mm.c</code> 中的 <code>mm_free</code> 和 <code>coalesce</code></summary> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">mm_free</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>bp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">size_t</span> size <span class="token operator">=</span> <span class="token function">GET_SIZE</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">FTRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">coalesce</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">coalesce</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>bp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">size_t</span> prev_alloc <span class="token operator">=</span> <span class="token function">GET_ALLOC</span><span class="token punctuation">(</span><span class="token function">FTRP</span><span class="token punctuation">(</span><span class="token function">PREV_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> next_alloc <span class="token operator">=</span> <span class="token function">GET_ALLOC</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span><span class="token function">NEXT_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> size <span class="token operator">=</span> <span class="token function">GET_SIZE</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>prev_alloc <span class="token operator">&amp;&amp;</span> next_alloc<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment">/* Case 1 */</span>
        <span class="token keyword">return</span> bp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>prev_alloc <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>next_alloc<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment">/* Case 2 */</span>
        size <span class="token operator">+=</span> <span class="token function">GET_SIZE</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span><span class="token function">NEXT_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">FTRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prev_alloc <span class="token operator">&amp;&amp;</span> next_alloc<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment">/* Case 3 */</span>
        size <span class="token operator">+=</span> <span class="token function">GET_SIZE</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span><span class="token function">PREV_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">FTRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span><span class="token function">PREV_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bp <span class="token operator">=</span> <span class="token function">PREV_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">else</span> <span class="token punctuation">{</span>                                     <span class="token comment">/* Case 4 */</span>
        size <span class="token operator">+=</span> <span class="token function">GET_SIZE</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span><span class="token function">PREV_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                <span class="token function">GET_SIZE</span><span class="token punctuation">(</span><span class="token function">FTRP</span><span class="token punctuation">(</span><span class="token function">NEXT_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span><span class="token function">PREV_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">FTRP</span><span class="token punctuation">(</span><span class="token function">NEXT_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bp <span class="token operator">=</span> <span class="token function">PREV_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> bp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div></details> <h4 id="分配块"><a href="#分配块" class="header-anchor">#</a> 分配块</h4> <details class="custom-block details"><summary><code>mm.c</code> 中的 <code>mm_malloc</code></summary> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">mm_malloc</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">size_t</span> asize<span class="token punctuation">;</span>      <span class="token comment">/* Adjusted block size */</span>
    <span class="token class-name">size_t</span> extendsize<span class="token punctuation">;</span> <span class="token comment">/* Amount to extend heap if no fit */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>bp<span class="token punctuation">;</span>

    <span class="token comment">/* Ignore spurious requests */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token comment">/* Adjust block size to include overhead and alignment reqs. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;=</span> DSIZE<span class="token punctuation">)</span>
        asize <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> DSIZE<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        asize <span class="token operator">=</span> DSIZE <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>size <span class="token operator">+</span> <span class="token punctuation">(</span>DSIZE<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>DSIZE <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> DSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Search the free list for a fit */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bp <span class="token operator">=</span> <span class="token function">find_fit</span><span class="token punctuation">(</span>asize<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">place</span><span class="token punctuation">(</span>bp<span class="token punctuation">,</span> asize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> bp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* No fit found. Get more memory and place the block */</span>
    extendsize <span class="token operator">=</span> <span class="token function">MAX</span><span class="token punctuation">(</span>asize<span class="token punctuation">,</span> CHUNKSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bp <span class="token operator">=</span> <span class="token function">extend_heap</span><span class="token punctuation">(</span>extendsize <span class="token operator">/</span> WSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token function">place</span><span class="token punctuation">(</span>bp<span class="token punctuation">,</span> asize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> bp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div></details> <h3 id="9913-显式空闲链表"><a href="#9913-显式空闲链表" class="header-anchor">#</a> 9.9.13 显式空闲链表</h3> <div class="custom-block danger"><p class="custom-block-title">因为块分配与堆块的总数呈线性关系，所以对于通用的分配器，隐式空闲链表是不适合的</p></div> <div class="custom-block tip"><p class="custom-block-title">双向空闲链表</p> <ul><li>可以将空闲块组织为某种形式的显式数据结构</li> <li>因为根据定义，程序不需要一个空闲块的主体，所以实现这个数据结构的指针可以存放在这些空闲块的主体里面
<ul><li>例如，堆可以组织成一个双向空闲链表，在每个空闲块中，都包含一个 <code>pred</code>（前驱）和 <code>succ</code>（后继）指针</li> <li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220515111237-2022-05-15-11-12-37.png" alt="20220515111237-2022-05-15-11-12-37"></li></ul></li> <li>使用双向链表而不是隐式空闲链表，使首次适配的分配时间从块总数的线性时间减少到了空闲块数量的线性时间</li></ul></div> <div class="custom-block note"><p class="custom-block-title">显式链表的缺点</p> <ul><li>要求空闲块必须足够大，以包含所有需要的指针，以及头部和可能的脚部。</li> <li>这就导致了更大的最小块大小，也潜在地提高了内部碎片的程度</li></ul></div> <h3 id="9914-分离的空闲链表"><a href="#9914-分离的空闲链表" class="header-anchor">#</a> 9.9.14 分离的空闲链表</h3> <div class="custom-block tip"><p class="custom-block-title">分离存储（segregated storage）</p> <ul><li>一个使用单向空闲块链表的分配器需要与空闲块数量呈线性关系的时间来分配块</li> <li>一种流行的减少分配时间的方法，通常称为分离存储（segregated storage）
<ul><li>分离储存会维护多个空闲链表，其中每个链表中的块有大致相等的大小</li> <li>一般的思路是将所有可能的块大小分成一些等价类，也叫做<strong>大小类</strong>（size class）
<ul><li>可以根据 2 的幂来划分块大小
<ul><li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220515111955-2022-05-15-11-19-56.png" alt="20220515111955-2022-05-15-11-19-56"></li></ul></li> <li>也可以将小的块分派到它们自己的大小类里，而将大块按照 2 的幂分类
<ul><li><img src="https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20220515112008-2022-05-15-11-20-09.png" alt="20220515112008-2022-05-15-11-20-09"></li></ul></li></ul></li></ul></li></ul></div> <h4 id="简单分离存储（simple-segregated-storage）"><a href="#简单分离存储（simple-segregated-storage）" class="header-anchor">#</a> 简单分离存储（simple segregated storage）</h4> <div class="custom-block tip"><p class="custom-block-title">简单分离储存的基本原理</p> <ul><li>使用简单分离存储，每个大小类的空闲链表包含大小相等的块，每个块的大小就是这个大小类中最大元素的大小</li></ul></div> <div class="custom-block note"><p class="custom-block-title">简单分离储存的基本工作流程</p> <ul><li>为了分配一个给定大小的块，我们检査相应的空闲链表</li> <li>如果链表非空，我们简单地分配其中第一块的全部
<ul><li>空闲块是不会分割以满足分配请求的</li></ul></li> <li>如果链表为空，分配器就向操作系统请求一个固定大小的额外内存片（通常是页大小的整数倍）
<ul><li>将这个片分成大小相等的块，并将这些块链接起来形成新的空闲链表</li></ul></li> <li>要释放一个块，分配器只要简单地将这个块插入到相应的空闲链表的前部
<ul><li>不会进行合并操作</li></ul></li></ul></div> <div class="custom-block tip"><p class="custom-block-title">简单分离适配的优点</p> <ul><li>分配和释放块都是很快的常数时间操作</li> <li>已分配的块不需要头部
<ul><li>由于每个片只有大小相同的块，那么一个已分配块的大小就可以从它的地址中推断出来
<ul><li>可以考虑在每页的开头储存块大小的相关信息</li></ul></li> <li>因为没有合并，所以已分配块的头部就不需要一个已分配/空闲标记</li></ul></li> <li>因为没有合并，已分配的块也不需要脚部</li> <li>因为分配和释放操作都是在空闲链表的起始处操作，所以链表只需要是单向的，而不用是双向的</li> <li><div class="custom-block danger"><p class="custom-block-title">因此，在任何块中都需要的唯一字段是每个空闲块中的一个字的 <code>succ</code> 指针</p> <ul><li>因此最小块大小就是一个字</li></ul></div></li></ul></div> <div class="custom-block note"><p class="custom-block-title">简单分离适配的缺点</p> <ul><li>显著的缺点是，简单分离存储很容易造成内部和外部碎片
<ul><li>因为空闲块是不会被分割的，所以可能会造成内部碎片</li> <li>因为不会合并空闲块，所以某些引用模式会引起极多的外部碎片</li></ul></li></ul></div> <h4 id="分离适配（segregated-fit）"><a href="#分离适配（segregated-fit）" class="header-anchor">#</a> 分离适配（segregated fit）</h4> <div class="custom-block tip"><p class="custom-block-title">分离适配的基本原理</p> <ul><li>分配器维护着一个空闲链表的数组</li> <li>每个空闲链表是和一个大小类相关联的，并且被组织成某种类型的显式或隐式链表</li> <li>每个链表包含潜在的大小不同的块，这些块的大小是大小类的成员</li></ul></div> <div class="custom-block note"><p class="custom-block-title">分离适配器的简单版本</p> <ul><li>为了分配一个块，必须确定请求的大小类，并且对适当的空闲链表做首次适配，査找一个合适的块</li> <li>如果找到了一个，那么就（可选地）分割它，并将剩余的部分插入到适当的空闲链表中</li> <li>如果找不到合适的块，那么就搜索下一个更大的大小类的空闲链表
<ul><li>如此重复，直到找到一个合适的块</li></ul></li> <li>如果空闲链表中没有合适的块，那么就向操作系统请求额外的堆内存
<ul><li>从这个新的堆内存中分配出一个块，将剩余部分放置在适当的大小类中</li></ul></li> <li>要释放一个块，我们执行合并，并将结果放置到相应的空闲链表中</li></ul></div> <div class="custom-block warning"><p class="custom-block-title">分离适配方法的特点</p> <ul><li>分离适配方法是一种常见的选择，C 标准库中提供的 GNU malloc 包就是釆用的这种方法</li> <li>分离适配方法
<ul><li>快速，对内存的使用也很有效率</li> <li>减少了搜索时间，因为搜索被限制在堆的某个部分，而不是整个堆</li> <li>内存利用率得到了改善
<ul><li>因为对分离空闲链表的简单的首次适配搜索，其内存利用率近似于对整个堆的最佳适配搜索的内存利用率</li></ul></li></ul></li></ul></div> <h4 id="伙伴系统（buddy-system）"><a href="#伙伴系统（buddy-system）" class="header-anchor">#</a> 伙伴系统（buddy system）</h4> <div class="custom-block tip"><p class="custom-block-title">伙伴系统的基本特点</p> <ul><li>伙伴系统是分离适配的一种特例，其中每个大小类都是 2 的幂</li> <li>假设一个堆的大小为个 <mjx-container jax="SVG" class="MathJax"><svg xmlns="http://www.w3.org/2000/svg" width="2.724ex" height="1.528ex" role="img" focusable="false" viewBox="0 -675.5 1203.8 675.5" xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align:0;"><defs><path id="MJX-1222-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-1222-TEX-I-1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-1222-TEX-N-32"></use></g><g data-mml-node="mi" transform="translate(533,363) scale(0.707)"><use data-c="1D45A" xlink:href="#MJX-1222-TEX-I-1D45A"></use></g></g></g></g></svg></mjx-container> 字
<ul><li>我们为每个 <mjx-container jax="SVG" class="MathJax"><svg xmlns="http://www.w3.org/2000/svg" width="1.871ex" height="1.879ex" role="img" focusable="false" viewBox="0 -830.4 827 830.4" xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align:0;"><defs><path id="MJX-1223-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-1223-TEX-I-1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-1223-TEX-N-32"></use></g><g data-mml-node="mi" transform="translate(533,363) scale(0.707)"><use data-c="1D456" xlink:href="#MJX-1223-TEX-I-1D456"></use></g></g></g></g></svg></mjx-container> 的块大小维护一个分离空闲链表，其中 <mjx-container jax="SVG" class="MathJax"><svg xmlns="http://www.w3.org/2000/svg" width="9.932ex" height="1.819ex" role="img" focusable="false" viewBox="0 -666 4390.1 804" xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align:-0.312ex;"><defs><path id="MJX-1224-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-1224-TEX-N-2264" d="M674 636Q682 636 688 630T694 615T687 601Q686 600 417 472L151 346L399 228Q687 92 691 87Q694 81 694 76Q694 58 676 56H670L382 192Q92 329 90 331Q83 336 83 348Q84 359 96 365Q104 369 382 500T665 634Q669 636 674 636ZM84 -118Q84 -108 99 -98H678Q694 -104 694 -118Q694 -130 679 -138H98Q84 -131 84 -118Z"></path><path id="MJX-1224-TEX-I-1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path><path id="MJX-1224-TEX-I-1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-1224-TEX-N-30"></use></g><g data-mml-node="mo" transform="translate(777.8,0)"><use data-c="2264" xlink:href="#MJX-1224-TEX-N-2264"></use></g><g data-mml-node="mi" transform="translate(1833.6,0)"><use data-c="1D456" xlink:href="#MJX-1224-TEX-I-1D456"></use></g><g data-mml-node="mo" transform="translate(2456.3,0)"><use data-c="2264" xlink:href="#MJX-1224-TEX-N-2264"></use></g><g data-mml-node="mi" transform="translate(3512.1,0)"><use data-c="1D45A" xlink:href="#MJX-1224-TEX-I-1D45A"></use></g></g></g></svg></mjx-container></li> <li>请求块大小向上舍入到最接近的 2 的幂</li></ul></li> <li>最开始时，只有一个大小为 <mjx-container jax="SVG" class="MathJax"><svg xmlns="http://www.w3.org/2000/svg" width="2.724ex" height="1.528ex" role="img" focusable="false" viewBox="0 -675.5 1203.8 675.5" xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align:0;"><defs><path id="MJX-1222-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-1222-TEX-I-1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-1222-TEX-N-32"></use></g><g data-mml-node="mi" transform="translate(533,363) scale(0.707)"><use data-c="1D45A" xlink:href="#MJX-1222-TEX-I-1D45A"></use></g></g></g></g></svg></mjx-container> 个字的空闲块</li></ul></div> <div class="custom-block note"><p class="custom-block-title">伙伴系统的基本原理</p> <ul><li>为了分配一个大小 <mjx-container jax="SVG" class="MathJax"><svg xmlns="http://www.w3.org/2000/svg" width="1.871ex" height="1.879ex" role="img" focusable="false" viewBox="0 -830.4 827 830.4" xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align:0;"><defs><path id="MJX-1223-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-1223-TEX-I-1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-1223-TEX-N-32"></use></g><g data-mml-node="mi" transform="translate(533,363) scale(0.707)"><use data-c="1D456" xlink:href="#MJX-1223-TEX-I-1D456"></use></g></g></g></g></svg></mjx-container> 为的块，我们找到第一个可用的、大小为 <mjx-container jax="SVG" class="MathJax"><svg xmlns="http://www.w3.org/2000/svg" width="1.978ex" height="1.879ex" role="img" focusable="false" viewBox="0 -830.4 874.3 830.4" xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align:0;"><defs><path id="MJX-1225-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-1225-TEX-I-1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-1225-TEX-N-32"></use></g><g data-mml-node="mi" transform="translate(533,363) scale(0.707)"><use data-c="1D457" xlink:href="#MJX-1225-TEX-I-1D457"></use></g></g></g></g></svg></mjx-container> 的块，其中 <mjx-container jax="SVG" class="MathJax"><svg xmlns="http://www.w3.org/2000/svg" width="9.733ex" height="1.957ex" role="img" focusable="false" viewBox="0 -661 4302.1 865" xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align:-0.462ex;"><defs><path id="MJX-1226-TEX-I-1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path><path id="MJX-1226-TEX-N-2264" d="M674 636Q682 636 688 630T694 615T687 601Q686 600 417 472L151 346L399 228Q687 92 691 87Q694 81 694 76Q694 58 676 56H670L382 192Q92 329 90 331Q83 336 83 348Q84 359 96 365Q104 369 382 500T665 634Q669 636 674 636ZM84 -118Q84 -108 99 -98H678Q694 -104 694 -118Q694 -130 679 -138H98Q84 -131 84 -118Z"></path><path id="MJX-1226-TEX-I-1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"></path><path id="MJX-1226-TEX-I-1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D456" xlink:href="#MJX-1226-TEX-I-1D456"></use></g><g data-mml-node="mo" transform="translate(622.8,0)"><use data-c="2264" xlink:href="#MJX-1226-TEX-N-2264"></use></g><g data-mml-node="mi" transform="translate(1678.6,0)"><use data-c="1D457" xlink:href="#MJX-1226-TEX-I-1D457"></use></g><g data-mml-node="mo" transform="translate(2368.3,0)"><use data-c="2264" xlink:href="#MJX-1226-TEX-N-2264"></use></g><g data-mml-node="mi" transform="translate(3424.1,0)"><use data-c="1D45A" xlink:href="#MJX-1226-TEX-I-1D45A"></use></g></g></g></svg></mjx-container></li> <li>如果 <mjx-container jax="SVG" class="MathJax"><svg xmlns="http://www.w3.org/2000/svg" width="4.73ex" height="1.957ex" role="img" focusable="false" viewBox="0 -661 2090.6 865" xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align:-0.462ex;"><defs><path id="MJX-1227-TEX-I-1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"></path><path id="MJX-1227-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-1227-TEX-I-1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D457" xlink:href="#MJX-1227-TEX-I-1D457"></use></g><g data-mml-node="mo" transform="translate(689.8,0)"><use data-c="3D" xlink:href="#MJX-1227-TEX-N-3D"></use></g><g data-mml-node="mi" transform="translate(1745.6,0)"><use data-c="1D456" xlink:href="#MJX-1227-TEX-I-1D456"></use></g></g></g></svg></mjx-container>，那么我们就完成了</li> <li>否则，我们递归地二分割这个块，每个剩下的半块（也叫做伙伴）被放置在相应的空闲链表中
<ul><li>直到分隔产生的半块的大小为 <mjx-container jax="SVG" class="MathJax"><svg xmlns="http://www.w3.org/2000/svg" width="1.871ex" height="1.879ex" role="img" focusable="false" viewBox="0 -830.4 827 830.4" xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align:0;"><defs><path id="MJX-1228-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-1228-TEX-I-1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-1228-TEX-N-32"></use></g><g data-mml-node="mi" transform="translate(533,363) scale(0.707)"><use data-c="1D456" xlink:href="#MJX-1228-TEX-I-1D456"></use></g></g></g></g></svg></mjx-container></li></ul></li> <li>要释放一个大小为 <mjx-container jax="SVG" class="MathJax"><svg xmlns="http://www.w3.org/2000/svg" width="1.871ex" height="1.879ex" role="img" focusable="false" viewBox="0 -830.4 827 830.4" xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align:0;"><defs><path id="MJX-1223-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-1223-TEX-I-1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-1223-TEX-N-32"></use></g><g data-mml-node="mi" transform="translate(533,363) scale(0.707)"><use data-c="1D456" xlink:href="#MJX-1223-TEX-I-1D456"></use></g></g></g></g></svg></mjx-container> 的块，我们继续合并空闲的伙伴
<ul><li>当遇到一个已分配的伙伴时，我们就停止合并</li></ul></li> <li><div class="custom-block tip"><p class="custom-block-title">给定地址和块的大小，可以很容易计算出它的伙伴的地址</p> <ul><li></li></ul></div></li></ul></div> <div class="custom-block warning"><p class="custom-block-title">伙伴系统的优缺点</p> <ul><li>伙伴系统分配器的主要优点是它的快速搜索和快速合并</li> <li>主要缺点是要求块大小为 2 的幂可能导致显著的内部碎片
<ul><li>因此，伙伴系统分配器不适合通用目的的工作负载</li> <li>然而，对于某些特定应用的工作负载，其中块大小预先知道是 2 的幂，伙伴系统分配器就很有吸引力了</li></ul></li></ul></div> <h2 id="910-垃圾收集"><a href="#910-垃圾收集" class="header-anchor">#</a> 9.10 垃圾收集</h2> <h3 id="9101-垃圾收集器的基本知识"><a href="#9101-垃圾收集器的基本知识" class="header-anchor">#</a> 9.10.1 垃圾收集器的基本知识</h3> <h3 id="9102-mark--sweep-垃圾收集器"><a href="#9102-mark--sweep-垃圾收集器" class="header-anchor">#</a> 9.10.2 Mark &amp; Sweep 垃圾收集器</h3> <h3 id="9103-c-程序的保守的-mark--sweep"><a href="#9103-c-程序的保守的-mark--sweep" class="header-anchor">#</a> 9.10.3 C 程序的保守的 Mark &amp; Sweep</h3> <h2 id="911-c-程序中常见的与内存有关的错误"><a href="#911-c-程序中常见的与内存有关的错误" class="header-anchor">#</a> 9.11 C 程序中常见的与内存有关的错误</h2> <h3 id="9111-间接引用坏指针"><a href="#9111-间接引用坏指针" class="header-anchor">#</a> 9.11.1 间接引用坏指针</h3> <h3 id="9112-读未初始化的内存"><a href="#9112-读未初始化的内存" class="header-anchor">#</a> 9.11.2 读未初始化的内存</h3> <h3 id="9113-允许栈缓冲溢出"><a href="#9113-允许栈缓冲溢出" class="header-anchor">#</a> 9.11.3 允许栈缓冲溢出</h3> <h3 id="9114-假设指针和它们指向的对象是相同大小的"><a href="#9114-假设指针和它们指向的对象是相同大小的" class="header-anchor">#</a> 9.11.4 假设指针和它们指向的对象是相同大小的</h3> <h3 id="9115-造成错位错误"><a href="#9115-造成错位错误" class="header-anchor">#</a> 9.11.5 造成错位错误</h3> <h3 id="9116-引用指针，而不是它所指向的对象"><a href="#9116-引用指针，而不是它所指向的对象" class="header-anchor">#</a> 9.11.6 引用指针，而不是它所指向的对象</h3> <h3 id="9117-误解指针运算"><a href="#9117-误解指针运算" class="header-anchor">#</a> 9.11.7 误解指针运算</h3> <h3 id="9118-引用不存在的变量"><a href="#9118-引用不存在的变量" class="header-anchor">#</a> 9.11.8 引用不存在的变量</h3> <h3 id="9119-引用空闲堆块中的数据"><a href="#9119-引用空闲堆块中的数据" class="header-anchor">#</a> 9.11.9 引用空闲堆块中的数据</h3> <h3 id="91110-引起内存泄漏"><a href="#91110-引起内存泄漏" class="header-anchor">#</a> 9.11.10 引起内存泄漏</h3></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/sbwcwso/sbwcwso.github.io/edit/master/docs/01.基础知识/12.CSAPP/01.书本阅读/09. 第 9 章 虚拟内存.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=csapp" title="标签">#csapp</a></div> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/fb3a2a/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">第 8 章 异常控制流</div></a> <a href="/pages/41d266/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">第 10 章 系统级I/O</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/fb3a2a/" class="prev">第 8 章 异常控制流</a></span> <span class="next"><a href="/pages/41d266/">第 10 章 系统级I/O</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/01.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/27.%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/02.MIT6_S081%E7%BF%BB%E8%AF%91%5B%E6%90%AC%E8%BF%90%5D/"><div>MIT6_S081翻译[搬运]</div></a> <span>10-05</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/a5ff04/"><div>SUMMARY</div></a> <span>10-05</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/a0b5b4/"><div>1.1 课程内容简介</div></a> <span>10-05</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="https://github.com/sbwcwso" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2023
    <span>lijunjie9502| <a href="https://github.com/sbwcwso/note/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.095f6a1f.js" defer></script><script src="/assets/js/2.6bb19404.js" defer></script><script src="/assets/js/3.6d4bd9fe.js" defer></script><script src="/assets/js/103.33d325d0.js" defer></script>
  </body>
</html>